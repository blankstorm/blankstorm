<!DOCTYPE html>
<html>
<head>
	<script async>
		IDBRequest.prototype.async = function(){
			return new Promise((resolve, reject) => {
				this.onsuccess = e => resolve(this.result);
				this.onerror = e => reject(this.error);
			});
		}
		const db = {
			promise: new Promise((resolve, reject) => {
				let req = indexedDB.open('blankstorm', 3);
				req.onsuccess = e => resolve(req.result);
				req.onerror = e => reject(req.error);
				req.onupgradeneeded = e => {
					let db = req.result;
					switch(e.oldVersion){
						case 2:
							if(db.objectStoreNames.contains('locales')) db.deleteObjectStore('locales');
							break;
						case 0:
							db.createObjectStore('saves');
							db.createObjectStore('settings');
							db.createObjectStore('servers');
							db.createObjectStore('mods');
					}
				}
			}),
			async tx(stores, mode){
				let db = await this.promise;
				return db.transaction(stores, mode);
			}
		}
		db.promise.catch(e => console.error('Failed to open IndexedDB: ' + e));
		
	</script>
	<link rel=icon href=images/icon.png type=image/png>
	<style>
		:root{
			--hue: 200;
			--_bg-color: var(--hue), 50%, 25%;
			--text-color: hsl(var(--hue), 100%, 90%, .8);
			--text-shadow: 0 0 7px hsl(var(--hue), 100%, 50%);
			--font-family: sans-serif;
			--font-size: 15px;
			--bg-color: hsl(var(--_bg-color));
			--button-color: hsl(var(--hue), 100%, 70%, .5);
			--bg-gradient-dark: hsl(var(--hue), 50%, 0%);
			--bg-gradient-light: hsl(var(--hue), 70%, 70%, .5);
			--bg-color-alt: #252525;
			--bg-shadow: 0 0 6px hsl(var(--hue), 100%, 80%);
			--hover-shadow: 0 0 8px hsl(var(--hue), 100%, 90%);
			--bg-radius: 4px;
			scrollbar-color: var(--text-color);
			scrollbar-width: thin;
			accent-color: var(--text-color);
			color-scheme: light dark;
		}
		#loading_cover svg path{
			transform-origin: center;
			animation: 1s linear infinite rotate;
		}
		@keyframes rotate{
			from{
				transform: rotate(0);
			}
			to{
				transform: rotate(360deg);
			}
		}
		body{
			font-family: var(--font-family);
			background-color: var(--bg-color-alt);
			color: var(--text-color);
			font-size: var(--font-size);
		}
		p,a,span,h1,h2,h3,h4,h5,h6,li{
			color: var(--text-color);
			font-family: var(--font-family);
			font-size: var(--font-size);
		}
		h1,h2,h3,h4,h5,h6,[text-shadow]{
			text-shadow: var(--text-shadow);
		}
		[bg=alt]{
			background-color: var(--bg-color-alt);
		}
		code{
			font-family: monospace;
			background-color: #222;
			border: 1px solid #080808;
			border-radius: 25%;
			font-size: var(--font-size);
		}
		table, tr, td{
			border: 1px solid white;
			text-shadow: #EEE 0px 0px 7px;
			border-collapse: collapse;
		}
		table{
			background: var(--bg-color-alt);
			box-shadow: var(--bg-shadow);
			font-size: var(--font-size);
			display: inline-block;
			border-radius: var(--bg-radius);
			position: relative;
			width: fit-content;
			color: var(--text-color);
			border-collapse: collapse;
			margin: 24px;
		}
		[tabindex]:focus, [nooutline]{
			outline: none;
		}
		td{
			padding: 3px;
			text-shadow: none
		}
		button{
			box-shadow: var(--bg-shadow);
			border-radius: var(--bg-radius);
			color: var(--text-color);
			font-family: var(--font-family);
			font-size: var(--font-size);
			cursor: pointer;
			background: radial-gradient(ellipse at center, var(--bg-gradient-dark) 0, var(--button-color) 150%);
			border: 0;
			padding: 5px 15px;
		}
		button:hover{
			background: radial-gradient(ellipse at center, var(--bg-gradient-dark) 0, var(--button-color) 100%);
			box-shadow: var(--hover-shadow);
		}
		input, textarea{
			display: inline-block;
			background: linear-gradient(to top, var(--bg-gradient-light) 0, var(--bg-gradient-dark) 20%, var(--bg-gradient-dark) 60%, var(--bg-gradient-light) 100%);
			box-shadow: var(--bg-shadow);
			border-radius: var(--bg-radius);
			margin-top: 10px;
			position: relative;
			color: var(--text-color);
		}
		input:hover{
			cursor: text
		}
		input[type=checkbox]:hover{
			cursor: pointer
		}
		:where(div,dialog,ol,ul,nav,form,li[bg]):not([bg=none],[bg=alt]){
			background-color: var(--bg-color);
			border-radius: var(--bg-radius);
			box-shadow: var(--bg-shadow);
			color: var(--text-color);
		}
		body>:where(div,ol,ul,nav,form):not([bg=none],[bg=alt]), [bg=trans]{
			--bg-color-seethru: hsl(var(--_bg-color), 0.33);
			background: 
			linear-gradient(to right, var(--bg-color) 0%, var(--bg-color-seethru) 10%, var(--bg-color-seethru) 50%, var(--bg-color-seethru) 90%, var(--bg-color) 100%),
			linear-gradient(to bottom, var(--bg-color) 0%, var(--bg-color-seethru) 20%, var(--bg-color-seethru) 50%, var(--bg-color-seethru) 80%, var(--bg-color) 100%);
		}
		dialog{
			border: none;
		}
		input[type=range]{
			-webkit-appearance: none;
			overflow: hidden;
			height: 10px;
			background: var(--bg-color);
		}
		::-webkit-slider-runnable-track{
			-webkit-appearance: none;
			appearance: none;
			width: 100%;
			height: 25px;
			border-radius: var(--bg-radius);
			background: var(--bg-color);
			outline: none;
		}
		::-webkit-slider-thumb{
			-webkit-appearance: none;
			appearance: none;
			width: 25px;
			height: 25px;
			border-radius: 25%;
			cursor: pointer;
			background: var(--text-color);
		}
		::-webkit-scrollbar{
			background-color: #0000;
			width: 5px;
		}
		::-webkit-scrollbar-track{
			background-color: #0000;
		}
		::-webkit-scrollbar-thumb{
			background-color: var(--text-color);
			border-radius: 2.5px;
		}
		:where(#settings form, #save) :where(input, select), form.key button{
			position: absolute;
			left: 51%
		}
		:where(#q, #e)>div:not(.nav){
			grid-template-columns: 1fr;
			grid-auto-rows: 3em;
			grid-auto-flow: row;
		}
		form label{
			position: absolute;
			right: 51%;
			width: 50%;
			text-align: right
		}
		#chat li{
			background: none;
			list-style: none
		}
		:where(#e, #q) div:not(.nav){
			position: absolute;
			top: 15%;
			left: 2.5%;
			width: 90%;
			height: 80%
		}
		ul.screenshots img{
			border: 1px solid var(--text-color);
			border-radius: 5px;
			margin: 10px
		}
		#debug p{
			position: fixed
		}
		#debug span{
			background-color: #2225
		}
		#settings ul, #settings form{
			position: absolute;
			left: 25%;
			width: 70%;
			top: 5%;
			height: 90%
		}
		[bg=light]{
			background-color: hsl(var(--hue), 50%, 90%, 0.75);
		}
		.selected{
			border: 1px solid var(--text-color);
		}
		li[bg]{
			list-style: none;
			margin: 1% 10% 1% 5%;
		}
		[bg=none]{
			background: none;
			box-shadow: none;
		}
		[border]{
			border: 1px solid var(--text-color);
			border-radius: var(--bg-radius);
		}
		[center-flex]{
			display: flex;
			justify-content: center;
		}
		[hide]{
			display: none
		}
		[lsn]{
			list-style: none !important
		}
		[nbs]{
			box-shadow: none !important
		}
		[nts]{
			text-shadow: none !important
		}
		[ofs=]{
			overflow: scroll !important
		}
		[ofs=x]{
			overflow-x: scroll !important
		}
		[ofs=y]{
			overflow-y: scroll !important
		}
		[ofn]{
			overflow: hidden !important
		}
		[ofn=x]{
			overflow-x: hidden !important
		}
		[ofn=y]{
			overflow-y: hidden !important
		}
		[bw]{
			word-wrap: break-word !important
		}
		[cover]{
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
		}
		[content]{
			position: absolute;
			inset: 10% 10% 10% 10%;
		}
		[clickable]:hover{
			cursor: pointer
		}
		svg{
			width: 1em;
			height: 1em;
			fill: var(--text-color);
			transform-origin: center;
		}
		[bg=star]{
			background-image: url('images/menu.png');
		}
		progress{
			background-color: var(--button-color);
			border-radius: var(--bg-radius);
		}
		progress::-webkit-progress-bar{
			background-color: #0000;
			border-radius: var(--bg-radius);
		}
		progress::-moz-progress-bar{
			background-color: var(--text-color);
			border-radius: var(--bg-radius);
		}
		progress::-webkit-progress-value{
			background-color: var(--text-color);
			border-radius: var(--bg-radius);
		}
	</style>
</head>
<body oncontextmenu='e=>false' bg=star>
	<div id=loading_cover cover bg=alt style=z-index:100;display:flex;justify-content:center;>
		<svg xmlns="http://www.w3.org/2000/svg" style='position:absolute;top:calc(50% - 100px);width:150px;height:150px' viewBox='0 0 100 100'>
			<defs>
				<linearGradient id=gradient>
					<stop offset=0% stop-color=hsl(200,100%,90%,.2) />
					<stop offset=100% stop-color=hsl(200,100%,90%,1) />
				</linearGradient>
			</defs>
			<path fill=var(--text-color) d="m60,50c0,5.5 -4.5,10 -10,10c-5.5,0 -10,-4.5 -10,-10c0,-5.5 4.5,-10 10,-10c5.5,0 10,4.5 10,10z" />
			<path fill=url(#gradient) d="m73,50c0,-12.7 -10.3,-23 -23,-23s-23,10.3 -23,23m0.47001,0c0,-10.5 11.50746,-20.6493 22.10746,-20.6493s19.52254,10.1493 19.52254,20.6493" />
		</svg>
		<p style=position:absolute;font-size:25px;top:50%; text-shadow>Loading</p>
	</div>
	<input ingame id=cli style=position:fixed;left:15px;bottom:15px;width:30%;height:30px;padding:0;margin:0;z-index:10 hide ofs=x>
	<ul lsn id=chat style=position:fixed;left:15px;bottom:50px;width:30%;height:fit-content;max-height:35%;background:#2225;padding:0;margin:0;z-index:9 nbs ofn bw></ul>
	<ul lsn ingame id=chat_history hide style=position:fixed;left:15px;bottom:50px;width:30%;height:fit-content;max-height:35%;background:#2225;padding:0;margin:0;z-index:9 nbs ofs=y bw></ul>
	<div id=main cover bg=none center-flex>
		<img src=images/title.png plot=c,90px,475px,75px />
		<button class=sp plot=c,260px,350px,50px></button>
		<button class=mp plot=c,360px,350px,50px></button>
		<button class=options plot=c,460px,350px,50px></button>
		<a class=exit href="/"><button class=exit plot=c,560px,350px,50px></button></a>
		<p class=version plot=r2em,b1em,fit-content,1em style=text-align:right><a target="_blank">Version</a></p>
		<p class=copyright plot=2em,b1em,fit-content,1em>&copy; 2022 Dr. Vortex. All Rights Reserved.</p>
	</div>
	<ul id=load hide lsn content ofs=y style=padding:2.5%>
		<button class=back plot=25px,b25px,125px,36px,a>
			<svg><use href=images/icons.svg#arrow-left /></svg> 
			<span></span>
		</button>
		<button class=new plot=r25px,b25px,125px,36px,a>
			<svg><use href=images/icons.svg#plus /></svg> 
			<span></span>
		</button>
		<button class='refresh upload' plot=r175px,b25px,125px,36px,a>
			<svg><use href=images/icons.svg#upload /></svg> 
			<span></span>
		</button>
	</ul>
	<dialog id=save ofs=y plot=0,0,400px,300px>
		<input placeholder="save name" class=name plot=c,50px,250px,2em,a>
		<button class=back plot=c-75px,b62.5px,150px,36.6px,a>
			<svg><use href=images/icons.svg#arrow-left /></svg> 
			<span></span>
		</button>
		<button class=new plot=c+75px,b62.5px,150px,36.6px,a>
			<svg><use href=images/icons.svg#plus /></svg> 
			<span></span>
		</button>
		<form name=worldgen bg=none plot='c,calc(2em + 75px),80%,100px,a'>
			<input type=range name=difficulty label=Difficulty display='${{"0.5":"Easy","1":"Normal","1.5":"Hard","2":"<dfn style=\"font-style: normal;border-bottom:1px dotted var(--text-color)\" title=\"Disclaimer: Not yet limited to one life.\">Hardcore</dfn>"}[val]}' min=0.5 max=2 step=0.5 value=1><br><br>
		</form>
	</dialog>
	<div id=connect hide content>
		<p plot=c,c-2em,75%,1em style=text-align:center></p>
		<button plot=c,c+2em,100px,2em class=back>
			<span></span>
		</button>
	</div>
	<p ingame hide id=mp_message plot=c,c-2em,300px,1em>
		Multiplayer is not fully implemented yet.<br>
		Feel free to test chat or commands (T).<br>
		Use the pause menu (Esc) to disconnect.<br>
		Thanks!<br><br>
		&emsp;&emsp;- Dr. Vortex
	</p>
	<div ingame id=tablist hide plot=c,0,200px,fit-content style=word-wrap:break-word;text-align:center;>
		<p class=info></p>
		<p class=players></p>
	</div>
	<dialog id=modal plot=0,0,350px,8em>
		<p class=info plot=c,c-2em,300px,1em,a style=text-align:center></p>
		<form method=dialog></form>
	</dialog>
	<div ingame id=e content hide game-ui style=z-index:5 tabindex=-1>
		<div class=nav bg=none plot=5%,25px,90%,45px,a>
			<button class=trade plot=c-225px,5px,200px,35px,a>
				<svg><use href=images/icons.svg#money-check-dollar /></svg> 
				<span></span>
			</button>
			<button class=yrd plot=c,5px,200px,35px,a>
				<svg><use href=images/icons.svg#wrench /></svg> 
				<span></span>
			</button>
			<button class=lab plot=c+225px,5px,200px,35px,a>
				<svg><use href=images/icons.svg#flask /></svg> 
				<span></span>
			</button>
		</div>
		<div class=trade ofs=y bg=none style='margin-top:10px;display:grid;grid-auto-rows:3em;grid-template-columns:1fr 1fr 4fr;column-gap: 10px'></div>
		<div class=yrd ofs=y bg=none style='margin-top:10px;display:grid;grid-auto-rows:3em;grid-template-columns:1fr 2fr 1fr;column-gap: 10px'></div>
		<div class=lab ofs=y bg=none style='margin-top:10px;display:grid;grid-auto-rows:3em;grid-template-columns:1fr 2fr 1fr;column-gap: 10px'></div>
	</div>
	<div ingame id=q content hide game-ui style=z-index:5 tabindex=-1>
		<div class=nav bg=none plot=5%,25px,90%,45px,a>
			<button class=inv plot=c-300px,5px,175px,35px,a>
				<svg><use href=images/icons.svg#box /></svg> 
				<span></span>
			</button>
			<button class=map plot=c-100px,5px,175px,35px,a>
				<svg><use href=images/icons.svg#location-dot /></svg> 
				<span></span>
			</button>
			<button class=screenshots plot=c+100px,5px,175px,35px,a>
				<svg><use href=images/icons.svg#image /></svg> 
				<span></span>
			</button>
			<button class=warp plot=c+300px,5px,175px,35px,a>
				<svg><use href=images/icons.svg#rocket-launch /></svg> 
				<span></span>
			</button>
		</div>
		<div class=inv ofs=y bg=none style='margin-top:10px;display:grid;grid-auto-rows:3em;grid-template-columns:1fr 1fr;column-gap: 10px'></div>
		<div class=item-bar plot='c,calc(3em + 45px),75%,1.5em,a' style=text-align:center;line-height:0;>
			<p class=label plot=c,0,200px,1em,a></p>
			<svg class=item-bar style=width:100%;height:100% preserveAspectRatio=none viewBox='0 0 100 1'>
				<rect fill=var(--button-color) x=0 y=0 width=0 height=100%></rect>
			</svg>
		</div>
		<div class=map ofs=y bg=none style='margin-top:10px;display:grid;grid-auto-rows:3em;grid-template-columns:repeat(4, 1fr) 6fr;column-gap: 10px'>
			<button class='map new' plot=r25px,b25px,125px,36px,a>
				<svg><use href=images/icons.svg#plus /></svg> 
				<span></span>
			</button>
		</div>
		<div class=screenshots bg=none ofs=y style='display:grid;grid-auto-rows:144px;grid-template-columns:repeat(auto-fill,256px);gap:1em;'></div>
		<div class=warp ofs=y bg=none style="text-align:center">
			<input label="Warp To: " class="warp x" maxlength=4 style=width:50px>
			<input class="warp y" maxlength=4 style=width:50px>
			<select></select>
			<button style=margin:1% class=warp></button>
		</div>
	</div>
	<div id=markers style=z-index:2></div>
	<canvas ingame class=game hide cover style=z-index:0></canvas>
	<div ingame id=debug bg=none hide cover style=width:fit-content>
		<p style=left:1%;top:0 class=left></p>
		<p style=right:1%;top:0;text-align:right class=right></p>
	</div>
	<div ingame id=hud hide bg=none>
		<p class=level plot=c,b1em,150px,1em style=text-align:center;line-height:3em></p>
		<div class=xp plot=c,b1em,300px,1em bg=none>
			<svg class=xp style=width:100%;height:100% preserveAspectRatio=none viewBox='0 0 100 1' border>
				<rect fill=var(--button-color) x=0 y=0 width=0 height=100%></rect>
			</svg>
		</div>
	</div>
	<div ingame  id=esc hide cover bg=none tabindex=-1>
		<div class=content plot=c,c,250px,300px style=z-index:10>
			<button plot=12.5px,62.5px,225px,50px,a class=resume></button>
			<button plot=12.5px,125px,225px,50px,a class=save></button>
			<button plot=12.5px,187.5px,225px,50px,a class=options></button>
			<button plot=12.5px,250px,225px,50px,a class=quit></button>
		</div>
	</div>
	<div id=settings hide content>
		<button plot=50px,50px,135px,35px,a class=gen>
			<svg><use href=images/icons.svg#gear /></svg> 
			<span></span>
		</button>
		<button plot=50px,100px,135px,35px,a class=key>
			<svg><use href=images/icons.svg#keyboard /></svg> 
			<span></span>
		</button>
		<button plot=50px,150px,135px,35px,a class=mod hide>
			<svg><use href=images/icons.svg#puzzle-piece /></svg> 
			<span>Mods</span>
		</button>
		<button plot=50px,150px,135px,35px,a class=debug>
			<svg><use href=images/icons.svg#bug /></svg>
			<span></span>
		</button>
		<button plot='50px,calc(100% - 85px),135px,35px,a' class=back>
			<svg><use href=images/icons.svg#arrow-left /></svg> 
			<span></span>
		</button>
		<form class=gen name=settings nbs bg=none ofs=y>
			<input type=range name=font_size label="Font Size" display=${val}px min=10 max=20 step=1 value=13><br><br>
			<input type=range name=chat label="Chat Timeout" display='${val} seconds' min=5 max=15 step=1 value=10><br><br>
			<input type=range name=sensitivity label="Camera Sensitivity" display=${(val*100).toFixed()}% min=0.1 max=2 step=0.05 value=1><br><br>
			<input type=range name=music label="Music Volume" display=${(val*100).toFixed()}% min=0 max=1 step=0.05 value=1><br><br>
			<input type=range name=sfx label="Sound Effect Volume" display="${(val*100).toFixed()}%" min=0 max=1 step=0.05 value=1><br><br>
			<input type=range name=render_quality label='Render Quality' display="${['Low','Medium','High'][val]}" min=0 max=2 step=1 value=1><br><br>	
			<input type=range name=gui_scale label="GUI Scale" display="${['auto','small','normal','large'][val]}" min=0 max=3 step=1 value=0><br><br>
			<select name=locale label=Language></select><br><br>
		</form>
		<form class=key name=keybind nbs bg=none ofs=y hide></form>
		<form class=debug name=debug nbs bg=none ofs=y hide>
			<input type=checkbox name=show_path_gizmos label="Show Path Gizmos" value=true><br><br>
			<input type=checkbox name=tooltips label="Show Advanced Tooltips" value=true><br><br>
			<input type=checkbox name=disable_saves label="Disable Saves" value=true><br><br>
		</form>
		<ul class=mod nbs bg=none ofs=y hide lsn></ul>
	</div>
</body>

<script version=5.25.0 class=babylon src=libraries/babylon.core.js></script>
<script version=5.25.0 class=loaders src=libraries/babylon.loaders.js></script>
<script version=4.5.0 class=socketio src=libraries/socket.io.js></script>
<script version=3.6.0 class=jquery src=libraries/jquery.js></script>
<script class=core src=core.js></script>
<script class=game async defer>
	const web = url => `https://blankstorm.drvortex.dev/` + url,
	upload = (type, multiple = false) => new Promise(res => $(`<input type=file ${type ? `accept='${type}'` : ''} ${multiple?'multiple':''}>`).change(e => res([...e.target.files]))[0].click()),
	download = (data, name) => $(`<a href=${URL.createObjectURL(new Blob([data]))} download="${name ?? 'download'}"></a>`)[0].click();
	const modal = (input = 'Are you sure?', options = {Cancel: false, Ok: true}) => new Promise(res => {
		$('#modal input').remove();
		if(input instanceof Array){
			$('#modal').attr('plot', `0,0,350px,${6 + 2*input.length}em`);
			$('#modal p.info').attr('plot',`c,c-${2*input.length}em,300px,1em,a`);
			input.forEach(data => {
				$('<input><br>').attr(data).appendTo('#modal');
			});
		}else{
			$('#modal').attr('plot', '0,0,350px,8em');
			$('#modal p.info').attr('plot', 'c,c-2em,300px,1em,a').text(input);
		}
		
		$('#modal')[0].showModal();
		Object.entries(options).forEach(([displayText, result], i, a) => {
			$(`<button></button>`)
				.attr('plot', a.length == 2 ? `c${i ? `+` : `-`}50px,b2em,100px,2em,a` : `c,b2em,100px,2em,a`)
				.attr('value', result)
				.text(displayText)
				.appendTo('#modal form');
		});
		$('#modal').on('close', e => {
			res(input instanceof Array ? {...Object.fromEntries([...$('#modal input')].map(el => [el.name, el.value])), result: $('#modal')[0].returnValue} : $('#modal')[0].returnValue);
			$('#modal button').remove();
		});
		ui.update();
	}),
	_alert = window.alert,
	_confirm = window.confirm,
	_prompt = window.prompt,
	alert = data => modal(data, {Ok: true}),
	confirm = async data => {
		let res = await modal(data);
		if(JSON.parse(res)){
			return true;
		}else{
			throw false;
		}
	},
	prompt = async (text, value) => {
		let data = await modal([{name: 'data', placeholder: text, value}]);
		if(JSON.parse(data.result)){
			return data.data;
		}else{
			throw false;
		}
	};

	Object.defineProperties(Object.prototype, {
		hide: {
			value: function (...p) {
				for (let i of p) {
					Object.defineProperty(this, i, { enumerable: false })
				}
			}
		},
		freezeProperty: {
			value: function (...p) {
				for (let i of p) {
					Object.defineProperty(this, i, { writable: false })
				}
			}
		},
		getByString: {
			value: function (path, seperator) {
				return path
				.split(seperator || /[\.\[\]\'\"]/)
				.filter(p => p)
				.reduce((o, p) => o ? o[p] : null, this)
			}
		},
		setByString: {
			value: function(path, value, seperator){
				return path
				.split(seperator || /[\.\[\]\'\"]/)
				.filter(p => p)
				.reduce((o, p, i) => o[p] = path.split(seperator || /[\.\[\]\'\"]/).filter(p => p).length === ++i ? value : (o[p] || {}), this);
			}
		},
		copyFrom: {
			value: function(source, props){
				Object.assign(this, props ? Object.fromEntries(Object.entries(source).filter(([k ,v]) => props.includes(k))) : source);
				return this;
			}
		}
	});

	Math._log = Math.log;
	Math.log = (num, base = Math.E) => Math._log(num)/Math._log(base);
	Object.assign(window, BABYLON);

	//JQuery plugins
	$.ajaxSetup({timeout:3000});
	$.fn.formData = function(data){
		if (data) {
			for (let i in data) {
				this.find(`[name=${i}]`).each((a, e) => { e.type == "checkbox" ? e.checked = data[i] : e.value = data[i] })
			}
			return this
		} else {
			let formData = Object.fromEntries(new FormData(this[0]));
			for(let i in formData){
				if(+formData[i] == formData[i]){
					formData[i] = +formData[i];
				}
				if(formData[i] === 'true'){
					formData[i] = true;
				}
				if(formData[i] === 'false'){
					formData[i] = false;
				}
			}
			return formData;
		}
	};
	$.fn.tooltip = function (info = "") {
		this.off('mouseenter mouseleave');
		let id = random.hex(32), tooltip = $(`<div class=tooltip></div>`)
			.css({ position: "fixed", width: "fit-content", height: "fit-content", "max-width": "15%", "z-index": 9})
			.attr('tooltip-for', id);
		this
			.attr('tooltip-id', id)
			.mouseenter(e => {
				$(`[tooltip-for=${id}]`).remove();
				tooltip
				.html(typeof info == 'function' ? info(tooltip) : info)
				.css({ left: `calc(var(--font-size) + ${mouse.x}px)`, top: `calc(var(--font-size) + ${mouse.y}px)` });
				this.attr('tooltip-active', true).parent().append(tooltip);
				let computedStyle = getComputedStyle(tooltip[0]);
				tooltip.css({
					left: (settings.font_size + mouse.x + parseFloat(computedStyle.width) < innerWidth) ? settings.font_size + mouse.x : settings.font_size + mouse.x - parseFloat(computedStyle.width),
					top: (settings.font_size + mouse.y + parseFloat(computedStyle.height) < innerHeight) ? settings.font_size + mouse.y : settings.font_size + mouse.y - parseFloat(computedStyle.height)
				})
			})
			.mouseleave(e => { tooltip.remove(); this.removeAttr('tooltip-active') });
		return this
	};
	$.fn.cm = function(...content){
		content ||= [$("<p></p>")];
		let menu = $("<div bg=light class=cm></div>");
		for (let c of content) { menu.append(c, $('<br>')) }
		menu.css({ position: 'fixed', width: 'fit-content', height: 'fit-content', 'max-width': '15%', padding: '1em', 'z-index': 9});
		this.contextmenu(e => {
			e.preventDefault();
			menu.css({ left: settings.font_size + mouse.x, top: settings.font_size + mouse.y });
			this.parent().append(menu);
			menu.css({ top: (settings.font_size + mouse.y + parseFloat(getComputedStyle(menu[0]).height) < innerHeight) ? settings.font_size + mouse.y : settings.font_size + mouse.y - parseFloat(getComputedStyle(menu[0]).height) })
		});
		return this
	}
	$.fn.aspect = function(){
		let css = getComputedStyle(this[0]);
		return `(x: ${css.left}, y: ${css.top})\n${css.width} x ${css.height} = ${parseFloat(css.width) / parseFloat(css.height)}`
	}

	let time = 0;
	const cookie = {},
	query = new URLSearchParams(location.search),
	key = { pressed: false },
	width = innerWidth,
	height = innerHeight,
	mouse = { x: 0, y: 0, pressed: false },
	playsound = (url, vol = 1) => { if(vol > 0){ let a = new Audio(url); a.volume = +vol; a.play() }},
	date = new Date();
	onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY };
	document.cookie.split("; ").forEach(e => { cookie[e.split("=")[0]] = e.split("=")[1] });
	setInterval(() => { time += 10 }, 10);
	
	let settings = $('#settings form.gen').formData(),
	debug = $('#settings form.debug').formData(),
	worldgen = $("#save form").formData(),
	keybind = {};
	const servers = new Map(),
	saves = new Map(),
	sound = {
		rift: 'music/rift.mp3',
		planets: 'music/planets.mp3',
		destroy_ship: 'sfx/destroy_ship.mp3',
		warp_start: 'sfx/warp_start.mp3',
		//warp_end: 'sfx/warp_end.mp3',
		laser_fire: 'sfx/laser_fire.mp3',
		laser_hit: 'sfx/laser_hit.mp3',
		ui: 'sfx/ui.mp3'
	};

	//add HTML for settings to work (the title and defaults for checkboxes)
	$('#settings form').prepend('<h2 style=text-align:center>Settings - <span></span></h2>')
	$('#settings form checkbox').each((i, e) => {
		$(`<input type=hidden ${e.name} value=${!e.value}>`).insertBefore(e);
	});
	const locales = new Map();
	Object.assign(locales, {
		async fetch(url){
			let locale = isJSON(url) ? JSON.parse(url) : await $.ajax(url),
			err = msg => {throw new Error(`Failed to load locale from ${url}: ${msg}`)};
			locale.language ||= locale.lang;
			if(typeof locale != 'object') err('Not an object');
			if(!locale.language) err('Does not have a language');
			if(!(locale.version || locale.versions)) err('Does not have a version');
			if(!locale?.text) err('Missing data');
			if(locale.version != version && ![...locale.versions].some(v => version.match(v))) err('Wrong game version');
			
			this.set(locale.language, locale)
			$('<option></option>')
			.attr('value', locale.language)
			.text(locale.name)
			.appendTo('#settings form.gen select[name=locale]');
			return locale;
		},
		load(id){
			if(!this.has(id)) throw new Error(`Locale ${id} does not exist`);
			let lang = this.get(id);
			this.currentLang = id;
			$('#main button.sp').text(lang['menu.singleplayer'] ?? 'Singleplayer');
			$('#main button.mp').text(lang['menu.multiplayer'] ?? 'Multiplayer');
			$('#main button.options,#esc button.options').text(lang['menu.options'] ?? 'Options');
			$('#main button.exit').text(lang['menu.exit'] ?? 'Exit');
			$('#esc button.resume').text(lang['menu.resume'] ?? 'Resume Game');
			$('#esc button.save').text(lang['menu.save'] ?? 'Save Game');
			$('#esc button.quit').text(lang['menu.quit'] ?? 'Main Menu');
			$('#load button.upload span').text(lang['menu.upload'] ?? 'Upload');
			$(':where(#load,#save,#settings) button.back span').text(lang['menu.back'] ?? 'Back');
			$(':where(#load,#q) button.new span').text(lang['menu.new'] ?? 'New');
			$('#save button.new span').text(lang['menu.start'] ?? 'Start');
			$('#connect button.back span').text(lang['menu.cancel'] ?? 'Cancel');
			$('#settings :where(button.gen,form.gen h2) span').text(lang['menu.general'] ?? 'General');
			$('#settings :where(button.key,form.key h2) span').text(lang['menu.keybinds'] ?? 'Keybinds');
			$('#settings :where(button.debug,form.debug h2) span').text(lang['menu.debug'] ?? 'Debug');
			$('#q div.warp button.warp').text(lang['menu.warp'] ?? 'Warp');
			$('#q div.nav button.inv span').text(lang['menu.items'] ?? 'Inventory');
			$('#q div.nav button.map span').text(lang['menu.map'] ?? 'Waypoints');
			$('#q div.nav button.screenshots span').text(lang['menu.screenshots'] ?? 'Screenshots');
			$('#q div.nav button.warp span').text(lang['menu.hyperspace'] ?? 'Hyperspace');
			$('#e div.nav button.trade span').text(lang['menu.trade'] ?? 'Trade');
			$('#e div.nav button.yrd span').text(lang['menu.shipyard'] ?? 'Shipyard');
			$('#e div.nav button.lab span').text(lang['menu.lab'] ?? 'Laboratory');
		},
		text(key){
			return this.get(this.has(settings.locale) ? settings.locale : 'en')?.text?.[key] || 'Unknown';
		},
		currentLang: ''
	});
	//load locales
	
	locales.fetch('locales/en.json').then(locale => locales.load('en'));

	const Waypoint = class extends Node{
		#readonly = false;
		static dialog(wp){
			modal([
				{name: 'name', placeholder: 'Name', value: wp instanceof Waypoint ? wp.name : null},
				{name: 'color', type: 'color', value: wp instanceof Waypoint ? wp.color.toHexString() : null},
				{name: 'x', placeholder: 'X', value: wp instanceof Waypoint ? wp.position.x : null},
				{name: 'y', placeholder: 'Y', value: wp instanceof Waypoint ? wp.position.y : null},
				{name: 'z', placeholder: 'Z', value: wp instanceof Waypoint ? wp.position.z : null},
			], {Cancel: false, Save: true}).then(data => {
				if(data.result){
					if(!isHex(data.color.slice(1))){
						alert(locales.text`error.waypoint.color`);
					}else if(Math.abs(data.x) > 99999 || Math.abs(data.y) > 99999 || Math.abs(data.z) > 99999){
						alert(locales.text`error.waypoint.range`);
					}else if(wp instanceof Waypoint){
						Object.assign(wp, {
							name: data.name,
							color: Color3.FromHexString(data.color),
							position: new Vector3(data.x, data.y, data.z)
						});
						ui.update();
					}else{
						new Waypoint({
							name: data.name,
							color: Color3.FromHexString(data.color),
							position: new Vector3(data.x, data.y, data.z)
						}, game.scene());
						ui.update();
					}
				}
			});
			
		}
		get readonly(){
			return this.#readonly;
		}
		gui(row){
			let ui = $(`
				<span style=text-align:center;grid-row:${row};grid-column:2;><svg><use href=images/icons.svg#pencil /></svg></span>
				<span style=text-align:center;grid-row:${row};grid-column:3;><svg><use href=images/icons.svg#trash /></svg></span>
				<span style=text-align:center;grid-row:${row};grid-column:4;><svg><use href=images/icons.svg#${this.icon} /></svg></span>
				<span style=text-align:left;grid-row:${row};grid-column:5;color:${this.color.toHexString()}>${this.name}</span>
			`).attr('bg','none');
			ui.filter('span').eq(0).attr('clickable', '').click(e => {
				Waypoint.dialog(this);
			}),
			ui.filter('span').eq(1).attr('clickable', '').click(e => {
				confirm().then(() => {
					this.marker.remove();
					this.getScene().waypoints.spliceOut(this);
				});
			});
			return this.readonly ? ui.filter('span:gt(1)') : ui;
		}
		get screenPos(){
			return Vector3.Project(this.position, Matrix.Identity(), game.scene().getTransformMatrix(), {x: 0, y: 0, width: innerWidth, height: innerHeight});
		}
		constructor({
			id = random.hex(32),
			name = 'Waypoint',
			position = Vector3.Zero(),
			color = new Color3(Math.random(), Math.random(), Math.random()),
			icon = 'location-dot',
			readonly = false
		}, scene = game.scene()){
			super(id, scene);
			scene.waypoints.push(this);
			this.#readonly = readonly;
			Object.assign(this, {name, position, color, icon});
			this.marker = $(`<svg ingame><use href=images/icons.svg#${icon} /></svg><p ingame style=justify-self:center></p>`).addClass('marker').hide().appendTo('body');
			this.marker.filter('p').css('text-shadow', '1px 1px 1px #000')
		}
	}

	//Some stuff done on initalization
	document.title = "Blankstorm " + versions.get(version).text;
	$("#main .version a").text(versions.get(version).text).attr('href', web('versions#' + version));
	console.log(`%cBlankstorm ${versions.get(version).text}`, `color:#f55`);

	//Class definitions
	const Save = class {
		
		static current = {location:Vector2.Zero()}
		static GUI = function(save){
			const gui = $(`<li ofn bg bw style=align-items:center;height:3em;></li>`);
			gui.delete = $(`<p style=position:absolute;left:10%><svg><use href=images/icons.svg#trash /></svg></p>`).appendTo(gui);
			gui.download = $(`<p style=position:absolute;left:15%><svg><use href=images/icons.svg#download /></svg></p>`).appendTo(gui);
			gui.play = $(`<p style=position:absolute;left:20%><svg><use href=images/icons.svg#play /></svg></p>`).appendTo(gui);
			gui.edit = $(`<p style=position:absolute;left:25%><svg><use href=images/icons.svg#pencil /></svg></p>`).appendTo(gui);
			gui.name = $(`<p style=position:absolute;left:30%>${save.data.name}</p>`).appendTo(gui);
			gui.version = $(`<p style=position:absolute;left:55%>${versions.get(save.data.version) ? versions.get(save.data.version).text : save.data.version}</p>`).appendTo(gui);
			gui.date = $(`<p style=position:absolute;left:65%>${new Date(save.data.date).toLocaleString()}</p>`).appendTo(gui);
			$('<p> </p>').appendTo(gui);
				
			let loadAndPlay = async () => {
				$('#loading_cover').show();
				let live = save.load();
				await live.ready();
				saves.current = live;
				live.play();
				$('#loading_cover').hide();
			}

			gui
			.attr('clickable', '')
			.click(e => { $('.selected').removeClass('selected'); saves.selected = save.data.id; gui.addClass('selected') })
			.dblclick(loadAndPlay);
			if(!game.mp) gui.prependTo('#load');
			gui.delete.click(e => {
				let remove = () => {
					gui.remove();
					db.tx('saves', 'readwrite').then(tx => {
						tx.objectStore('saves').delete(save.data.id);
						saves.delete(save.data.id);
					});
				}
				e.shiftKey ? remove() : confirm().then(remove);
			});
			gui.download.click(e => download(JSON.stringify(save.data), (save.data.name || 'save') + '.json'));
			gui.play.click(loadAndPlay);
			gui.edit.click(e => {
				modal([{name: 'name', placeholder: 'New name', value: save.data.name}], {Cancel: false, Save: true}).then(result => {
				if(result.result){
						save.data.name = result.name;
						ui.update();
					}
				});
			});
			return gui;
		};
		static Live = class extends Level{
			waypoints = [];
			constructor(name, doNotGenerate){
				super(name, game.engine, doNotGenerate);
			}
			play(){
				if(this.version == version){
					$('#load').hide();
					game.canvas.show().focus();
					$('#hud').show();
					game.engine.resize();
					saves.selected = this.id;
					game.isPaused = false;
					this.activeCamera = player.cam
					player.cam.attachControl(game.canvas, true);
					player.cam.inputs.attached.pointers.buttons = [1];
					player.cam.target = player.data().position;
				}else{
					alert('That save is in compatible with the current game version');
				}
			}
			static Load(saveData){
				let save = new Save.Live(saveData.name, true);
				Level.Load(saveData, game.engine, save);
				return save;
			}
		}
		constructor(data){
			try {
				this.data = data;
				this.gui = new Save.GUI(this);
				saves.set(this.data.id, this);
				
			} catch (err) { console.error(err.stack) }
		}
		load(){
			let save = Save.Live.Load(this.data);
			for(let waypoint of save.waypoints){
				new Waypoint({
					id: waypoint.id,
					name: waypoint.name,
					color: Color3.FromArray(waypoint.color),
					position: Vector3.FromArray(waypoint.position)
				});
			}
			return save;
		}
		async saveToDB(){
			let tx = await db.tx('saves','readwrite');
			tx.objectStore('saves').put(this.data, this.data.id);
			return tx.result;
		}
	}
	const Server = class {
		static async dialog(server){
			const result = await modal([
				{name: 'name', placeholder: 'Display name', value: server instanceof Server ? server.name : null},
				{name: 'url', placeholder: 'Server URL or IP Address', value: server instanceof Server ? server.url : null}
			], {Cancel: false, Save: true})
			if(result.result){
				let tx = await db.tx('servers','readwrite')
				let serverStore = tx.objectStore('servers');
				if(server instanceof Server){
					serverStore.put(result.name, result.url);
					server.name = result.name;
					if(server.url != result.url){
						serverStore.delete(server.url);
						server.url = result.url;
					}
				}else{
					if(servers.has(result.url)){
						alert('A server with that URL already exists.');
					}else{
						new Server(result.url, result.name);
						
					}
				}
				ui.update();
			}
			
		}
		constructor(url, name){
			Object.assign(this, {
				url,
				name,
				kickMessage: null,
				socket: null, 
				gui: $(`<li ofn bg style=align-items:center;height:3em></li>`)
			});
			db.tx('servers','readwrite').then(tx => tx.objectStore('servers').put(name, url));
			this.socket = io(this.url, {reconnection: false, autoConnect: false, auth: {token: cookie.token, session: cookie.session}});
			this.socket.on('connect', socket => {
				$('#connect').hide();
				game.canvas.show().focus();
				$('#mp_message,#hud').show();
				game.engine.resize();
				player.cam.attachControl(game.canvas, true);
				player.cam.inputs.attached.pointers.buttons = [1];
				$('#tablist p.info').html(`${this.url}<br>${this.pingData.version.text}<br>${this.pingData.message}<br>`);
			});
			this.socket.on('connect_error', err => {
				$('#connect p').text((err.message.startsWith('Connection refused') ? '' : 'Connection Error: ') + err.message);
				$('#connect button').text('Back');
			});
			this.socket.on('connect_failed', err => {
				$('#connect p').text('Connection failed: ' + err.message);
				$('#connect button').text('Back');
			});
			this.socket.on('packet', packet => {
				$('#connect p').text('[Server] ' + (packet instanceof Array ? `Array (${packet.length})<br>` + packet.join('<br>') : packet));
			});
			this.socket.on('playerlist', list => {
				$('#tablist p.players').html(list.join('<br>'));
			});
			this.socket.on('kick', message => {
				this.kickMessage = 'Kicked from server: ' + message;
			});
			this.socket.on('chat', message => {
				game.chat(message);
			});
			this.socket.on('disconnect', reason => {
			    let message = 
				this.kickMessage ??
			    (reason == 'io server disconnect' ? 'Disconnected by server' :
			    reason == 'io client disconnect' ? 'Client disconnected' :
			    reason == 'ping timeout' || reason == 'transport error' ? 'Connection timed out' :
			    reason == 'transport close' ? 'Lost Connection' :
			    reason);
				$('#connect p').text(message);
				this.kickMessage = null;
				$('#connect button').text('Back');
				$('[ingame]').hide();
				$(reason == 'io client disconnect' ? '#load' : '#connect').show();
			});
			this.gui.delete = $(`<p style=position:absolute;left:15%><svg><use href=images/icons.svg#trash /></svg></p>`).appendTo(this.gui);
			this.gui.play = $(`<p style=position:absolute;left:20%><svg><use href=images/icons.svg#play /></svg></p>`).appendTo(this.gui);
			this.gui.edit = $(`<p style=position:absolute;left:25%><svg><use href=images/icons.svg#pencil /></svg></p>`).appendTo(this.gui);
			this.gui.name = $(`<p style=position:absolute;left:30%>${this.name}</p>`).appendTo(this.gui);
			this.gui.info = $(`<p style=position:absolute;left:75%></p>`).appendTo(this.gui);
			$('<p> </p>').appendTo(this.gui);
			this.gui
				.attr('clickable', true)
				.click(e => {
					$('.selected').removeClass('selected');
					this.gui.addClass('selected');
					servers.sel = this.url;
				})
				.dblclick(e => this.connect())
				.prependTo('#load');
			this.gui.delete.click(e => {
				confirm().then(() => {
					this.gui.remove();
					servers.delete(this.url);
					db.transaction('servers', 'readwrite').objectStore('servers').delete(this.url);
				});
			});
			this.gui.play.click(e => this.connect());
			this.gui.edit.click(e => Server.dialog(this));
			servers.set(this.url, this);
		}
		connect(){
			if(this?.socket?.connected){
				throw new ReferenceError(`Can't connect to server: already connected`);
			}
			$('#load').hide();
			$('#connect').show();
			$('#connect p').text('Connecting...');
			$('#connect button').text('Back');
			this.socket.connect();
		}
		disconnect(showMessage){
			if(this.socket.connected){
				this.socket.disconnect(true);
			}
			servers.sel = null;
			servers.forEach(server => server.ping());
		}
		ping(){
			this.gui.info
			.html('<svg><use href=images/icons.svg#arrows-rotate /></svg>')
			.css('animation', '2s linear infinite rotate');
			let beforeTime = Date.now();
			let url = /.+:(\d){1,5}/.test(this.url) ? this.url : this.url + ':1123';
			$.get(`${(/http(s?):\/\//.test(url) ? url : 'https://' + url)}/ping`)
			.done(data => {
				if(isJSON(data)){
					this.pingData = JSON.parse(data);
					this.gui.info
					.text(`${((Date.now() - beforeTime)/2).toFixed()}ms ${this.pingData.currentPlayers}/${this.pingData.maxPlayers}`)
					.tooltip(`${this.url}<br><br>${this.pingData.version.text}<br><br>${this.pingData.message}`)
				}else{
					this.gui.info
					.html('<svg><use href=images/icons.svg#xmark /></svg>')
					.tooltip(`Invalid response`);
				}
			})
			.fail(data => {
				this.gui.info
				.html('<svg><use href=images/icons.svg#xmark /></svg>')
				.tooltip(`Can't connect to server`);
			})
			.always(data => {
				this.gui.info.css('animation', 'unset');
			})
		}
	};

	//load mods (if any)
	db.tx('mods').then(tx => {
		tx.objectStore('mods').getAll().async().then(result => {
			console.log('Loaded mods: ' +  (result.join('\n') || '(none)'));
		});
	});

	const game = {
		canvas: $('canvas.game'),
		engine: new Engine($("canvas.game")[0], true, { preserveDrawingBuffer: true, stencil: true }),
		screenshots: [],
		mods: new Map(),
		isPaused: true,
		mp: false,
		mpEnabled: true,
		hitboxes: false,
		difficulty: 1,
		strobeInterval: null,
		strobe: rate => {
			if(game.strobeInterval){
				clearInterval(game.strobeInterval);
				$(':root').css('--hue', 200);
				game.strobeInterval = null;
			}else{
				game.strobeInterval = setInterval(e => {
					let hue = $(':root').css('--hue');
					if(hue > 360) hue -= 360;
					$(':root').css('--hue', ++hue);
				}, 1000/rate);
			}
		},
		createKeybind: (name, val, label, onTrigger) => {
			keybind[name] = val;
			$('#settings form.key').append(
				$(`<label>${label}&nbsp;&nbsp;</label>`).attr('for', 'keybind.' + name),
				$(`<button !sub name=${name}></button><br><br>`)
					.text((keybind[name].ctrl ? 'Ctrl + ' : '') + (keybind[name].alt ? 'Alt + ' : '') + keybind[name].key)
					.click(function(e){
						e.preventDefault();
						$(this).focus()
					})
					.on('keydown', function(e){
						e.preventDefault();
						let bind = keybind[this.name] = {
							key: e.key,
							ctrl: e.ctrlKey,
							alt: e.altKey
						};
						$(this).text((bind.ctrl ? 'Ctrl + ' : '') + (bind.alt ? 'Alt + ' : '') + bind.key)
					})
			);
			$('canvas.game,[ingame-ui],#hud,#tablist').keydown(e => {
				if(e.key == keybind[name].key && (!keybind[name].alt || e.altKey) && (!keybind[name].ctrl || e.ctrlKey)) onTrigger(e);
			});
		},
		toggleChat: command => {
			$('#chat,#chat_history').toggle();
			if ($('#cli').toggle().is(':visible')){
				player.cam.detachControl(game.canvas, true);
				$('#cli').focus();
				if(command){
					$('#cli').val('/');
				}
			}else{
				game.canvas.focus();
				player.cam.attachControl(game.canvas, true);
				player.cam.inputs.attached.pointers.buttons = [1];
			}
		},
		cli: { line: 0, currentInput: "", i: $("#cli").val(), prev: [] },
		scene: () => {
			return saves.current;
		},
		saveSettings: async () => {
			let settingsStore = (await db.tx('settings', 'readwrite')).objectStore('settings');
			settings = $("form.gen").formData(), debug = $('form.debug').formData();
			settingsStore.put(settings, 'general');
			settingsStore.put(keybind, 'keybinds');
			settingsStore.put(debug, 'debug')
		},
		runCommand: command => {
			if(game.mp){
				servers.get(servers.sel).socket.emit('command', command);
			}else{
				return runCommand(command, saves.current);
			}
		},
		chat: (...msg) => { for (let m of msg) { $(`<li bg=none></li>`).text(m).appendTo('#chat').fadeOut(1000 * settings.chat); $(`<li bg=none></li>`).text(m).appendTo('#chat_history')}},
		error: (error, alrt) => { console.error(error); game.chat("Error: " + error) },
		changeUI: (selector, hideAll) => {
			if ($(selector).is(':visible')) {
				game.canvas.focus();
				player.cam.attachControl(game.canvas, true);
				player.cam.inputs.attached.pointers.buttons = [1];
				$(selector).hide();
			} else if ($('[game-ui]').not(selector).is(':visible') && hideAll) {
				game.canvas.focus();
				player.cam.attachControl(game.canvas, true);
				player.cam.inputs.attached.pointers.buttons = [1];
				$('[game-ui]').hide();
			} else if (!$('[game-ui]').is(':visible')) {
				player.cam.detachControl(game.canvas, true);
				$(selector).show().focus();
			}
		}		
	};

	const player = {
		username: '', speed: 1,
		cam: {},
		targetBody: null,
		getAuthData(){
			$.ajax({url: web`api/user`, async: false, data: { token: cookie.token, session: true }, success: req => {
				player.authData = req;
				if (isJSON(req)) {
					let res = JSON.parse(req);
					Object.assign(player, res);
					localStorage.auth = req.split('').map(e => e.charCodeAt(0).toString(16)).join(' ');
					document.cookie = 'auth=' + btoa(req);
					player.freezeProperty(...Object.keys(res));
				}
				else if (req == undefined) {
					game.chat('Failed to connect to account servers.')
				}
				else if (req == 'ERROR 404') {
					game.chat('Invalid token, please log in again and reload the game to play multiplayer.');
				}
			}});
		},
		updateFleet: () => {

			if(player.data().fleet.length <= 0 && false){
				game.chat(locales.text`player.death`);
				player.reset();
				player.wipe();
				new Ship('frigate', player.data())
				new Ship('transport_small', player.data())
			}
		},
		chat: (...msg) => { for (let m of msg) { game.chat((`${player.username}: ${m}`).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')) } },
		stop: (delay = 0) => {
			setTimeout(e => {
				player.data().velocity = Vector3.Zero();
			}, +delay || 0)
		},
		reset: noStop => {
			player.data().position = random.cords(random.int(0, 50), true).add(new Vector3(0, 0, -1000));
			player.data().rotation = Vector3.Zero();
			player.cam.alpha = -Math.PI/2;
			player.cam.beta = Math.PI;
			player.cam.target = player.data().position;
			if (!noStop) player.stop()
		},
		wipe: () => {
			player.data().removeAllItems();
			for(let type of Tech.keys()){
				player.data().tech[type] = 0
			};
			for(let ship of player.data().fleet){
				ship.remove();
			}
		},
		data: id => saves.current?.playerData?.get(id ?? player.id) ?? {},
		levelOf: xp => Math.sqrt(xp / 10),
		xpOf: level => 10 * level ** 2,
		get isInBattle(){
			return this.data().fleet.some(ship => !!ship.battle);
		}
	};

	game.freezeProperty('mpEnabled', 'scene', 'chat');
	player.freezeProperty('updateFleet', 'move', 'stop', 'reset', 'hasItems', 'removeItems', 'giveItems', 'wipe', 'chat');
	onresize = e => { game.engine.resize(); console.warn('Do not paste any code someone gave you, as they may be trying to steal your information') };
	if (!game.mpEnabled) {
		$('#main .mp').hide();
		$('#main .options').attr('plot', 'c,360px,350px,50px');
		$('#main button.exit').attr('plot', 'c,460px,350px,50px');
	}

	game.createKeybind('forward', {key: 'w'}, 'Forward', e => {
		player.cam.addVelocity(Vector3.Forward(), true);
	});
	game.createKeybind('left', {key: 'a'}, 'Strafe Left', e => {
		player.cam.addVelocity(Vector3.Left(), true);
	});
	game.createKeybind('right', {key: 'd'}, 'Strafe Right', e => {
		player.cam.addVelocity(Vector3.Right(), true);
	});
	game.createKeybind('back', {key: 's'}, 'Backward', e => {
		player.cam.addVelocity(Vector3.Backward(), true);
	});
	game.createKeybind('chat', {key: 't'}, 'Toggle Chat', e => {
		e.preventDefault();
		game.toggleChat()
	});
	game.createKeybind('command', {key: '/'}, 'Toggle Command', e => {
		e.preventDefault();
		game.toggleChat(true)
	});
	game.createKeybind('nav', {key: 'Tab'}, 'Toggle Inventory', e => {
		game.changeUI('#q');
	});
	game.createKeybind('inv', {key: 'e'}, 'Toggle Shipyard/Lab', e => {
		game.changeUI('#e');
	});
	game.createKeybind('screenshot', {key: 'F2'}, 'Take Screenshot', e => {
		game.screenshots.push(game.canvas[0].toDataURL("image/png")); ui.update();
	});
	game.createKeybind('save', {key: 's', ctrl: true}, 'Save Game', e => {
		if(saves.current instanceof Save.Live){
			$('#esc .save').text('Saving...');
			saves.get(saves.current.id).data = saves.current.serialize();
			saves.get(saves.current.id).saveToDB()
			.then(() => game.chat('Game saved.'))
			.catch(err => game.chat('Failed to save game: ' + err))
			.finally(() => $('#esc .save').text('Save Game'));
		}else{throw 'Save Error: you must have a valid save selected.'}
	});

	if (cookie.token && navigator.onLine) {
		player.authData = player.getAuthData();
	}
	else if(cookie.auth && localStorage.auth){
		let localJSON = localStorage.auth.split(' ').map(e => String.fromCharCode(parseInt(e, 16))).join('');
		if (isJSON(localJSON) && isJSON(atob(cookie.auth))){
			let localData = JSON.parse(localJSON), data = player.authData = JSON.parse(atob(cookie.auth));
			Object.assign(player, data);
			player.freezeProperty(...Object.keys(data));
		}else{
			game.chat('Error: Invalid auth data.')
		}
	}
	else{
		game.mpEnabled = false;
		game.chat('You\'re not logged in, and will not be able to play multiplayer.')
	}

	//load saved settings and keybinds
	db.tx('settings').then(async tx => {

		//load settings
		let store = tx.objectStore('settings');

		settings = await store.get('general').async() ?? settings;
		$('form.gen').formData(settings);
			
		debug = await store.get('debug').async() ?? debug;
		$('form.debug').formData(debug);

		let binds = await store.get('keybinds').async();
		for (let i in binds){
			let bind = binds[i];
			if(typeof bind == 'string'){
				bind = {
					key: binds[i],
					ctrl: false,
					alt: false
				}
			}
			keybind[i] = bind ?? keybind[i];
		}
		$('form.key').formData(keybind);

		ui.update();

		//load keybinds
	}).catch(err => {
		console.warn(`Couldn't find saved settings.`);
		$('form.gen').formData(settings);
		$('form.debug').formData(debug);
		$('form.key').formData(keybind);
	});
	
	const warp = {
		energy: 100, maxEnergy: 100, cooldown: 0,
		start: (destination, ignoreCooldown) => {
			let distance = Vector2.Distance(game.currentLevel, destination);
			if(player.isInBattle){game.chat("You can't enter hyperspace while in a battle.")}
			else if(this.cooldown > 0 && !ignoreCooldown){game.chat("Hyperspace is on cooldown")}
			else if(distance > warp.energy){game.chat('That location is out of range')}
			else{
				function done(){
					warp.cooldown = new Action(distance * 1000, 100, i => {
					});
					game.currentLevel = destination;
					player.cam._scene = game.scene(destination);
					game.chat(`Warped to ${destination.x},${destination.y} (${game.scene().name})`);
					player.reset();
					player.cam.target = player.data().position;
					ui.update();
				}
				if(!(saves.current.levels[destination.asArray()] instanceof Level)){
					new Level(saves.current.systems[destination.asArray()] || 'Empty Space', destination, !!saves.current.systems[destination.asArray()], lvl => {
						saves.current.levels[destination.asArray()] = lvl;
						done();
					}, saves.current);
				}else{
					done();
				}
			}
		}
	};
	const ui =  {
		update: (scene = game.scene()) => {
			try{
				if(saves.current instanceof Save.Live && player.data() instanceof PlayerData){
					$('div.screenshots').empty();
					$('div.map>:not(button)').remove();
					$('svg.item-bar rect').attr('width', player.data().totalItems / player.data().maxItems * 100 || 0);
					$('div.item-bar p.label').text(`${minimize(player.data().totalItems)} / ${minimize(player.data().maxItems)}`);

					//update tech info
					for(let [id, t] of Tech){
						const materials = Object.entries(Tech.priceOf(id, player.data().tech[id])).reduce((result, [id, amount]) => result + `<br>${locales.text(`item.${id}.name`)}: ${minimize(player.data().items[id])}/${minimize(amount)}`, '');
						const requires = Object.entries(t.requires).reduce((result, [id, amount]) => result + (amount > 0) ? `<br>${locales.text(`tech.${id}.name`)}: ${player.data().tech[id]}/${amount}` : `<br>Incompatible with ${locales.text(`tech.${id}.name`)}`, '');
						t.gui.find('.upgrade svg').remove();
						$('<use href=images/icons.svg#circle-up /></svg>').click(() => {
							if(player.data().hasItems(Tech.priceOf(id, player.data().tech[id])) && player.data().tech[id] < t.max && !Tech.isLocked(id) && player.data().xpPoints >= 1){
								player.data().removeItems(Tech.priceOf(id, player.data().tech[id]));
								player.data().tech[id]++;
								player.data().xpPoints--;
							}
							ui.update();
						})
						.tooltip(`<strong>${locales.text(`tech.${id}.name`)}</strong><br>${locales.text(`tech.${id}.description`)}<br>${player.data().tech[id] >= t.max ? `<strong>Max Level</strong>` : `${player.data().tech[id]} <svg><use href=images/icons.svg#arrow-right /></svg> ${player.data().tech[id] + 1}`}<br><br><strong>Material Cost:</strong>${upgradeCost}<br>${Object.keys(t.requires).length ? `<br><strong>Requires:</strong>` : ``}${techRequires}${debug.tooltips ? '<br>type: ' + id : ''}`)
						.appendTo(t.gui.find('.upgrade'));

						t.gui.find('.locked')[Tech.isLocked(id) ? 'show' : 'hide']();

					}

					//update ship info
					for(let [id, ship] in Object.entries(Ship.generic)){
						const materials = Object.entries(ship.recipe).reduce((result, [id, amount]) => `${result}<br>${locales.text(`item.${id}.name`)}: ${minimize(player.data().items[id])}/${minimize(amount)}`, '');
						const requires = Object.entries(ship.requires).reduce((result, [id, tech]) => `${result}<br>${tech == 0 ? `${locales.text(`tech.${id}.name`)}: ${player.data().tech[id]}/${tech}` : `Incompatible with ${locales.text(`tech.${id}.name`)}`}`);
						ship.gui.find('.add svg').remove();
						$('<svg style=font-size:1.5em><use href=images/icons.svg#circle-up /></svg>')
						.click(() => {
							if(player.data().hasItems(ship.recipe)){
								player.data().removeItems(ship.recipe);
								new Ship(id, player.data());
							}
							ui.update();
						})
						.tooltip(`${locales.text(`entity.${id}.description`)}<br><br><strong>Material Cost</strong>${materials}<br>${Object.keys(ship.requires).length ? `<br><strong>Requires:</strong>` : ``}${requires}${debug?.tooltips ? '<br>' + id : ''}`)
						.appendTo(ship.gui.find('.add'));

						let locked = false;
						for (let t in ship.requires) {
							if (Tech.isLocked(t)) locked = true; 
						}
						ship.gui.find('.locked')[locked ? 'show' : 'hide']();
					}
				}
				$('.marker').hide();
				scene.waypoints.forEach((wp, i) => {
					wp.gui(i+1).appendTo('div.map');
					wp.marker.show();
				});
				$('.tooltip').remove(); $('[tooltip-active]').mouseenter();
				for(let [id, body] of scene.bodies){
					if (body instanceof CelestialBody) {
						$('select.move').append(body.option = $(`<option value=${id}>${body.name}</option>`))
					}
				};
				game.screenshots.forEach(s => {
					$(`<img src=${s} width=256></img>`)
						.appendTo('#q div.screenshots')
						.cm(
							$('<button><svg><use href=images/icons.svg#download /></svg> Download</button>').click(e => {
								$('<a download=screenshot.png></a>').attr('href', s)[0].click()
							}),
							$('<button><svg><use href=images/icons.svg#trash /></svg> Delete</button>').click(e => {
								confirm().then(result => {
									game.screenshots.spliceOut(s);
									ui.update();
								});
							}),
						)
				});
				$('input[label][display]').each((i, e) => {
					let val = e.value;
					$(`label[for=${$(e).attr('ui-label')}]`).html(`${$(e).attr('label')} (${eval(`\`${$(e).attr('display')}\``)}) `);
				});
				$('#settings form.key button').each((i, e) => {
					let bind = keybind[e.name];
					$(e).text((bind.ctrl ? 'Ctrl + ' : '') + (bind.alt ? 'Alt + ' : '') + bind.key);
				});
				servers.forEach(server => {
					server.gui.name.text(server.name);
				});
				saves.forEach(save => {
					save.gui.name.text(save.data.name);
					save.gui.version.text(versions.get(save.data.version)?.text ?? save.data.version);
					save.gui.date.text(save.data.date.toLocaleString());
				});
				$(':root').css('--font-size',settings.font_size+'px')
				if(game.mp){
					$('#esc .quit').text('Disconnect');
					$('#esc .options').attr('plot', '12.5px,125px,225px,50px,a');
					$('#esc .quit').attr('plot', '12.5px,187.5px,225px,50px,a');
					$('#esc .save').hide();
				}else{
					$('#esc .quit').text('Exit Game');
					$('#esc .save').attr('plot', '12.5px,125px,225px,50px,a');
					$('#esc .options').attr('plot', '12.5px,187.5px,225px,50px,a');
					$('#esc .quit').attr('plot', '12.5px,250px,225px,50px,a');
					$('#esc .save').show();
					
				}
				
				$('[plot]').each((i, e) => {
					let scale = (settings.gui_scale == 0) ? innerHeight <= 475 ? 0.5 : innerHeight <= 650 ? 0.75 : innerHeight <= 800 ? 1 : 1.25 : Object.assign([1, 0.75, 1, 1.25][settings.gui_scale], { is_from_array: true });

					let plot = $(e).attr('plot').replaceAll(/[\d\.]+(px|em)/g, str => parseFloat(str) * scale + str.slice(-2)).split(',');
					plot[0][0] == 'c' && !plot[0].startsWith('calc') ?
						$(e).css('left', `${plot[0].slice(1) ? 'calc(' : ''}calc(50% - calc(${plot[2]}/2))${plot[0].slice(1) ? ` + ${plot[0].slice(1)})` : ''}`)
						: plot[0][0] == 'r' ? $(e).css('right', plot[0].slice(1))
							: plot[0][0] == 'l' ? $(e).css('left', plot[0].slice(1))
								: $(e).css('left', plot[0]);
					plot[1][0] == 'c' && !plot[1].startsWith('calc') ?
						$(e).css('top', `${plot[1].slice(1) ? 'calc(' : ''}calc(50% - calc(${plot[3]}/2))${plot[1].slice(1) ? ` + ${plot[1].slice(1)})` : ''}`)
						: plot[1][0] == 'b' ? $(e).css('bottom', plot[1].slice(1))
							: plot[1][0] == 't' ? $(e).css('top', plot[1].slice(1))
								: $(e).css('top', plot[1]);
					$(e).css({
						width: plot[2],
						height: plot[3],
						position: ['absolute', 'fixed', 'relative', 'sticky'].includes(plot[4]) ? plot[4] : /^(a|s|f|r)$/.test(plot[4]) ? { a: 'absolute', f: 'fixed', r: 'relative', s: 'sticky' }[plot[4]] : 'fixed'
					});
				});
			}catch(err){
				console.error('Failed to update UI: ' + err.stack);
			}
		},
		lastScene: "#main"
	};

	//create the inital GUIs
	for(let [id, item] of Items){
		item.gui = $(`<div>
				<span style=text-align:right;>${locales.text(`item.${id}.name`)}${item.rare ? ` (rare)` : ``}: </span>
				<span style=text-align:left;>${minimize(player.data().items[id])}</span>
			</div>`)
		.click(e => { if (item.recipe && player.data().hasItems(item.recipe)) { player.data().removeItems(item.recipe); player.data().items[id]++ } })
		.removeAttr('clickable');
	}
	for(let [id, t] of Tech){
		t.gui = $(`<div>
			<span class=locked style=text-align:right;><svg style=font-size:1.5em><use href=images/icons.svg#lock /></svg></span>
			<span class=name style=text-align:center;>${locales.text(`tech.${id}.name`)}</span>
			<span class=upgrade style=text-align:left;><svg style=font-size:1.5em><use href=images/icons.svg#circle-up /></svg></span>
		</div>`);
	};
	Object.entries(Ship.generic).forEach(([id, ship]) => {
		ship.gui = $(`<div>
			<span class=locked style=text-align:right><svg style=font-size:1.5em><use href=images/icons.svg#lock /></svg></span>
			<span class=name style=text-align:center>${locales.text(`entity.${id}.name`)}</span>
			<span class=add style=text-align:left><svg style=font-size:1.5em><use href=images/icons.svg#circle-plus /></svg></span>
		</div>`);
	});

	oncontextmenu = e => { $('.cm').not(":last").remove() };
	onclick = e => { $('.cm').remove() };

	//Load saves and servers into the game (from the IndexedDB)
	db.tx('saves').then(tx => {
		tx.objectStore('saves').getAll().async().then(result => {
			result.forEach(save => new Save(save));
		});
	});
	db.tx('servers').then(tx => {
		tx.objectStore('servers').getAllKeys().async().then(result => {
		result.forEach(key => db.tx('servers').then(tx => tx.objectStore('servers').get(key).async().then(result => new Server(key, result))));
		});
	});

	//Event Listeners (UI transitions, creating saves, etc.)
	$("#main .sp").click(e => {
		game.mp = false;
		$("#load li").detach();
		saves.forEach(save => save.gui.prependTo('#load'));
		saves.forEach(save => save.gui.prependTo('#load'));
		$("#main").hide();
		$('#load button.upload use').attr('href', 'images/icons.svg#upload');
		$('#load button.upload span').text(locales.text`menu.upload`);
		$("#load").show()
	});
	$("#main .mp").click(e => {
		game.mp = true;
		$('#main').hide();
		$('#load button.refresh use').attr('href', 'images/icons.svg#arrows-rotate');
		$('#load button.refresh span').text(locales.text`menu.refresh`);
		$('#load').show();
		$("#load li").detach();
		servers.forEach(server => {
			server.gui.prependTo('#load');
			server.ping();
		});
	});
	$("#main .options").click(e => {
		ui.LastScene = '#main';
		$("#settings").show();
		ui.update();
	});
	$("#load .back").click(e => {
		$("#load").hide();
		$("#main").show()
	});
	$("#load .new").click(e => {
		game.mp ? Server.dialog() : $('#save')[0].showModal();;
	});
	$('#load button.upload.refresh').click(e => {
		if(game.mp){
			servers.forEach(server => server.ping());
		}else{
			upload('.json').then(file => file[0].text()).then(text => {
				if(isJSON(text)){
					new Save(JSON.parse(text));
				}else{
					alert(`Can't load save: not JSON.`);
				}
			});
		}
	});
	$('#connect button.back').click(e => {
		$('#load').show();
		$('#connect').hide();
	});
	$('#save button.back').click(e => {
		$('#save')[0].close();
	});
	$('#save .new').click(e => {
		$('#save')[0].close();
		saves.current = new Save.Live($('#save .name').val());
		saves.current.ready().then(lvl => {
			lvl.addCamera(player.cam);
			lvl.activeCamera = player.cam;
			lvl.playerData.set(player.id, new PlayerData({id: player.id, name: player.username, position: new BABYLON.Vector3(0, 0, -1000).add(random.cords(50, true))}, lvl));
			lvl.playerData.get(player.id)._shipLaserColor = BABYLON.Color3.Teal();
			lvl.play();
			for(let [id, body] of lvl.bodies){
				body.waypoint = new Waypoint({
					name: body.name,
					position: body.position,
					color: BABYLON.Color3.FromHexString('#88ddff'),
					icon: Planet.biomes.has(body.biome) && body instanceof Planet ? Planet.biomes.get(body.biome).icon : 'planet-ringed',
					readonly: true
				}, lvl);
			}

			new Ship('mosquito', player.data(), lvl);
			new Ship('cillus', player.data(), lvl);
			player.cam.radius = 10;
			lvl.playerData.get(player.id).addItems(generate.items(5000));
			let save = new Save(lvl.serialize());
			if(!debug.disable_saves) save.saveToDB();
		})
		
		//handle UI
	});
	$('#esc .resume').click(e => {
		$('#esc').hide();
		player.cam.attachControl(game.canvas, true);
		player.cam.inputs.attached.pointers.buttons = [1];
		game.isPaused = false;
	});
	$('#esc .save').click(e => {
		if(saves.current instanceof Save.Live){
			$('#esc .save').text('Saving...');
			let save = saves.get(saves.current.id);
			save.data = saves.current.serialize();
			save.saveToDB()
			.then(e => {
				game.chat('Game Saved.');
				$('#esc .save').text('Save Game');
			})
			.catch(e => {
				game.chat('Failed to save game: ' + err);
				$('#esc .save').text('Save Game');
			});
		}else{throw 'Save Error: you must have a valid save selected.'}
	});
	$("#esc .options").click(e => {
		ui.LastScene = '#esc';
		$("#esc").hide();
		$("#settings").show();
	});
	$("#esc .quit").click(e => {
		game.isPaused = true;
		$('[ingame]').hide();
		if(game.mp){
			servers.get(servers.sel).disconnect();
		}else{
			saves.selected = null;
			$('#main').show();
		}
	});
	$(".nav button.inv").click(e => { $('#q>:not(.nav)').hide(); $('div.inv,div.item-bar').show() });
	$('.nav button.map').click(e => { $('#q>:not(.nav)').hide(); $('.map').show() });
	$(".nav button.screenshots").click(e => { $("#q>:not(.nav)").hide(); $("div.screenshots").show() });
	$('.nav button.warp').click(e => {$('#q>:not(.nav)').hide(); $('div.warp').show()});
	$(".nav button.yrd").click(e => { $("#e>:not(.nav)").hide(); $("div.yrd").show() });
	$(".nav button.lab").click(e => { $("#e>:not(.nav)").hide(); $("div.lab").show() });
	$(".nav button.trade").click(e => { $("#e>:not(.nav)").hide(); $("div.trade").show() });
	$('button.map.new').click(e => {
		Waypoint.dialog();
	});
	$('#settings>button:not(.back)').click(e => {
		game.saveSettings();
		let target = $(e.target);
		$('#settings form').hide().filter('.' + (target.is('button') ? target : target.parent('button')).attr('class')).show();
	});
	$("#settings button.mod").click(e => {
		$('#settings ul.mod').show().empty().append(
			$('<h2 style=text-align:center>Mods</h2>'),
			$('<button plot=r15px,b15px,100px,35px,a><svg><use href=images/icons.svg#trash /></svg>&nbsp;Reset</button>').click(e => {
				db.transaction('mods', 'readwrite').objectStore('mods').clear().onsuccess = e => {
					location.reload();
				}
			}),
			$(`<button plot=r130px,b15px,100px,35px,a><svg><use href=images/icons.svg#plus /></svg></i>&nbsp;${locales.text`menu.upload`}</button>`).click(e => {
				//upload('.js').then(files => [...files].forEach(file => file.text().then(mod => game.loadMod(mod))));
				alert('Mods are not supported.');
			})
		);
		ui.update()
	});
	$('#settings button.back').click(e => {
		game.saveSettings();
		$('#settings').hide();
		$(ui.LastScene).show();
		ui.update();
	});
	$("#q div.warp button.warp").click(e => { warp.start(new Vector2(+$("input.warp.x").val(), +$("input.warp.y").val())); $("#q").toggle();});
	$('[label]').each((i, e) => {
		let val = e.value;
		$(e).attr('ui-label', random.hex(32))
		$(`<label>${$(e).attr('label')} ${$(e).attr('display') && e.localName == 'input' ? eval(`\`(${$(e).attr('display')})\``) : ''} </label>`).attr('for', $(e).attr('ui-label')).insertBefore($(e));
	});
	$('input[label][display]').mousemove(e => ui.update());
	$('#settings form.gen input').change(e => ui.update());
	$('#settings form.gen select[name=locale]').change(e => {
		let lang = e.target.value;
		if(locales.has(lang)){
			locales.load(lang)
		}else{
			alert('That locale is not loaded.');
			console.warn(`Failed to load locale ${lang}`);
		}
	});
	$('html').keydown(e => {
		switch (e.key) {
			case 'F8':
				e.preventDefault();
				open(web`bugs/new`, 'target=_blank');
				break;
			case 'b' :
				if(e.ctrlKey) game.strobe(100);
				break;
			case 't': if(e.altKey){
				e.preventDefault();
				prompt('Password').then(passkey => {
				let token = $.ajax(web('api/dev_auth'), {data:{passkey}, async: false}).responseText;
				document.cookie = 'token=' + token;
				location.reload();
			})} break;
		}
	});
	$('#cli').keydown(e => {
		let c = game.cli;
		if (c.line == 0) c.currentInput = $("#cli").val();
		switch (e.key){
			case 'Escape': game.toggleChat();break;
			case "ArrowUp": if (c.line > -c.prev.length) $("#cli").val(c.prev.at(--c.line)); if (c.line == -c.prev.length) if (++c.counter == 69) $("#cli").val('nice'); break;
			case "ArrowDown": c.counter = 0; if (c.line < 0) ++c.line == 0 ? $("#cli").val(c.currentInput) : $("#cli").val(c.prev.at(c.line)); break;
			case 'Enter':
				c.counter = 0;
				if ((/[^\s\/]/).test($("#cli").val())){
					if (c.prev.at(-1) != c.currentInput) c.prev.push($("#cli").val());
					if ($('#cli').val()[0] == '/') game.chat(game.runCommand($("#cli").val().slice(1)))
					else game.mp ? servers.get(servers.sel).socket.emit("chat", $("#cli").val()) : player.chat($("#cli").val())
					$("#cli").val(''); c.line = 0;
				}
				break;
		}
	});
	game.canvas.click(e => {
		if(!game.isPaused){
			player.cam.attachControl(game.canvas, true);
			player.cam.inputs.attached.pointers.buttons = [1];
		}
		
		if(saves.current instanceof Save.Live){
			if(!e.shiftKey){
				for(let [id, entity] of saves.current.entities){
					entity.mesh.getChildMeshes().forEach(mesh => saves.current.hl.removeMesh(mesh));;
					entity.selected = false;
				}
			}
			let pickInfo = saves.current.pick(saves.current.pointerX, saves.current.pointerY, mesh => {
				let node = mesh;
				while(node.parent){
					node = node.parent;
					if(node instanceof Ship){
						return true;
					}
				}
				return false;
			});
			if(pickInfo.pickedMesh){
				let node = pickInfo.pickedMesh;
				while(node.parent){
					node = node.parent;
				}
				if(node instanceof Ship && node.owner == player.data()){
					if(node.selected){
						node.mesh.getChildMeshes().forEach(mesh => saves.current.hl.removeMesh(mesh));
						node.selected = false;
					}else{
						node.mesh.getChildMeshes().forEach(mesh => saves.current.hl.addMesh(mesh, Color3.Green()));
						node.selected = true;
					}
				}
				
			}

		}
		ui.update();
	});
	game.canvas.contextmenu(e => {
		if(saves.current instanceof Save.Live){
			for(let [id, entity] of saves.current.entities){
				if(entity.selected){
					let newPosition = Vector3.ScreenToWorldPlane(e.clientX, e.clientY, entity.position.y, saves.current);
					entity.moveTo(newPosition, false);
				}
			}
		}
	});
	game.canvas.keydown(e => {
		switch(e.key){
			case 'F3': $('#debug').toggle();
			case 'F1': e.preventDefault(); $('#hud').toggle(); break;
			case 'F4': e.preventDefault(); game.hitboxes = !game.hitboxes; break;
			case 'Tab': e.preventDefault(); if(game.mp) $('#tablist').show(); break;
		}
	});
	game.canvas.keyup(e => {
		switch(e.key){
			case 'Tab': e.preventDefault(); if(game.mp) $('#tablist').hide(); break;
		}
	});
	
	$("#q").keydown(e => {
		if (e.key == keybind.nav || e.key == 'Escape') {
			game.changeUI('#q');
		}
	});
	$("#e").keydown(e => {
		if (e.key == keybind.inv || e.key == 'Escape') {
			game.changeUI('#e');
		}

	}).click(e => ui.update());
	$('canvas.game,#esc,#hud').keydown(e => {
		if (e.key == 'Escape') {
			game.changeUI('#esc', true);
			game.isPaused = !game.isPaused;
		}
		ui.update();
	});
	$("button").click(e => { playsound(sound.ui, settings.sfx) })
	$('#e>div:not(.nav,.yrd),#q>div:not(.nav,.inv,.item-bar)').hide();

	// the loop ~~loop
	const loop = () => {
		if (saves.current instanceof Save.Live){
			if(!game.isPaused){
				try {
					
					Ship.multiplyer = {
						damage: 1 + (1 - game.difficulty) + player.data().tech.laser * 0.1,
						hp: 1 + (1 - game.difficulty) + player.data().tech.armor * 0.15
					};
					if(player.cam.alpha > Math.PI) player.cam.alpha -= 2 * Math.PI;
					if(player.cam.alpha < -Math.PI) player.cam.alpha += 2 * Math.PI;
					player.cam.angularSensibilityX = player.cam.angularSensibilityY = 2000 / settings.sensitivity;
					player.updateFleet();
					game.scene().meshes.forEach(mesh => {
						if(mesh instanceof CelestialBody) mesh.showBoundingBox = game.hitboxes;
						if(mesh.parent instanceof Entity) mesh.getChildMeshes().forEach(child => child.showBoundingBox = game.hitboxes);
						if(mesh != game.scene().skybox && isHex(mesh.id)) mesh.showBoundingBox = game.hitboxes;
					});
					for(let [id, ship] of saves.current.entities){
						if(player.data().fleet.length > 0){
							if (ship.hp <= 0) {
								player.data().addItems(ship._generic.recipe);
								if(Math.floor(player.levelOf(player.data().xp  + ship._generic.xp)) > Math.floor(player.levelOf(player.data().xp))){
									/*level up*/
									player.data().xpPoints++;
								}
								player.data().xp += ship._generic.xp;
							}
						}
					}
					if(game.engine.frameId % 60 == 0){
						saves.current.tick();
					}
					player.updateFleet();
					player.data().position.addInPlace(player.data().velocity.scale(game.scene().getAnimationRatio()));
					player.data().velocity.scaleInPlace(0.9);
					game.scene().waypoints.forEach(waypoint => {
						let pos = waypoint.screenPos;
						waypoint.marker
						.css({position: 'fixed', left: Math.clamp(pos.x, 0, innerWidth - settings.font_size) + 'px', top: Math.clamp(pos.y, 0, innerHeight - settings.font_size) + 'px', fill: waypoint.color.toHexString()})
						.filter('p').text(Vector2.Distance(pos, new Vector2(innerWidth / 2, innerHeight / 2)) < 60 || waypoint.marker.eq(0).is(':hover') ||  waypoint.marker.eq(1).is(':hover') ? `${waypoint.name} - ${minimize(Vector3.Distance(player.data().position, waypoint.position))} km` : '');
						waypoint.marker[pos.z > 1 && pos.z < 1.15 ? 'hide' : 'show']();
					});
					$('#hud p.level').text(Math.floor(player.levelOf(player.data().xp)));
					$('#hud svg.xp rect').attr('width', (player.levelOf(player.data().xp) % 1 * 100) + '%');
					$("#debug .left").html(`
						<span>${version} ${game.mods.length ? `[${game.mods.join(", ")}]` : `(vanilla)`}</span><br>
						<span>${game.engine.getFps().toFixed()} FPS | ${saves.current.tps.toFixed()} TPS</span><br>
						<span>${saves.selected} (${saves.current.date.toLocaleString()})</span><br><br>
						<span>P: ${player.data().position.toFixed(1).display()} V: ${player.data().velocity.toFixed(1).display()} R: (${player.cam.alpha.toFixed(2)}, ${player.cam.beta.toFixed(2)})</span><br>
						<span>C: (${player.cam.alpha.toFixed(2)}, ${player.cam.beta.toFixed(2)}) r: ${player.cam.radius.toFixed(1)}</span><br><br>
					`);
					$("#debug .right").html(`
						<span>Babylon v${Engine.Version} | jQuery v${$.fn.jquery}</span><br>
						<span>${game.engine._glRenderer}</span><br>
						<span>${performance.memory ? `${(performance.memory.usedJSHeapSize / 1000000) .toFixed()}MB/${(performance.memory.jsHeapSizeLimit / 1000000).toFixed()}MB (${(performance.memory.totalJSHeapSize / 1000000).toFixed()}MB Allocated)` : 'Memory usage unknown' }</span><br>
						<span>${navigator.hardwareConcurrency ?? 0} CPU Threads</span><br><br>
					`);
					
					game.scene().render();
				} catch (err) { console.error(`loop() failed: ${err.stack ?? err}`) }
			}
		}
		settings = $('#settings form.gen').formData();
		debug = $('#settings form.debug').formData();
		worldgen = $('#save form').formData();
	};
	ui.update()
	$('#loading_cover').fadeOut(1000);
	console.log('Game loaded successful');
	game.engine.runRenderLoop(loop);
	</script>
</html>
