<!DOCTYPE html>
<html>
<head>
	<script async>
		let db = {}, openDBReq = indexedDB.open('blankstorm', 1);
		openDBReq.onsuccess = e => {
			db = e.target.result;
		};
		openDBReq.onerror = e => {
			console.error('Failed to open IndexedDB: ' + e.target.error);
		}
		openDBReq.onupgradeneeded = e => {
			let db = e.target.result;
			db.createObjectStore('saves');
			db.createObjectStore('settings');
			db.createObjectStore('servers');
			db.createObjectStore('mods');
		}
	</script>
	<link rel=icon href=image/icon.png type=image/png>
	<style>
		:root{
			--text-color: hsla(200, 100%, 90%, .8);
			--text-shadow: 0 0 7px hsla(200, 80%, 80%, 1);
			--font-family: sans-serif;
			--bg-color: hsla(200, 50%, 25%, 1);
			--bg-color-seethru: hsla(200, 50%, 25%, 0.25);
			--button-color: hsla(200, 100%, 70%, .5);
			--gradient-outside-color: hsla(200, 50%, 0%, 1);
			--gradient-inside-color: hsla(200, 70%, 70%, .5);
			--bg-color-alt: #252525;
			--bg-shadow: 0 0 6px hsla(200, 100%, 80%, 1);
			--hover-shadow: 0 0 8px hsla(200, 100%, 90%, 1);
			--bg-radius: 4px;
			scrollbar-color: var(--text-color);
			scrollbar-width: thin;
		}
		#loading_cover svg path{
			transform-origin: center;
			animation: 1s linear infinite rotate;
		}
		@keyframes rotate{
			from{
				transform: rotate(0);
			}
			to{
				transform: rotate(360deg);
			}
		}
		body{
			font-family: var(--font-family);
			background-color: var(--bg-color-alt);
			color: var(--text-color);
		}
		p, a, span, h1, h2, h3, h4, h5, h6{
			color: var(--text-color);
			font-family: var(--font-family);
		}
		h1, h2, h3, h4, h5, h6, [text-shadow], [fa]{
			text-shadow: var(--text-shadow);
		}
		[bg=default]{
			background-color: var(--bg-color-alt);
		}
		code{
			font-family: monospace;
			background-color: #222;
			border: 1px solid #080808;
			border-radius: 25%
		}
		table, tr, td{
			border: 1px solid white;
			text-shadow: #EEE 0px 0px 7px;
			border-collapse: collapse
		}
		table{
			background: var(--bg-color-alt);
			box-shadow: var(--bg-shadow);
			display: inline-block;
			border-radius: var(--bg-radius);
			position: relative;
			width: fit-content;
			color: var(--text-color);
			border-collapse: collapse;
			margin: 24px;
		}
		[tabindex]:focus, [nooutline]{
			outline: none;
		}
		td{
			padding: 3px;
			text-shadow: none
		}
		button{
			box-shadow: var(--bg-shadow);
			border-radius: var(--bg-radius);
			color: var(--text-color);
			font-family: var(--font-family);
			cursor: pointer;
			background: radial-gradient(ellipse at center, var(--gradient-outside-color) 0, var(--button-color) 150%);
			border: 0;
			padding: 5px 15px;
		}
		button:hover{
			background: radial-gradient(ellipse at center, var(--gradient-outside-color) 0, var(--button-color) 100%);
			box-shadow: var(--hover-shadow);
		}
		input, textarea{
			display: inline-block;
			background: linear-gradient(to top, var(--gradient-inside-color) 0, var(--gradient-outside-color) 20%, var(--gradient-outside-color) 60%, var(--gradient-inside-color) 100%);
			box-shadow: var(--bg-shadow);
			border-radius: var(--bg-radius);
			margin-top: 10px;
			position: relative;
			color: var(--text-color);
		}
		input:hover{
			cursor: text
		}
		input[type=checkbox]:hover{
			cursor: pointer
		}
		:where(div:not([bg=light]), dialog, ol, ul, nav, form):not([bg]){
			background: var(--bg-color);
			border-radius: var(--bg-radius);
			box-shadow: var(--bg-shadow);
			color: var(--text-color);
		}
		body>:where(div:not([bg=light]), ol, ul, nav, form):not([bg]), [bg=trans]{
			border-radius: var(--bg-radius);
			box-shadow: var(--bg-shadow);
			color: var(--text-color);
			background: linear-gradient(to right, var(--bg-color) 0%, var(--bg-color-seethru) 10%, var(--bg-color-seethru) 50%, var(--bg-color-seethru) 90%, var(--bg-color) 100%), 		linear-gradient(to bottom, var(--bg-color) 0%, var(--bg-color-seethru) 20%, var(--bg-color-seethru) 50%, var(--bg-color-seethru) 80%, var(--bg-color) 100%);
		}
		dialog{
			border: none;
		}
		li:not([bg=none]){
			border-radius: var(--bg-radius);
			color: var(--text-color);
		}
		input[type=range]{
			-webkit-appearance: none;
			overflow: hidden;
			height: 10px;
			background: var(--bg-color);
		}
		input[type=range]::-webkit-slider-runnable-track{
			-webkit-appearance: none;
			appearance: none;
			width: 100%;
			height: 25px;
			border-radius: var(--bg-radius);
			background: var(--bg-color);
			outline: none;
		}
		input[type=range]::-webkit-slider-thumb{
			-webkit-appearance: none;
			appearance: none;
			width: 25px;
			height: 25px;
			border-radius: 25%;
			background: var(--text-color);
			cursor: pointer;
		}
		::-webkit-scrollbar{
			background-color: rgb(0, 0, 0, 0);
			width: 5px;
		}
		::-webkit-scrollbar-track{
			background-color: rgb(0, 0, 0, 0);
		}
		::-webkit-scrollbar-thumb{
			background-color: var(--text-color);
			border-radius: 2.5px;
		}
		form input, form.key button{
			position: absolute;
			left: 51%
		}
		form label{
			position: absolute;
			right: 51%;
			width: 50%;
			text-align: right
		}
		#chat li{
			background: none;
			list-style: none
		}
		[cover]{
			position: fixed;
			left: 0%;
			top: 0%;
			width: 100%;
			height: 100%
		}
		#gamecover{
			z-index: 0
		}
		#e div:not(#nav){
			position: absolute;
			top: 15%;
			left: 2.5%;
			width: 90%;
			height: 80%
		}
		ul.screenshots img{
			border: 1px solid var(--text-color);
			border-radius: 5px;
			margin: 10px
		}
		#debug p{
			position: fixed
		}
		#debug span{
			background-color: #2225
		}
		#settings ul, #settings form{
			position: absolute;
			left: 25%;
			width: 70%;
			top: 5%;
			height: 90%
		}
		[bg=light]{
			border-radius: var(--bg-radius);
			box-shadow: var(--bg-shadow);
			text-shadow: var(--text-shadow);
			color: var(--text-color);
			background-color: hsl(200, 50%, 90%, 0.75);
		}
		.accordion{
			width: 500px
		}
		.title{
			font-size: 50px;
			text-align: center;
			color: var(--text-color);
			text-shadow: var(--text-shadow);
		}
		.table-content{
			font-size: 15px;
			padding: 10px;
		}
		.table-title{
			font-size: 17px;
			vertical-align: top;
			padding: 5px;
		}
		.selected{
			border: 1px solid var(--text-color);
		}
		.ship-info{
			left: 80%
		}
		li[bg]{
			list-style: none;
			margin: 1% 10% 1% 5%;
			height: 10%;
			background: var(--bg-color);
			border-radius: var(--bg-radius);
			color: var(--text-color);
			box-shadow: var(--bg-shadow);
		}
		[bg=none], li[bg=none]{
			background: none;
			box-shadow: none
		}
		[border]{
			border: 1px solid var(--text-color);
			border-radius: var(--bg-radius);
		}
		[center-flex]{
			display: flex;
			justify-content: center;
		}
		[hide]{
			display: none
		}
		[lsn]{
			list-style: none !important
		}
		[nbs]{
			box-shadow: none !important
		}
		[nts]{
			text-shadow: none !important
		}
		[ofs=]{
			overflow: scroll !important
		}
		[ofs=x]{
			overflow-x: scroll !important
		}
		[ofs=y]{
			overflow-y: scroll !important
		}
		[ofn=]{
			overflow: hidden !important
		}
		[ofn=x]{
			overflow-x: hidden !important
		}
		[ofn=y]{
			overflow-y: hidden !important
		}
		[bw]{
			word-wrap: break-word !important
		}
		[cover]{
			position: fixed;
			left: 0%;
			top: 0%;
			width: 100%;
			height: 100%
		}
		[content]{
			position: fixed;
			left: 15%;
			top: 10%;
			width: 70%;
			height: 80%
		}
		ul[content]{
			height: 70%;
			padding: 5%
		}
		[clickable]:hover{
			cursor: pointer
		}
		svg{
			width: 1em;
			height: 1em;
		}
		#icons>svg{
			fill: var(--text-color);
			transform-origin: center;
		}
		[bg=star]{
			background-image: url('image/menu.png');
		}
	</style>
</head>
<body oncontextmenu='e=>false' bg=star>
	<div hide style=display:none id=icons>
		<!-- Icons -->
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" id=fa-map><path d="M384 476.1L192 421.2V35.93L384 90.79V476.1zM416 88.37L543.1 37.53C558.9 31.23 576 42.84 576 59.82V394.6C576 404.4 570 413.2 560.9 416.9L416 474.8V88.37zM15.09 95.13L160 37.17V423.6L32.91 474.5C17.15 480.8 0 469.2 0 452.2V117.4C0 107.6 5.975 98.78 15.09 95.13V95.13z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" id=fa-xmark><path d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-wrench><path d="M507.6 122.8c-2.904-12.09-18.25-16.13-27.04-7.338l-76.55 76.56l-83.1-.0002l0-83.1l76.55-76.56c8.791-8.789 4.75-24.14-7.336-27.04c-23.69-5.693-49.34-6.111-75.92 .2484c-61.45 14.7-109.4 66.9-119.2 129.3C189.8 160.8 192.3 186.7 200.1 210.1l-178.1 178.1c-28.12 28.12-28.12 73.69 0 101.8C35.16 504.1 53.56 512 71.1 512s36.84-7.031 50.91-21.09l178.1-178.1c23.46 7.736 49.31 10.24 76.17 6.004c62.41-9.84 114.6-57.8 129.3-119.2C513.7 172.1 513.3 146.5 507.6 122.8zM80 456c-13.25 0-24-10.75-24-24c0-13.26 10.75-24 24-24s24 10.74 24 24C104 445.3 93.25 456 80 456z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-plus><path d="M432 256c0 17.69-14.33 32.01-32 32.01H256v144c0 17.69-14.33 31.99-32 31.99s-32-14.3-32-31.99v-144H48c-17.67 0-32-14.32-32-32.01s14.33-31.99 32-31.99H192v-144c0-17.69 14.33-32.01 32-32.01s32 14.32 32 32.01v144h144C417.7 224 432 238.3 432 256z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-arrow-left><path d="M447.1 256C447.1 273.7 433.7 288 416 288H109.3l105.4 105.4c12.5 12.5 12.5 32.75 0 45.25C208.4 444.9 200.2 448 192 448s-16.38-3.125-22.62-9.375l-160-160c-12.5-12.5-12.5-32.75 0-45.25l160-160c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25L109.3 224H416C433.7 224 447.1 238.3 447.1 256z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-image><path d="M447.1 32h-384C28.64 32-.0091 60.65-.0091 96v320c0 35.35 28.65 64 63.1 64h384c35.35 0 64-28.65 64-64V96C511.1 60.65 483.3 32 447.1 32zM111.1 96c26.51 0 48 21.49 48 48S138.5 192 111.1 192s-48-21.49-48-48S85.48 96 111.1 96zM446.1 407.6C443.3 412.8 437.9 416 432 416H82.01c-6.021 0-11.53-3.379-14.26-8.75c-2.73-5.367-2.215-11.81 1.334-16.68l70-96C142.1 290.4 146.9 288 152 288s9.916 2.441 12.93 6.574l32.46 44.51l93.3-139.1C293.7 194.7 298.7 192 304 192s10.35 2.672 13.31 7.125l128 192C448.6 396 448.9 402.3 446.1 407.6z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-box><path d="M50.73 58.53C58.86 42.27 75.48 32 93.67 32H208V160H0L50.73 58.53zM240 160V32H354.3C372.5 32 389.1 42.27 397.3 58.53L448 160H240zM448 416C448 451.3 419.3 480 384 480H64C28.65 480 0 451.3 0 416V192H448V416z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-puzzle-piece><path d="M512 288c0 35.35-21.49 64-48 64c-32.43 0-31.72-32-55.64-32C394.9 320 384 330.9 384 344.4V480c0 17.67-14.33 32-32 32h-71.64C266.9 512 256 501.1 256 487.6C256 463.1 288 464.4 288 432c0-26.51-28.65-48-64-48s-64 21.49-64 48c0 32.43 32 31.72 32 55.64C192 501.1 181.1 512 167.6 512H32c-17.67 0-32-14.33-32-32v-135.6C0 330.9 10.91 320 24.36 320C48.05 320 47.6 352 80 352C106.5 352 128 323.3 128 288S106.5 223.1 80 223.1c-32.43 0-31.72 32-55.64 32C10.91 255.1 0 245.1 0 231.6v-71.64c0-17.67 14.33-31.1 32-31.1h135.6C181.1 127.1 192 117.1 192 103.6c0-23.69-32-23.24-32-55.64c0-26.51 28.65-47.1 64-47.1s64 21.49 64 47.1c0 32.43-32 31.72-32 55.64c0 13.45 10.91 24.36 24.36 24.36H352c17.67 0 32 14.33 32 31.1v71.64c0 13.45 10.91 24.36 24.36 24.36c23.69 0 23.24-32 55.64-32C490.5 223.1 512 252.7 512 288z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" id=fa-keyboard><path d="M512 448H64c-35.35 0-64-28.65-64-64V128c0-35.35 28.65-64 64-64h448c35.35 0 64 28.65 64 64v256C576 419.3 547.3 448 512 448zM128 180v-40C128 133.4 122.6 128 116 128h-40C69.38 128 64 133.4 64 140v40C64 186.6 69.38 192 76 192h40C122.6 192 128 186.6 128 180zM224 180v-40C224 133.4 218.6 128 212 128h-40C165.4 128 160 133.4 160 140v40C160 186.6 165.4 192 172 192h40C218.6 192 224 186.6 224 180zM320 180v-40C320 133.4 314.6 128 308 128h-40C261.4 128 256 133.4 256 140v40C256 186.6 261.4 192 268 192h40C314.6 192 320 186.6 320 180zM416 180v-40C416 133.4 410.6 128 404 128h-40C357.4 128 352 133.4 352 140v40C352 186.6 357.4 192 364 192h40C410.6 192 416 186.6 416 180zM512 180v-40C512 133.4 506.6 128 500 128h-40C453.4 128 448 133.4 448 140v40C448 186.6 453.4 192 460 192h40C506.6 192 512 186.6 512 180zM128 276v-40C128 229.4 122.6 224 116 224h-40C69.38 224 64 229.4 64 236v40C64 282.6 69.38 288 76 288h40C122.6 288 128 282.6 128 276zM224 276v-40C224 229.4 218.6 224 212 224h-40C165.4 224 160 229.4 160 236v40C160 282.6 165.4 288 172 288h40C218.6 288 224 282.6 224 276zM320 276v-40C320 229.4 314.6 224 308 224h-40C261.4 224 256 229.4 256 236v40C256 282.6 261.4 288 268 288h40C314.6 288 320 282.6 320 276zM416 276v-40C416 229.4 410.6 224 404 224h-40C357.4 224 352 229.4 352 236v40C352 282.6 357.4 288 364 288h40C410.6 288 416 282.6 416 276zM512 276v-40C512 229.4 506.6 224 500 224h-40C453.4 224 448 229.4 448 236v40C448 282.6 453.4 288 460 288h40C506.6 288 512 282.6 512 276zM128 372v-40C128 325.4 122.6 320 116 320h-40C69.38 320 64 325.4 64 332v40C64 378.6 69.38 384 76 384h40C122.6 384 128 378.6 128 372zM416 372v-40C416 325.4 410.6 320 404 320h-232C165.4 320 160 325.4 160 332v40C160 378.6 165.4 384 172 384h232C410.6 384 416 378.6 416 372zM512 372v-40C512 325.4 506.6 320 500 320h-40C453.4 320 448 325.4 448 332v40C448 378.6 453.4 384 460 384h40C506.6 384 512 378.6 512 372z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-gear><path d="M495.9 166.6C499.2 175.2 496.4 184.9 489.6 191.2L446.3 230.6C447.4 238.9 448 247.4 448 256C448 264.6 447.4 273.1 446.3 281.4L489.6 320.8C496.4 327.1 499.2 336.8 495.9 345.4C491.5 357.3 486.2 368.8 480.2 379.7L475.5 387.8C468.9 398.8 461.5 409.2 453.4 419.1C447.4 426.2 437.7 428.7 428.9 425.9L373.2 408.1C359.8 418.4 344.1 427 329.2 433.6L316.7 490.7C314.7 499.7 307.7 506.1 298.5 508.5C284.7 510.8 270.5 512 255.1 512C241.5 512 227.3 510.8 213.5 508.5C204.3 506.1 197.3 499.7 195.3 490.7L182.8 433.6C167 427 152.2 418.4 138.8 408.1L83.14 425.9C74.3 428.7 64.55 426.2 58.63 419.1C50.52 409.2 43.12 398.8 36.52 387.8L31.84 379.7C25.77 368.8 20.49 357.3 16.06 345.4C12.82 336.8 15.55 327.1 22.41 320.8L65.67 281.4C64.57 273.1 64 264.6 64 256C64 247.4 64.57 238.9 65.67 230.6L22.41 191.2C15.55 184.9 12.82 175.3 16.06 166.6C20.49 154.7 25.78 143.2 31.84 132.3L36.51 124.2C43.12 113.2 50.52 102.8 58.63 92.95C64.55 85.8 74.3 83.32 83.14 86.14L138.8 103.9C152.2 93.56 167 84.96 182.8 78.43L195.3 21.33C197.3 12.25 204.3 5.04 213.5 3.51C227.3 1.201 241.5 0 256 0C270.5 0 284.7 1.201 298.5 3.51C307.7 5.04 314.7 12.25 316.7 21.33L329.2 78.43C344.1 84.96 359.8 93.56 373.2 103.9L428.9 86.14C437.7 83.32 447.4 85.8 453.4 92.95C461.5 102.8 468.9 113.2 475.5 124.2L480.2 132.3C486.2 143.2 491.5 154.7 495.9 166.6V166.6zM256 336C300.2 336 336 300.2 336 255.1C336 211.8 300.2 175.1 256 175.1C211.8 175.1 176 211.8 176 255.1C176 300.2 211.8 336 256 336z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-wrench><path d="M507.6 122.8c-2.904-12.09-18.25-16.13-27.04-7.338l-76.55 76.56l-83.1-.0002l0-83.1l76.55-76.56c8.791-8.789 4.75-24.14-7.336-27.04c-23.69-5.693-49.34-6.111-75.92 .2484c-61.45 14.7-109.4 66.9-119.2 129.3C189.8 160.8 192.3 186.7 200.1 210.1l-178.1 178.1c-28.12 28.12-28.12 73.69 0 101.8C35.16 504.1 53.56 512 71.1 512s36.84-7.031 50.91-21.09l178.1-178.1c23.46 7.736 49.31 10.24 76.17 6.004c62.41-9.84 114.6-57.8 129.3-119.2C513.7 172.1 513.3 146.5 507.6 122.8zM80 456c-13.25 0-24-10.75-24-24c0-13.26 10.75-24 24-24s24 10.74 24 24C104 445.3 93.25 456 80 456z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-flask><path d="M437.2 403.5L319.1 215L319.1 64h7.1c13.25 0 23.1-10.75 23.1-24l-.0002-16c0-13.25-10.75-24-23.1-24H120C106.8 0 96.01 10.75 96.01 24l-.0002 16c0 13.25 10.75 24 23.1 24h7.1L128 215l-117.2 188.5C-18.48 450.6 15.27 512 70.89 512h306.2C432.7 512 466.5 450.5 437.2 403.5zM137.1 320l48.15-77.63C189.8 237.3 191.9 230.8 191.9 224l.0651-160h63.99l-.06 160c0 6.875 2.25 13.25 5.875 18.38L309.9 320H137.1z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-lock><path d="M80 192V144C80 64.47 144.5 0 224 0C303.5 0 368 64.47 368 144V192H384C419.3 192 448 220.7 448 256V448C448 483.3 419.3 512 384 512H64C28.65 512 0 483.3 0 448V256C0 220.7 28.65 192 64 192H80zM144 192H304V144C304 99.82 268.2 64 224 64C179.8 64 144 99.82 144 144V192z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-circle-up><path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256c141.4 0 256-114.6 256-256S397.4 0 256 0zM382.8 246.1C380.3 252.1 374.5 256 368 256h-64v96c0 17.67-14.33 32-32 32h-32c-17.67 0-32-14.33-32-32V256h-64C137.5 256 131.7 252.1 129.2 246.1C126.7 240.1 128.1 233.3 132.7 228.7l112-112c6.248-6.248 16.38-6.248 22.62 0l112 112C383.9 233.3 385.3 240.1 382.8 246.1z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-trash><path d="M135.2 17.69C140.6 6.848 151.7 0 163.8 0H284.2C296.3 0 307.4 6.848 312.8 17.69L320 32H416C433.7 32 448 46.33 448 64C448 81.67 433.7 96 416 96H32C14.33 96 0 81.67 0 64C0 46.33 14.33 32 32 32H128L135.2 17.69zM394.8 466.1C393.2 492.3 372.3 512 346.9 512H101.1C75.75 512 54.77 492.3 53.19 466.1L31.1 128H416L394.8 466.1z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-download><path d="M480 352h-133.5l-45.25 45.25C289.2 409.3 273.1 416 256 416s-33.16-6.656-45.25-18.75L165.5 352H32c-17.67 0-32 14.33-32 32v96c0 17.67 14.33 32 32 32h448c17.67 0 32-14.33 32-32v-96C512 366.3 497.7 352 480 352zM432 456c-13.2 0-24-10.8-24-24c0-13.2 10.8-24 24-24s24 10.8 24 24C456 445.2 445.2 456 432 456zM233.4 374.6C239.6 380.9 247.8 384 256 384s16.38-3.125 22.62-9.375l128-128c12.49-12.5 12.49-32.75 0-45.25c-12.5-12.5-32.76-12.5-45.25 0L288 274.8V32c0-17.67-14.33-32-32-32C238.3 0 224 14.33 224 32v242.8L150.6 201.4c-12.49-12.5-32.75-12.5-45.25 0c-12.49 12.5-12.49 32.75 0 45.25L233.4 374.6z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" id=fa-arrow-right><path d="M438.6 278.6l-160 160C272.4 444.9 264.2 448 256 448s-16.38-3.125-22.62-9.375c-12.5-12.5-12.5-32.75 0-45.25L338.8 288H32C14.33 288 .0016 273.7 .0016 256S14.33 224 32 224h306.8l-105.4-105.4c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0l160 160C451.1 245.9 451.1 266.1 438.6 278.6z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-circle-plus><path d="M0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256zM256 368C269.3 368 280 357.3 280 344V280H344C357.3 280 368 269.3 368 256C368 242.7 357.3 232 344 232H280V168C280 154.7 269.3 144 256 144C242.7 144 232 154.7 232 168V232H168C154.7 232 144 242.7 144 256C144 269.3 154.7 280 168 280H232V344C232 357.3 242.7 368 256 368z" /></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" id=fa-play><path d="M361 215C375.3 223.8 384 239.3 384 256C384 272.7 375.3 288.2 361 296.1L73.03 472.1C58.21 482 39.66 482.4 24.52 473.9C9.377 465.4 0 449.4 0 432V80C0 62.64 9.377 46.63 24.52 38.13C39.66 29.64 58.21 29.99 73.03 39.04L361 215z"/></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-arrows-rotate><path d="M464 16c-17.67 0-32 14.31-32 32v74.09C392.1 66.52 327.4 32 256 32C161.5 32 78.59 92.34 49.58 182.2c-5.438 16.81 3.797 34.88 20.61 40.28c16.89 5.5 34.88-3.812 40.3-20.59C130.9 138.5 189.4 96 256 96c50.5 0 96.26 24.55 124.4 64H336c-17.67 0-32 14.31-32 32s14.33 32 32 32h128c17.67 0 32-14.31 32-32V48C496 30.31 481.7 16 464 16zM441.8 289.6c-16.92-5.438-34.88 3.812-40.3 20.59C381.1 373.5 322.6 416 256 416c-50.5 0-96.25-24.55-124.4-64H176c17.67 0 32-14.31 32-32s-14.33-32-32-32h-128c-17.67 0-32 14.31-32 32v144c0 17.69 14.33 32 32 32s32-14.31 32-32v-74.09C119.9 445.5 184.6 480 255.1 480c94.45 0 177.4-60.34 206.4-150.2C467.9 313 458.6 294.1 441.8 289.6z"/></svg>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id=fa-pencil><path d="M421.7 220.3L188.5 453.4L154.6 419.5L158.1 416H112C103.2 416 96 408.8 96 400V353.9L92.51 357.4C87.78 362.2 84.31 368 82.42 374.4L59.44 452.6L137.6 429.6C143.1 427.7 149.8 424.2 154.6 419.5L188.5 453.4C178.1 463.8 165.2 471.5 151.1 475.6L30.77 511C22.35 513.5 13.24 511.2 7.03 504.1C.8198 498.8-1.502 489.7 .976 481.2L36.37 360.9C40.53 346.8 48.16 333.9 58.57 323.5L291.7 90.34L421.7 220.3zM492.7 58.75C517.7 83.74 517.7 124.3 492.7 149.3L444.3 197.7L314.3 67.72L362.7 19.32C387.7-5.678 428.3-5.678 453.3 19.32L492.7 58.75z"/></svg>
	</div>
	<div id=loading_cover cover bg=default style=z-index:100;display:flex;justify-content:center;>
		<svg xmlns="http://www.w3.org/2000/svg" style='position:absolute;top:calc(50% - 100px);width:150px;height:150px'
			viewBox='0 0 100 100'>
			<defs>
				<linearGradient id=gradient>
					<stop offset=0% stop-color=hsl(200,100%,90%,.2) />
					<stop offset=100% stop-color=hsl(200,100%,90%,1) />
				</linearGradient>
			</defs>
			<path fill=var(--text-color) d="m60,50c0,5.5 -4.5,10 -10,10c-5.5,0 -10,-4.5 -10,-10c0,-5.5 4.5,-10 10,-10c5.5,0 10,4.5 10,10z" />
			<path fill=url(#gradient) d="m73,50c0,-12.7 -10.3,-23 -23,-23s-23,10.3 -23,23m0.47001,0c0,-10.5 11.50746,-20.6493 22.10746,-20.6493s19.52254,10.1493 19.52254,20.6493" /></svg>
		<p style=position:absolute;font-size:25px;top:50%;font-family:sans-serif; text-shadow>Loading</p>
	</div>
	<input id=cli style=position:fixed;left:15px;bottom:15px;width:30%;height:30px;padding:0;margin:0;z-index:10 hide ofs=x>
	<ul lsn id=chat style=position:fixed;left:15px;bottom:50px;width:30%;height:fit-content;max-height:35%;background:#2225;padding:0;margin:0;z-index:9 nbs ofn ofs=y bw></ul>
	<div id=main cover bg=none center-flex>
		<img src=image/title.png plot=c,90px,475px,75px />
		<button class=sp plot=c,260px,350px,50px>Singleplayer</button>
		<button class=mp plot=c,360px,350px,50px>Multiplayer</button>
		<button class=options plot=c,460px,350px,50px>Options</button>
		<a class=exit href= /><button class=exit plot=c,560px,350px,50px>Exit</button></a>
		<p class=version style=position:fixed;right:2em;bottom:2em;width:fit-content;text-align:right>Loading Assets...
		</p>
	</div>
	<ul id=load hide lsn content ofs=y style=padding:2.5%>
		<button class=back plot=25px,b25px,125px,36px,a><svg><use href=#fa-arrow-left /></svg> Back</button>
		<button class=new plot=r25px,b25px,125px,36px,a><svg><use href=#fa-plus /></svg> New</button>
		<button class=refresh plot=r175px,b25px,125px,36px,a><svg><use href=#fa-arrows-rotate /></svg> Refresh</button>
	</ul>
	<div id=save hide content>
		<input placeholder="save name" class=name plot='c,50px,250px,2em,a'>
		<button class=back plot=c-75px,b62.5px,150px,36.6px,a><svg><use href=#fa-arrow-left /></svg> Back</button>
		<button class=new plot=50%,b62.5px,150px,36.6px,a>Start</button>
		<form name=worldgen bg=none plot=10%,20%,80%,50%,a>
			<input type=range name=difficulty label=Difficulty display='${{"0.5":"Easy","1":"Normal","1.5":"Hard","2":"<dfn style=\"font-style: normal;border-bottom:1px dotted var(--text-color)\" title=\"Disclaimer: Not yet limited to one life.\">Hardcore</dfn>"}[val]}' min=0.5 max=2 step=0.5 value=1><br><br>
		</form>
	</div>
	<div id=server hide content>
		<button class=back plot=c-75px,b62.5px,150px,36.6px,a><svg><use href=#fa-arrow-left /></svg> Cancel</button>
		<button class=save plot=50%,b62.5px,150px,36.6px,a>Save</button>
		<input placeholder='display name' class=name plot=c,c-3em,250px,2em,a>
		<input placeholder='server URL' class=url plot=c,c+3em,250px,2em,a>
	</div>
	<div id=connect hide content>
		<p plot=c,c-2em,75%,1em style=text-align:center></p>
		<button plot=c,c+2em,100px,2em class=back>Cancel</button>
	</div>
	<p hide id=mp_message plot=c,c-2em,300px,1em>
		Multiplayer is not properly implemented yet.<br>
		Feel free to test chat or commands (T).<br>
		Use the pause menu (Esc) to disconnect.<br>
		Thanks!
	</p>
	<div id=tablist hide plot=c,0,100px,100px>
		<p class=url plot=c,1em,fit-content,1em,a></p>
		<p class=players plot=c,2em,fit-content,1em,a></p>
	</div>
	<dialog id=modal style=width:350px;height:8em>
		<p class=info plot=c,c-2em,300px,1em,a style=text-align:center></p>
	</dialog>
	<div id=e content hide game-ui style=z-index:5 tabindex=-1>
		<div id=nav bg=none plot=5%,25px,90%,45px,a>
			<button class=inv plot=c-300px,5px,175px,35px,a><svg><use href=#fa-box /></svg> Items</button>
			<button class=screenshots plot=c-100px,5px,175px,35px,a><svg><use href=#fa-image /></svg> Screenshots</button>
			<button classs=map plot=c-100px,5px,175px,35px,a hide><svg><use href=#fa-map /></svg> Map</button>
			<button class=yrd plot=c+100px,5px,175px,35px,a><svg><use href=#fa-wrench /></svg> Shipyard</button>
			<button class=lab plot=c+300px,5px,175px,35px,a><svg><use href=#fa-flask /></svg> Lab</button>
		</div>
		<div class=inv ofs=y bg=none style='display:grid;grid-auto-rows:3em;grid-template-columns:1fr 1fr;column-gap: 10px'></div>
		<div class=map ofs=y bg=none style='display:grid;grid-auto-rows:3em;grid-template-columns:1fr 1fr;column-gap: 10px'><p>Coming Soon!</p></div>
		<div class=screenshots bg=none ofs=y style='display:grid;grid-auto-rows:144px;grid-template-columns:repeat(auto-fill,256px);gap:1em;'></div>
		<div class=yrd ofs=y bg=none style='display:grid;grid-auto-rows:3em;grid-template-columns:1fr 2fr 1fr;column-gap: 10px'></div>
		<div class=lab ofs=y bg=none style='display:grid;grid-auto-rows:3em;grid-template-columns:1fr 2fr 1fr;column-gap: 10px'></div>
	</div>
	<div id=q content hide game-ui style=z-index:5 tabindex=-1>
		<center>
			<h3>In-system movement</h3>
			<p>Select a planet you want to go to. Press go wil change your rotation to face the planet.<br>Pressing lock will toggle locking your rotation facing the planet<br></p>
			<select label="Go To: " name=move class=move></select><button style=margin:1% class=move>Go</button>
			<h3>Hyperspace</h3>
			<input label="Warp To: " class="warp x" maxlength=4 style=width:50px><input class="warp y" maxlength=4 style=width:50px><button style=margin:1% class=warp>Warp</button>
		</center>
	</div>
	<canvas class=game hide cover style=z-index:0></canvas>
	<div id=debug bg=none hide cover style=width:fit-content>
		<p style=left:1%;top:0 class=left></p>
		<p style=right:1%;top:0;text-align:right class=right></p>
	</div>
	<div id=hud hide bg=none>
		<p class=level plot=c,b1em,150px,1em style=text-align:center;line-height:3em></p>
		<p class=rcs plot=1em,100px,150px,50px bg=trans style=text-align:center;line-height:50px;font-size:20px>RCS: ON
		</p>
		<svg class=xp plot=c,b1em,300px,1em viewBox='0 0 300 16' border>
			<rect fill=var(--button-color) x=0 y=0 width=0 height=100%></rect>
		</svg>
	</div>
	<div id=hud_ship hide bg=none>
		<svg class=lock style=position:fixed;right:2%;top:2.5%;><use href=#fa-lock /></svg>
		<svg class=upgrade style=position:fixed;right:2%;top:55%;font-size:20px;><use href=#fa-circle-up /></svg>
	</div>
	<div id=esc hide cover bg=none tabindex=-1>
		<div class=content plot=c,c,250px,300px style=z-index:10>
			<button plot=12.5px,62.5px,225px,50px,a class=resume>Resume&nbsp;Game</button>
			<button plot=12.5px,125px,225px,50px,a class=save>Save&nbsp;Game</button>
			<button plot=12.5px,187.5px,225px,50px,a class=options>Options</button>
			<button plot=12.5px,250px,225px,50px,a class=quit>Main&nbsp;Menu</button>
		</div>
	</div>
	<div id=settings hide content>
		<button plot=50px,50px,135px,35px,a class=gen><svg><use href=#fa-gear /></svg> General</button>
		<button plot=50px,100px,135px,35px,a class=key><svg><use href=#fa-keyboard /></svg> Keybinds</button>
		<button plot=50px,150px,135px,35px,a class=mod hide><svg><use href=#fa-puzzle-piece /></svg> Mods</button>
		<button plot='50px,calc(100% - 85px),135px,35px,a' class=back><svg><use href=#fa-arrow-left /></svg> Back</button>
		<form class=gen name=settings nbs bg=none ofs=y>
			<h2 style=text-align:center>Settings - General</h2>
			<input type=range name=font_size label="Font Size" display=${val}px min=10 max=20 step=1 value=13><br><br>
			<input type=range name=chat label="Chat Timeout" display='${val} seconds' min=5 max=15 step=1 value=10><br><br>
			<input type=range name=sensitivity label="Camera Sensitivity" display=${(val*100).toFixed()}% min=0.1 max=2 step=0.05 value=1><br><br>
			<input type=range name=music label="Music Volume" display=${(val*100).toFixed()}% min=0 max=1 step=0.05 value=1><br><br>
			<input type=range name=sfx label="Sound Effect Volume" display="${(val*100).toFixed()}%" min=0 max=1 step=0.05 value=1><br><br>
			<input type=range name=render_quality label='Render Quality' display="${['Low','Medium','High'][val]}" min=0 max=2 step=1 value=1><br><br>
			<input type=checkbox name=debug_tooltips label="Show Advanced Tooltips" value=true><br><br>
			<input type=hidden name=debug_tooltips value=false>
			<input type=range name=gui_scale label="GUI Scale" display="${['auto','small','normal','large'][val]}" min=0 max=3 step=1 value=0><br><br>
			<input type=range name=mesh_quality label='Mesh Quality' display='${{"32":"Low","64":"Low","96":"Low","128":"Normal","160":"Normal","196":"High","224":"High","256":"<dfn style=\"font-style: normal;border-bottom:1px dotted var(--text-color)\" title=\"Intended for high-end computers\">Ultra</dfn>"}[val]}' min=32 max=256 step=32 value=64>
		</form>
		<form class=key name=keybind nbs bg=none ofs=y hide>
			<h2 style=text-align:center>Settings - Keybinds</h2>
		</form>
		<ul class=dp nbs bg=none ofs=y hide lsn></ul>
		<ul class=mod nbs bg=none ofs=y hide lsn></ul>
	</div>
</body>
<script class=jquery src=/libraries/jquery.js></script>
<script class=babylon src=/libraries/babylon/5.2.0.js></script>
<script class=loaders src=/libraries/babylon/loaders.js></script>
<script class=materials src=/libraries/babylon/materials.js></script>
<script class=socketio src=/libraries/socket.io/4.5.0.js></script>
<script class=game async defer>
	const skybox_image = 'image/skybox.jpg';

	const web = url => `https://blankstorm.drvortex.dev/` + url,
	upload = (type, multiple = false) => new Promise(res => $(`<input type=file ${type ? `accept='${type}'` : ''} ${multiple?'multiple':''}>`).change(e => res([...e.target.files]))[0].click()),
	download = (data, name) => $(`<a href=${URL.createObjectURL(new Blob([data]))} download=${name}></a>`)[0].click(),
	isJSON = str => {
		try {
			JSON.parse(str);
			return true
		} catch (e) {
			return false
		}
	},
	isHex = str => /^[0-9a-f]+$/.test(str),
	isInt = num => +num == Math.round(+num);

	const MediaType = class{
		constructor(string){
			['type','sub','suffix','parameter'].map((k,i) => this[k] = string.split(/\/|\+|;/)[i]);
			
		}
	};
	const modal = (input = 'Are you sure?', options = {No: false, Yes: true}) => new Promise(res => {
		if(typeof input == 'object'){
			$('#modal p.info').html(Object.entries(input).reduce((a, [name, text]) => a + `<input name=${name} placeholder='${text}'>`, ''));
		}else{
			$('#modal p.info').text(input);
		}
		$('#modal')[0].showModal();
		Object.entries(options).forEach(([displayText, result], i, a) => {
			$(`<button></button>`)
				.attr('plot', a.length == 2 ? `c${i ? `+` : `-`}50px,c+2em,100px,2em` : `c,c+2em,100px,2em`)
				.text(displayText)
				.appendTo('#modal')
				.click(e => {
					$('#modal')[0].close();
					$('#modal button').remove();
					if(typeof input == 'object'){
						let resultObj = {result};
						$('#modal p.info input').each((i, e) => {
							resultObj[e.name] = e.value;
						});
						res(resultObj);
					}else{
						res(result);
					}
				});
		});
		ui.update();
	});
	
	Object.defineProperties(Object.prototype, {
		hide: {
			value: function (...p) {
				for (let i of p) {
					Object.defineProperty(this, i, { enumerable: false })
				}
			}
		},
		freezeProperty: {
			value: function (...p) {
				for (let i of p) {
					Object.defineProperty(this, i, { writable: false })
				}
			}
		},
		getByString: {
			value: function (path, seperator) {
				return path
				.split(seperator || /[\.\[\]\'\"]/)
				.filter(p => p)
				.reduce((o, p) => o ? o[p] : null, this)
			}
		},
		setByString: {
			value: function(path, value, seperator){
				return path
				.split(seperator || /[\.\[\]\'\"]/)
				.filter(p => p)
				.reduce((o, p, i) => o[p] = path.split(seperator || /[\.\[\]\'\"]/).filter(p => p).length === ++i ? value : (o[p] || {}), this);
			}
		}
	});

	Object.prototype.toString = function () { return JSON.stringify(this) };
	Math._log = Math.log;
	Math.log = (num, base = Math.E) => Math._log(num)/Math._log(base);
	
	Object.assign(window, BABYLON);

	Object.assign(Vector3.prototype, {
		abs: function(){return new Vector3(Math.abs(this.x), Math.abs(this.y), Math.abs(this.z))},
		toFixed: function(num = 1){return new Vector3(this.x.toFixed(num), this.y.toFixed(num), this.z.toFixed(num))},
		toPolar: function(){return Math.sqrt(this.x ** 2 + this.y ** 2 + this.z ** 2)},
		display: function(mode = 'xyz', ...options){
			return mode == 'xyz' ? `(${this.x}, ${this.y}, ${this.z})` :
			mode == 'xy' ? `(${this.x}, ${this.y})` :
			mode == 'xz' ? `(${this.x}, ${this.z})` :
			mode == 'yz' ? `(${this.y}, ${this.z})` :
			new SyntaxError('Vector3().display: Invalid mode: ' + mode);
		},
		worldToScreen: function(scene = game.scene()){
			return Vector3.Project(this, Matrix.Identity(), scene.getTransformMatrix(), new Viewport(0, 0, width, height));
		}
	});
	Vector2.prototype.display = function(){
		return `(${this.x}, ${this.y})`;
	};

	//JQuery plugins
	$.fn.formData = function(data){
		if (data) {
			for (let i in data) {
				this.find(`[name=${i}]`).each((a, e) => { e.type == "checkbox" ? e.checked = data[i] : e.value = data[i] })
			}
			return this
		} else {
			let formData = Object.fromEntries(new FormData(this[0]));
			for(let i in formData){
				if(+formData[i] == formData[i]){
					formData[i] = +formData[i];
				}
				if(formData[i] === 'true' || formData[i] == 'on'){
					formData[i] = true;
				}
				if(formData[i] === 'false'){
					formData[i] = false;
				}
			}
			return formData;
		}
	};
	$.fn.tooltip = function (info = "") {
		this.off('mouseenter mouseleave');
		let id = rand.hex(32), tooltip = $(`<div class=tooltip></div>`)
			.css({ position: "fixed", width: "fit-content", height: "fit-content", "max-width": "15%", "z-index": 9, "font-size": settings.font_size, "font-family": "sans-serif" })
			.attr('tooltip-for', id);
		this
			.attr('tooltip-id', id)
			.mouseenter(e => {
				$(`[tooltip-for=${id}]`).remove();
				tooltip
				.html(typeof info == 'function' ? info(tooltip) : info)
				.css({ left: settings.font_size + mouse.x, top: settings.font_size + mouse.y });
				this.attr('tooltip-active', true).parent().append(tooltip);
				let computed_style = getComputedStyle(tooltip[0]);
				tooltip.css({
					left: (settings.font_size + mouse.x + parseFloat(computed_style.width) < width) ? settings.font_size + mouse.x : settings.font_size + mouse.x - parseFloat(computed_style.width),
					top: (settings.font_size + mouse.y + parseFloat(computed_style.height) < height) ? settings.font_size + mouse.y : settings.font_size + mouse.y - parseFloat(computed_style.height)
				})
			})
			.mouseleave(e => { tooltip.remove(); this.removeAttr('tooltip-active') });
		return this
	};
	$.fn.cm = function(...content){
		content ||= [$("<p></p>")];
		let menu = $("<div bg=light class=cm></div>");
		for (let c of content) { menu.append(c) }
		menu.css({ position: "fixed", width: "fit-content", height: "fit-content", "max-width": "15%", "z-index": 9, "font-size": settings.font_size, "font-family": "sans-serif" });
		this.contextmenu(e => {
			menu.css({ left: settings.font_size + mouse.x, top: settings.font_size + mouse.y });
			this.parent().append(menu);
			menu.css({ top: (settings.font_size + mouse.y + parseFloat(getComputedStyle(menu[0]).height) < height) ? settings.font_size + mouse.y : settings.font_size + mouse.y - parseFloat(getComputedStyle(menu[0]).height) })
		});
		return this
	}
	$.fn.aspect = function(){
		let css = getComputedStyle(this[0]);
		return `(x: ${css.left}, y: ${css.top})\n${css.width} x ${css.height} = ${parseFloat(css.width) / parseFloat(css.height)}`
	}
	let time = 0;
	const cookie = {},
	query = {},
	key = { pressed: false },
	width = innerWidth,
	height = innerHeight,
	mouse = { x: 0, y: 0, pressed: false },
	trigger = event => { dispatchEvent(event) },
	playsound = (url, vol) => { let a = new Audio(url); a.volume = vol || 1; a.play() },
	date = new Date();
	onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY };
	document.cookie.split("; ").forEach(e => { cookie[e.split("=")[0]] = e.split("=")[1] });
	new URLSearchParams(location.search).forEach((v, k) => query[k] = v);
	setInterval(() => { time += 10 }, 10);

	const pi = Math.PI, phi = 1.618033988749894, G = 6.67 * (10 ** -11),
		clamp = (num, min, max) => Math.min(Math.max(num, min), max),
		rand = {
			get real() { return Math.random() },
			float: (min = 0, max = 1) => Math.random() * (max - min) + min,
			hex: (length = 1) => { let s = ""; for (let i = 0; i < length; i++) { s += Math.floor(Math.random() * 16).toString(16) } return s; },
			get bool() { return Math.round(Math.random()) ? true : false },
			bin: (length = 1) => { let b = ""; for (let i = 0; i < length; i++) { b += Math.round(Math.random()) } return b; },
			int: (min = 0, max = 1) => Math.round(Math.random() * (max - min) + min),
			char: (len = 1, min = 33, max = 126) => { let s = ''; for (let i = 0; i < len; i++) { s += String.fromCharCode(rand.int(min, max)) }; return s },
			cords: (dis = 1, y0) => {
				let angle = Math.random() * pi * 2, angle2 = Math.random() * pi * 2;
				return y0 ? new Vector3(dis * Math.cos(angle), 0, dis * Math.sin(angle)) : new Vector3(dis * Math.cos(angle), dis * Math.sin(angle) * Math.cos(angle2), dis * Math.sin(angle) * Math.sin(angle2))
			},
		},
		greek = ["Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Eta", "Theta", "Iota", "Kappa", "Lambda", "Mu", "Nu", "Xi", "Omicron", "Pi", "Rho", "Sigma", "Tau", "Upsilon", "Phi", "Chi", "Psi", "Omega"],
		numeral = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII", "XIII", "XIV", "XV", "XVI", "XVII", "XVIII", "XIX", "XX", "XXI", "XXII", "XXIII", "XXIV", "XXV", "XXVII", "XXVII", "XXVIII", "XXIX", "XXX", "XXXI", "XXXII", "XXXIII", "XXXIV", "XXXV", "XXXVI", "XXXVII", "XXXVIII", "XXXIX", "XL", "XLI", "XLII", "XLIII", "XLIV", "XLV", "XLVI", "XLVII", "XLVIII", "XLIX", "L", "LI", "LII", "LIII", "LIV", "LV", "LVI", "LVII", "LVIII", "LIX", "LX", "LXI", "LXII", "LXIII", "LXIV", "LXV", "LXVI", "LXVII", "LXVIII", "nice", "LXX", "LXXI", "LXXII", "LXXIII", "LXXIV", "LXXV", "LXXVI", "LXXVII", "LXXVIII", "LXXIX", "LXXX", "LXXXI", "LXXXII", "LXXXIII", "LXXXIV", "LXXXV", "LXXXVI", "LXXXVII", "LXXXVIII", "LXXXIX", "XC", "XCI", "XCII", "XCIII", "XCIV", "XCV", "XCVI", "XCVII", "XCVIII", "XCIX", "C"],
		minimize = number => {
			let n = number, l = ["", "K", "M", "B", "T", "q", "Q", "s", "S", "O", "N", "D"];
			if (typeof n != "number") { n = (+n) }
			if (n < 0 || n > (+`1e${(l.length - 1) * 3}`)) return n
			for (let i = 0; i < l.length; i++) {
				let d = (+`1e${i * 3}`);
				if (n / d < 1000) { return ((n / d).toFixed() + l[i]) }
			}
		},
		range = (min, max) => { let a = []; for (let i = min; i < max; i++) { a.push(i) } return a };
	

	Mesh.sizeOf = mesh => {
		if (typeof mesh.getHierarchyBoundingVectors != 'function') throw new TypeError('parameter is not a Mesh');
		const sizes = mesh.getHierarchyBoundingVectors();
		return sizes.max.subtract(sizes.min);
	};
	
	let settings = $("form.gen").formData(),
	worldgen = $("#save form").formData(),
	keybind = {};
	const servers = new Map(),
	saves = new Map(),
	sound = {
		rift: 'music/rift.mp3',
		planets: 'music/planets.mp3',
		destroy_ship: 'sfx/destry_ship.mp3',
		warp_start: 'sfx/warp_start.mp3',
		warp_end: 'sfx/warp_end.mp3',
		laser_fire: 'sfx/laser_fire.mp3',
		laser_hit: 'sfx/laser_hit.mp3',
		ui: 'sfx/ui.mp3'
	},
	item = {},
	tech = {};

	const game = {
		canvas: $('canvas.game'),
		engine: new Engine($("canvas.game")[0], true, { preserveDrawingBuffer: true, stencil: true }),
		version: 'infdev_10',
		versions: new Map([
			['infdev_1', {text: 'Infdev 1', group: 'infdev'}],
			['infdev_2', {text: 'Infdev 2', group: 'infdev'}],
			['infdev_3', {text: 'Infdev 3', group: 'infdev'}],
			['infdev_4', {text: 'Infdev 4', group: 'infdev'}],
			['infdev_5', {text: 'Infdev 5', group: 'infdev'}],
			['infdev_6', {text: 'Infdev 6', group: 'infdev'}],
			['infdev_7', {text: 'Infdev 7', group: 'infdev'}],
			['infdev_8', {text: 'Infdev 8', group: 'infdev'}],
			['infdev_9', {text: 'Infdev 9', group: 'infdev'}],
			['infdev_10', {text: 'Infdev 10', group: 'infdev'}],
		]),
		screenshots: [],
		mods: new Map(),
		function: {},
		entityModels: new Map(),
		frames: 0,
		isPaused: true,
		mp: false,
		mpEnabled: false,
		hitboxes: false,
		difficulty: 1,
		createKeybind: (name, val, label, onTrigger) => {
			keybind[name] = val;
			$('#settings form.key').append(
				$(`<label>${label}&nbsp;&nbsp;</label>`).attr('for', 'keybind.' + name),
				$(`<button !sub name=${name}></button><br><br>`)
					.text(keybind[name]).click(function(e){ e.preventDefault(); $(this).focus() })
					.on('keydown', function(e){ e.preventDefault(); keybind[this.name] = e.key; $(this).text(keybind[this.name]) })
			);
			$('canvas.game,[ingame-ui],#hud,#hud_ship,#tablist').keydown(e => { if (e.key == val) onTrigger(e) });
		},
		getEntity: sel => {
			if (typeof sel != 'string') throw new TypeError('getEntity: selector must be of type string');
			if (typeof saves.sel != 'string') throw new TypeError('getEntity: you must have a save selected');
			switch (sel[0]) {
				case '@':
					return (sel.slice(1) == player.username || sel.slice(1) == player.id) ? player :
						new ReferenceError('getEntity: multi-player entity selection not implemented');
					break;
				case '*':
					return [...saves.get(saves.sel).entities.values()];
					break;
				case '#':
					if(saves.get(saves.sel).entities.has(sel.slice(1))){
						return saves.get(saves.sel).entities.get(sel.slice(1))
					}else{
						console.warn(`Entity ${sel} does not exist`);
					}
					break;
			}
		},
		removeEntity: (...args) => {
			for(let e of args){
				let id = [...saves.get(saves.sel).entities].find(en => en[1] == e)?.[0];
				if(e instanceof Entity && id){
					e.remove();
					saves.get(saves.sel).entities.delete(id);
					for(let i in saves.get(saves.sel).levels){
						for(let [id, body] of saves.get(saves.sel).levels[i].bodies){
							if(body.fleet.includes(e)) body.fleet.splice(body.fleet.indexOf(e), 1);
						};
					};
				}
				else{
					console.warn(`Can't remove ${e?.name}: not an entity or does not exist`);
				}
				if (player.data().fleet.includes(e)) player.data().fleet.splice(player.data().fleet.indexOf(e), 1);
			}
		},
		getBody: sel => {
			if (typeof sel != 'string') throw new TypeError('getBody: selector must be of type string');
			if (typeof saves.sel != 'string') throw new TypeError('getBody: you must have a save selected');
			switch (sel[0]) {
				case '*':
					let total = [];
					for(let i in saves.get(saves.sel).levels){
						total.push(...saves.get(saves.sel).levels[i].bodies.values())
					}
					return total
					break;
				case '#':
					for(let i in saves.get(saves.sel).levels){
						for(let [id, body] of saves.get(saves.sel).levels[i].bodies){
							if(id == sel.slice(1)) return body;
						}
					};
					break;
			}
		},
		removeBody: (...args) => {
			for(let body of args){
				if(body instanceof CelestialBody){
					for(let i in saves.get(saves.sel).levels){
						saves.get(saves.sel).levels[i].bodies.delete(id);
					};
				}
				else{
					console.warn(`Can't remove ${body?.name}: not a CelestialBody`);
				}	
			}
		},
		cli: { line: 0, currentInput: "", i: $("#cli").val(), prev: [] },
		scene: location => {
			if (location instanceof Vector2 || location == undefined) {
				return saves.get(saves.sel)?.levels[location instanceof Vector2 ? location.asArray() : game.currentLevel.asArray()] || game.scene.default;
			} else {
				throw new TypeError('Passed location must be a Vector2 or undefined.');
			}

		},
		get currentLevel() { return saves.get(saves.sel) ? saves.get(saves.sel).currentLevel : Vector2.Zero() },
		set currentLevel(val) { return saves.get(saves.sel) ? saves.get(saves.sel).currentLevel = val : console.warn('Tried to set currentLevel without a valid save') },
		saveSettings: () => {
			let settingsStore = db.transaction('settings', 'readwrite').objectStore('settings');
			settings = $("form.gen").formData();
			settingsStore.put(settings, 'general');
			settingsStore.put(keybind, 'keybinds');
		},
		commands: {
			help: name => {
				open(web('docs/commands' + (name ? '#' + name : '')), 'target=_blank');
			},
			function: name => {
				if (game.function[name] && !game.function[name].includes('function ' + name)) {
					game.function[name].split('\n').forEach(game.runCommand);
				} else if (game.function[name].includes('function ' + name)) {
					throw new SyntaxError(`can not run function "${name}": functions can not run themselves`);
				} else {
					throw new ReferenceError(`function "${name}" does not exist`);
				}
			},
			kill: selector => {
				let e = game.getEntity(selector);
				if(e.constructor.name == 'Array'){
					game.removeEntity(...e);
					return `killed ${e.length} entities`;
				}else{
					game.removeEntity(e);
					return `killed entity #${e.id} ("${e.name}")`;
				}
			},
			spawn: (type, selector, x, y, z) => {
				let faction = game.getEntity(selector),
				fleet = faction == player ? faction.data().fleet : faction.fleet,
				spawned = new Ship(type, faction, faction == player ? saves.get(saves.sel) : undefined);
				spawned.addToScene(game.scene());
				spawned.position = parseFloat(x) == x && parseFloat(y) == y && parseFloat(z) == z ? new Vector3(parseFloat(x), parseFloat(y), parseFloat(z)) : faction.fleetLocation;
			},
			data: {
				get: {
					entity: (selector, path = '') => {
						let entity = game.getEntity(selector);
						if(entity instanceof Array){
							throw new SyntaxError('passed selector can only return one entity');
						}else{
							let entityData = (entity == player ? entity.data() : entity).getByString(path),
								entityName = entity == player ? '@' + entity.username : '#' + entity.id,
								data = entityData;
							if (typeof entityData == 'object' || typeof entityData == 'function') {
								data = {};
								for (let p of Object.getOwnPropertyNames(entityData)) {
									data[p] = entityData[p];
								}
							}
							return `Data of entity ${entityName}: ${data}`
						}
					},
					object: (selector, path = '') => {
						let object = game.getBody(path);
						if(object instanceof Array){
							throw new SyntaxError('passed selector can only return one object');
						}else{
							let objectData = object.getByString(path), data = objectData;
							if(typeof objectData == 'object' || typeof objectData == 'function'){
								data = {};
								for(let p of Object.getOwnPropertyNames(objectData)){
									data[p] = objectData[p];
								}
							}
							return `Data of object #${object.id}: ` + data;
						}
					}
				},
				set: {
					entity: (selector, path, value) => {
						let entity = game.getEntity(selector);
						if(entity instanceof Array){
							throw new SyntaxError('passed selector can only return one entity');
						}else{
							(entity == player ? entity.data() : entity).setByString(path, eval?.(value));
						}
					},
					object: (selector, path, value) => {
						let object = game.getBody(selector);
						if (object instanceof Array) {
							throw new SyntaxError('passed selector can only return one object');
						} else {
							object.setByString(path, eval?.(value));
						}
					}
				}
			},
			tp: (selector, x, y, z) => {
				let entities = game.getEntity(selector),
					location = new Vector3(+x || player.position.x, +y || player.position.y, +z || player.position.z);
				if (entities instanceof Array) {
					entities.forEach(entity => {
						entity.position = location;
						//TODO: properly implement with checks for ships
					});
					return `Teleported ${entities.length} to ${location.display()}`;
				} else {
					entities.position = location;
					return `Teleported entities #${entities.id} to ${location.display()}`;
				}
			},
			player: {
				stop: () => {
					player.stop();
				},
				reset: () => {
					player.reset();
				},
				wipe: () => {
					player.reset();
					player.wipe();
				}
			},
			warp: {
				start: (x, y) => {
					warp.start(new Vector2(parseFloat(x || 0), parseFloat(y || 0)));
				},
				end: (...args) => {
					warp.end(...args);
				},
				to: (x, y, ...args) => {
					warp.start(new Vector2(parseFloat(x || 0), parseFloat(y || 0)));
					warp.end(...args);
				}
			},
			playsound: (name, volume = settings.sfx) => {
				if (sound[name]) {
					playsound(name, volume)
				} else {
					throw new ReferenceError(`sound "${name}" does not exist`)
				}
			},
			reload: () => {
				//maybe also reload mods in the future
				game.engine.resize();
				game.scene().render();
			}
		},
		runCommand: (command) => {
				if(game.mp){
					servers.get(servers.sel).socket.emit('command', command);
				}else{
					if (saves.sel && saves.get(saves.sel) instanceof Save) {
						let commands = command.split(' '), hasRun = false;
						let result = (commands.filter(p => p).reduce((o, p, i) => typeof o?.[p] == 'function' ? (hasRun = true, o?.[p](...commands.slice(i + 1))) : hasRun ? o : o?.[p] ? o?.[p] : new ReferenceError('Command does not exist'), game.commands) ?? '');
						return result;
					} else {
						throw new ReferenceError('Can not run command, no save is selected');
					}
				}
		},
		chat: (...msg) => { for (let m of msg) { let i = $(`<li>${m}</li>`).appendTo($("#chat")); setTimeout(e => { i.fadeOut(2000, e => { i.remove() }) }, settings.chat * 1000) } },
		error: (error, alrt) => { console.error(error); game.chat("Error: " + error) },
		changeUI: (selector, hideAll) => {
			if ($(selector).is(':visible')) {
				game.canvas.focus();
				game.canvas[0].requestPointerLock();
				$(selector).hide();
			} else if ($('[game-ui]').not(selector).is(':visible') && hideAll) {
				game.canvas.focus();
				game.canvas[0].requestPointerLock();
				$('[game-ui]').hide();
			} else if (!$('[game-ui]').is(':visible')) {
				document.exitPointerLock();
				$(selector).show().focus();
			}
		}
	};
	const Entity = class extends TransformNode{
		static generic = new Map();
		static loadType(data){
			Entity.generic.set(data.id, {
				...data,
				model: null
			});
		}
		constructor(save){
			let id = rand.hex(32);
			super(id, save.levels[save.currentLevel]);
			this.id = id;
			this.meshes = new Map();
			this.instances = new Map();
			if(save instanceof Save) save.entities.set(this.id, this);
		}
		addToScene(scene = game.scene()){
			if (!scene instanceof Level) throw new TypeError('passed scene must be a level');
			if(typeof scene.genericEntities[this.type]?.instantiateModelsToScene == 'function'){
				let instance = scene.genericEntities[this.type].instantiateModelsToScene();
				instance.id = `${this.id}.${rand.hex(4)}`;
				this.instances.set(scene.id, instance);
				this.meshes.set(scene.id, instance.rootNodes[0]);
			}else{
				console.warn(`Can't add entity to scene: genericEntity for type does not exist`);
			}

		}
		removeFromScene(scene = game.scene()){
			this.meshes.get(scene.id).dispose();
		}
		remove(){
			this.meshes.forEach(mesh => mesh.dispose());
		}
		mesh(scene = game.scene()){
			return this.meshes.get(scene.id);
		}
		toString(){
			return `Entity #${this.id}`
		}
	}
	const CelestialBody = class extends Mesh {
		getSave(){
			return this._save;
		}
		constructor(name, scene) {
			let id = rand.hex(32);
			super(name, scene);
			Object.assign(this, {
				id: id,
				fleetLocation: Vector3.Zero(),
				fleet: [],
				owner: null,
				_save: scene.getSave()
			});
			scene ? scene.bodies.set(id, this) : console.warn('CelestialBody(): scene passed without "bodies" property');
		}
	}
	const CelestialBodyMaterial = class extends ShaderMaterial{
		static updateRandom(texture){
			if(!(texture instanceof DynamicTexture)) throw new TypeError(`Can't update texture: not a dynamic texture`);
			let context = texture.getContext(),

        	imageData = context.getImageData(0, 0, 512, 512);

			for(let i = 0; i < 1048576; i++){
				imageData.data[i] = (Math.random() * 256) | 0
			}
			context.putImageData(imageData, 0, 0);
        	texture.update();
		}
		constructor(options, scene){
			options.mapSize = 1024;
			options.maxResolution = [64, 256, 1024][settings.render_quality];
			let id = rand.hex(8);
			super('CelestialBodyMaterial#' + id, scene, './shader/planet', {
				attributes: ["position", "normal", "uv"],
				uniforms: ["world", "worldView", "worldViewProjection", "view", "projection"],
				needAlphaBlending: true
			});
			this.generationOptions = options;
			this.rotationFactor = Math.random();
			this.matrixAngle = 0;
			
			this.noiseSampler = new DynamicTexture('CelestialBodyMaterial.randomSampler#' + id, 512, scene, false, Texture.NEAREST_SAMPLINGMODE);
			this.cloudSampler = new DynamicTexture('CelestialBodyMaterial.randomSampler#' + id, 512, scene, false, Texture.NEAREST_SAMPLINGMODE);
		
			this.setVector3('cameraPosition', player.cam.position);
			this.setVector3('lightPosition', Vector3.Zero());

			CelestialBodyMaterial.updateRandom(this.noiseSampler);
			CelestialBodyMaterial.updateRandom(this.cloudSampler);

			this.noiseTexture = new ProceduralTexture('noise', options.mapSize, './shader/noise', scene, null, true, true);
			this.noiseTexture.setColor3('upperColor', options.upperColor);
			this.noiseTexture.setColor3('lowerColor', options.lowerColor);
			this.noiseTexture.setFloat('mapSize', options.mapSize);
			this.noiseTexture.setFloat("maxResolution", options.maxResolution);
			this.noiseTexture.setFloat("seed", options.seed);
			this.noiseTexture.setVector2("lowerClamp", options.lowerClamp);
			this.noiseTexture.setTexture("randomSampler", this.noiseSampler);
			this.noiseTexture.setVector2("range", options.range);
			this.noiseTexture.setVector3("options", new Vector3(options.directNoise ? 1.0 : 0, options.lowerClip.x, options.lowerClip.y));
			this.noiseTexture.refreshRate = 0;

			this.setTexture("textureSampler", this.noiseTexture);

			// Cloud
			this.cloudTexture = new ProceduralTexture("cloud", options.mapSize, "./shader/cloud", scene, null, true, true);
			this.cloudTexture.setTexture("randomSampler", this.cloudSampler);
			this.cloudTexture.setFloat("mapSize", options.mapSize);
			this.cloudTexture.setFloat("maxResolution", options.maxResolution);
			this.cloudTexture.setFloat("seed", options.cloudSeed);
			this.cloudTexture.setVector3("options", new Vector3(1.0, 0, 0));
			this.cloudTexture.refreshRate = 0;
			this.cloudTexture.setVector2("lowerClamp", options.lowerClamp);
			this.cloudTexture.setVector2("range", options.range);

			this.setTexture("cloudSampler", this.cloudTexture);

			this.setColor3("haloColor", options.haloColor);
		}
	}
	game.scene.default = new Scene(game.engine);
	//game.scene.default = new Level('GAME_DEFAULT_SCENE',1,false);
	Object.assign(game.scene.default, {
		name: 'GAME_DEFAULT_SCENE',
		clearColor: new Color3(0.8, 0.75, 0.85),
		gl: new GlowLayer('GAME_DEFAULT_GLOWLAYER', game.scene.default),
		entities: new Map(),
		bodies: new Map()
	});
	const player = new UniversalCamera("player", rand.cords(rand.int(0, 50), true).add(new Vector3(0, 0, -1000)), game.scene());
	const playerData = { items: {}, tech: {}, fleet: [], fleetSize: new Vector3(5, 5, 5), xpPoints: 0, xp : 0};
	Object.assign(player, {
		username: '', marker: {}, speed: 1, velocity: Vector3.Zero(), camIsActive: true, rcsIsActive: true,
		cam: new ArcRotateCamera('player.cam', -pi / 2, pi / 2.5, 5, player.position, game.scene()), targetBody: null,
		arcMode: true,
		updateFleet: () => {
			
			player.data().fleet.forEach((s, i) => {
				if(s.hp <= 0){
					s.remove();
					player.data().fleet.splice(i, 1);
					playsound(sound.destroy_ship, settings.sfx)
				}
				if(!s.mesh()) s.addToScene();
			});
			if(player.data().fleet.length <= 0){
				game.chat("You died");
				player.reset();
				player.wipe();
				ship.battle = null;
				let s = new Ship('frigate', player, saves.get(saves.sel));
				s.addToScene(game.scene());
			}
		},
		chat: (...msg) => { for (let m of msg) { game.chat((`${player.username}: ${m}`).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')) } },
		move: vector => { player.velocity.addInPlace(player.getDirection(vector)) },
		stop: (delay = 0) => { setTimeout(e => { player.velocity = Vector3.Zero(); player.data().fleet.forEach(s => { s.velocity = Vector3.Zero() }) }, (+delay) || 0) },
		reset: noStop => { player.position = rand.cords(rand.int(0, 50), true).add(new Vector3(0, 0, -1000)); player.rotation = Vector3.Zero(); player.cam.alpha = 0; player.cam.beta = 0; if (!noStop) player.stop() },
		hasItems: items => { let has = true; for (let i in items) { if (player.data().items[i] < items[i]) { has = false } } return has },
		removeItems: items => { for (let i in items) { item[i] ? player.data().items[i] -= items[i] : game.error(`removeItems failed: item "${i}" does not exist`) } },
		giveItems: items => { for (let i in items) { item[i] ? player.data().items[i] += items[i] : game.error(`giveItems failed: item "${i}" does not exist`) } },
		wipe: () => { for (let i in item) { player.data().items[i] = 0 }; for (let i in tech) { player.data().tech[i] = 0 }; for (let i in player.data().fleet) { player.data().fleet[i].remove() } player.data().fleet = [] },
		data: id => saves.get(saves.sel)?.playerData?.[id ?? player.id] ?? playerData,
		levelOf: xp => Math.sqrt(xp / 10),
		xpOf: level => 10 * level ** 2
	});
	Object.assign(player.cam, { radius: 25, upperRadiusLimit: 50, lowerRadiusLimit: 5 });
	const ship = {
		cam: new ArcRotateCamera('cam.ship', -pi / 2, pi / 2.5, 5, player.position, game.scene()),
		generic: {}, battle: null, sel: null,
		move: vector => { if (player.data().fleet.sel) player.data().fleet[player.data().fleet.sel].velocity.addInPlace(player.getDirection(vector)) },
		num: filter => { let count = 0; for (let i = 0; i < player.data().fleet.length; i++) { if (player.data().fleet[i].type == filter) { count++; } } return count }
	};
	const Ship = class extends Entity {
		constructor(type, faction = player, save){
			super(save ?? (faction == player && saves.get(saves.sel) instanceof Save ? saves.get(saves.sel) : faction.getSave()));
			let size = 5;
			Object.assign(this, {
				velocity: Vector3.Zero(),
				level: 0,
				position: rand.cords(rand.int(1, faction.power)),
				type,
			});
			(faction == player ? faction.data() : faction).fleet.push(this);
			for(let i in ship.generic[type]) { if (['hp', 'dmg', 'reload', 'power'].includes(i)) { this[i] = ship.generic[type][i] } }
			this.reload += Math.random() * ship.generic[type].reload;
		}
	}
	Object.assign(ship.cam, { upperRadiusLimit: 5, lowerRadiusLimit: 5 });
	const warp = {
		to: Vector2.Zero(), cooltime: 0, jumptime: 0, isJumping: false, energy: 100, maxEnergy: 100, cooldown: 10,
		start: (lvl, ignoreCooldown) => {
			if(ship.battle){ game.chat("You can't enter hyperspace while in a battle."); return false }
			else if(warp.cooltime > 0 && !ignoreCooldown){ game.chat("You can't enter hyperspace, the shunts are still cooling from the last jump."); return false}
			else{ playsound(sound.warp_start, settings.sfx); warp.isJumping = true; warp.to = lvl; return true }
		},
		end: fell => {
			if(warp.isJumping){
				playsound(sound.warp_end, settings.sfx);
				setTimeout(e => {
					player.updateFleet();
					if(!saves.get(saves.sel).levels[warp.to.asArray()]){
						new Level(saves.get(saves.sel).systems[warp.to.asArray()] || 'Empty Space', warp.to, !!saves.get(saves.sel).systems[warp.to.asArray()], lvl => {
							saves.get(saves.sel).levels[lvl.location.asArray()] = lvl;
							game.currentLevel = lvl.location;
							player._scene = player.cam._scene = game.scene(warp.to);
							warp.isJumping = false;
							warp.cooltime = warp.cooldown * 60 * (1 - tech.energy.level / 100);
							game.chat(`Warped to ${warp.to.x},${warp.to.y} (${game.scene().name})`);
						});
					}else{
						game.currentLevel = warp.to;
						player._scene = player.cam._scene = game.scene(warp.to);
						warp.isJumping = false;
						warp.cooltime = warp.cooldown * 60 * (1 - tech.energy.level / 100);
						game.chat(`Warped to ${warp.to.x},${warp.to.y} (${game.scene().name})`);
					}
					player.reset();
				}, 2905);
			}else{
				console.warn('Tried to leave hyperspace while not in it.');
			}
		}
	};
	const ui = {};
	if (cookie.token && navigator.onLine) {
		$.get(web('api/user'), { token: cookie.token, session: true }, req => {
			player.authData = req;
			if (isJSON(req)) {
				let res = JSON.parse(req);
				Object.assign(player, res);
				localStorage.auth = req.split('').map(e => e.charCodeAt(0).toString(16)).join(' ');
				document.cookie = 'auth=' + btoa(req);
				player.freezeProperty(...Object.keys(res));
			}
			else if (req == undefined) {
				game.chat('Failed to connect to account servers.')
			}
			else if (req == 'ERROR 404') {
				game.chat('Invalid token, please log in again and reload the game to play multiplayer.');
			}
		});
	}
	else if(cookie.auth && localStorage.auth){
		let localJSON = localStorage.auth.split(' ').map(e => String.fromCharCode(parseInt(e, 16))).join('');
		if (isJSON(localJSON) && isJSON(atob(cookie.auth))){
			let localData = JSON.parse(localJSON), data = player.authData = JSON.parse(atob(cookie.auth));
			Object.assign(player, data);
			player.freezeProperty(...Object.keys(data));
		}else{
			game.chat('Error: Invalid auth data.')
		}
	}
	else{
		game.mpEnabled = false;
		game.chat('You\'re not logged in, and will not be able to save the game or play multiplayer.')
	}
	/*$.query = (server,query) => {
		if(game.mp){
		}
	};*/
	db.transaction('settings', 'readonly').objectStore('settings').get('general').onsuccess = e => {
		settings = e.target.result;
		$('form.gen').formData(settings);
		ui.update();
	};

	Object.defineProperties(tech, {
		price: {
			value: type => {
				let recipe = { ...tech[type].recipe };
				for (let p in tech[type].recipe) {
					for (let i = 1; i < player.data().tech[type]; i++) {
						recipe[p] *= tech[type].scale
					};
				}
				return recipe
			},
			enumerable: false
		},
		locked: {
			value: type => {
				for (let i in tech[type].requires) {
					if ((tech[type].requires[i] > 0 && player.data().tech[i] < tech[type].requires[i]) || (tech[type].requires[i] == 0 && player.data().tech[i] > 0)) {
						return true
					}
				}
				return false
			},
			enumerable: false
		}
	});
	Object.defineProperty(item, 'multiplyer', { value: 1 + (1 - settings.difficulty), enumerable: false });
	game.freezeProperty('version', 'versions', 'mpEnabled', 'scene', 'log', 'chat');
	player.freezeProperty('updateFleet', 'move', 'stop', 'reset', 'hasItems', 'removeItems', 'giveItems', 'wipe', 'chat');
	onresize = e => { game.engine.resize(); console.warn('Do not paste any code someone gave you, as they may be trying to steal your information') };
	player.setTarget(Vector3.Zero());
	if (!game.mpEnabled && !query.mp) {
		$('#main .mp').hide();
		$('#main .options').attr('plot', 'c,360px,350px,50px');
		$('#main button.exit').attr('plot', 'c,460px,350px,50px');
	}


	game.createKeybind('forward', 'w', 'Forward', e => {
		let n = player.camIsActive ? player : player.data().fleet[player.data().fleet.sel],
			acceleration = (player.camIsActive ? 1 : -1) * (player.speed + player.data().tech.thrust / 10);
		n.velocity.addInPlace((player.camIsActive ? n : n.mesh()).getDirection(new Vector3(0, 0, acceleration)));
	});
	game.createKeybind('left', 'a', 'Rotate Left', e => { (player.camIsActive ? player.rotation : player.data().fleet[player.data().fleet.sel].rotation).y -= (pi / 40 * settings.sensitivity); if (player.camIsActive) ship.cam.alpha -= (pi / 40 * settings.sensitivity) });
	game.createKeybind('right', 'd', 'Rotate Right', e => { (player.camIsActive ? player.rotation : player.data().fleet[player.data().fleet.sel].rotation).y += (pi / 40 * settings.sensitivity); if (player.camIsActive) ship.cam.alpha += (pi / 40 * settings.sensitivity) });
	game.createKeybind('back', 's', 'Backward', e => {
		let n = player.camIsActive ? player : player.data().fleet[player.data().fleet.sel],
			acceleration = (player.camIsActive ? -1 : 1) * (player.speed + player.data().tech.thrust / 10);
		n.velocity.addInPlace((player.camIsActive ? n : n.mesh()).getDirection(new Vector3(0, 0, acceleration)));
	});
	game.createKeybind('chat', 't', 'Toggle Chat', e => {
		if ($('#cli').toggle().is(':visible')) {
			document.exitPointerLock();
			$('#cli').focus();
			e.preventDefault();
		}
	});
	game.createKeybind('chat', '/', 'Toggle Command', e => {
		if ($('#cli').toggle().is(':visible')){
			document.exitPointerLock();
			$('#cli').focus().val('/');
			e.preventDefault();
		}
	});
	game.createKeybind('rcs', 'f', 'Toggle RCS', e => {
		player.rcsIsActive = !player.rcsIsActive;
		$('#hud .rcs').text(`RCS: ${player.rcsIsActive ? 'ON' : 'OFF'}`);
	});
	game.createKeybind('nav', 'q', 'Toggle Navigation', e => {
		game.changeUI('#q');
	});
	game.createKeybind('inv', 'e', 'Toggle Inventory', e => {
		game.changeUI('#e');
	});
	game.createKeybind('view', 'r', 'Toggle View Mode', e => {
		player.camIsActive = !player.camIsActive;
		game.scene().activeCamera = game.scene().activeCamera == ship.cam ? player.cam : ship.cam;
		player.data().fleet.sel ||= 0;
		Object.assign(ship.cam, {
			lowerRadiusLimit: ship.generic[player.data().fleet[player.data().fleet.sel].type].camRadius,
			upperRadiusLimit: ship.generic[player.data().fleet[player.data().fleet.sel].type].camRadius
		});
		$('#hud_ship').toggle();
		ui.update()
	});
	game.createKeybind('screenshot', 'F2', 'Take Screenshot', e => {
		game.screenshots.push(game.canvas[0].toDataURL("image/png")); ui.update();
	});

	//Some stuff done on initalization
	document.title = "Blankstorm " + game.versions.get(game.version).text;
	$("#main .version").html(`<a href="${web('/versions#' + game.version)}" target="_blank">${game.versions.get(game.version).text}</a>`);
	console.log(`%cBlankstorm ${game.versions.get(game.version).text}`, `color:#f55`);

	//load mods & keybinds into the game
	db.transaction('settings', 'readonly').objectStore('settings').get('keybinds').onsuccess = e => {
		for (let i in e.target.result) {
			keybind[i] ??= e.target.result[i];
		}
		$('form.key').formData(keybind);
	};
	db.transaction('mods', 'readonly').objectStore('mods').getAll().onsuccess = e => {
		console.log('Loaded mods: ' + e.target.result.join('\n'))
	};
	$("#settings form.key button").each(function (e) { $(this).text(keybind[this.name]) });
	const gen = {
		enemies: power => {//enemy spawning algorithm
			let e = [], p = [];
			for (let i in ship.generic) { ship.generic[i].enemy ? p.push(ship.generic[i].power) : 0 }
			p.sort((c1, c2) => { if (c1 > c2) { return -1 } else if (c2 > c1) { return 1 } else { return 0 } });
			for (let i = 0; i < p.length; i++) { for (let j in ship.generic) { (p[i] == ship.generic[j].power) ? p[i] = j : 0 } }
			for (let i = 0; i < p.length; i++) {
				for (let j = 0; j < Math.floor(power / ship.generic[p[i]].power); j++) {
					e.push(p[i]); power -= ship.generic[p[i]].power
				}
			}
			e.power = power;
			return e
		},
		items: (quantity = 0, rares) => {
			let q = quantity;
			let r = {};
			for (let i in item) {
				(item[i].rare) ? (Math.random() < item[i].drop && rares) ? r[i] = quantity / item[i].value : r[i] = 0 : r[i] = quantity / item[i].value;
			}
			return r;
		}
	};
	Object.assign(ui, {
		yrd: (shiptype, row) => {
			let s = ship.generic[shiptype], buildCost = '', upgradeCost = '', techRequires = '';
			for (let m in s.recipe[0]) {
				buildCost += `<br>${item[m].displayName}: ${minimize(player.data().items[m])}/${minimize(s.recipe[0][m])}`
			}
			for (let i in s.requires) {
				techRequires += (s.requires[i] > 0) ? `<br>${tech[i].displayName}: ${player.data().tech[i]}/${s.requires[i]}` : `<br>Incompatible with ${tech[i].displayName}`
			}
			s.gui = $(`
				<span style=text-align:right;grid-row:${row};grid-column:1;><svg style=font-size:1.5em><use href=#fa-lock /></svg></span>
				<span style=text-align:center;grid-row:${row};grid-column:2;>[${ship.num(shiptype)}] ${s.displayName}</span>
				<span style=text-align:left;grid-row:${row};grid-column:3;><svg style=font-size:1.5em><use href=#fa-circle-plus /></svg></span>
			`);
			s.gui.eq(-1).children('svg')
				.click(e => {
					if(player.hasItems(s.recipe[0])){
						player.removeItems(s.recipe[0]);
						let s = new Ship(shiptype, player, saves.get(saves.sel));
					}
					s.gui.eq(2).html(`[${ship.num(shiptype)}]&nbsp;${s.displayName}`);
				})
				.tooltip(`${s.desc}<br><colorbr><strong>Material Cost</strong>${buildCost}<br>${Object.keys(s.requires).length ? `<br><strong>Requires:</strong>` : ``}${techRequires}${settings.debug_tooltips ? '<br>type: ' + shiptype : ''}`);
			return s.gui;
		},
		lab: (t, row) => {
			if (tech[t] == undefined) throw new ReferenceError(`UI: Lab: techtype "${t}" is undefined`);
			tech[t].gui = $(`
				<span style=text-align:right;grid-row:${row};grid-column:1;><svg style=font-size:1.5em><use href=#fa-lock /></svg></span>
				<span style=text-align:center;grid-row:${row};grid-column:2;>${tech[t].displayName}</span>
				<span style=text-align:left;grid-row:${row};grid-column:3;><svg style=font-size:1.5em><use href=#fa-circle-up /></svg></span>
			`);
			tech[t].gui.click(e => {
				if(player.hasItems(tech.price(t)) && player.data().tech[t] < tech[t].max && !tech.locked(t) && player.data().xpPoints >= 1){
					player.removeItems(tech.price(t));
					player.data().tech[t]++;
					player.data().xpPoints--;
				}
			});
			let upgradeCost = Object.entries(tech.price(t)).reduce((a, [k, v]) => a + `<br>${item[k].displayName}: ${minimize(player.data().items[k])}/${minimize(v)}`, ''),
			techRequires = Object.entries(tech[t].requires).reduce((a, [k, v]) => a + (v > 0) ? `<br>${tech[k].displayName}: ${player.data().tech[k]}/${v}` : `<br>Incompatible with ${tech[k].displayName}`, '');
			tech[t].gui.eq(-1).children('svg').tooltip(`<strong>${tech[t].displayName}</strong><br>${tech[t].desc}<br>${player.data().tech[t] >= tech[t].max ? `<strong>Max Level</strong>` : `${player.data().tech[t]} <svg><use href=#fa-arrow-right /></svg> ${player.data().tech[t] + 1}`}<br><br><strong>Material Cost:</strong>${upgradeCost}<br>${Object.keys(tech[t].requires).length ? `<br><strong>Requires:</strong>` : ``}${techRequires}${settings.debug_tooltips ? '<br>type: ' + t : ''}`);
			return tech[t].gui
		},
		inv: (i, row) => {
			item[i].gui = $(`
				<span style=text-align:right;grid-row:${row};grid-coloumn:1;>${item[i].displayName}${item[i].rare ? ` (rare)` : ``}: </span>
				<span style=text-align:left;grid-row:${row};grid-coloumn:2;>${minimize(player.data().items[i])}</span>
			`)
				.attr('bg', 'none')
				.css('font-size', 14)
				.click(e => { if (item[i].recipe && player.hasItems(item[i].recipe)) { player.removeItems(item[i].recipe); player.data().items[i]++ } })
				.removeAttr('clickable');
			return item[i].gui
		},
		update: () => {
			$('div.lab,div.yrd,div.map,div.inv,div.screenshots,select.move').empty();
			let invRows = 0, yardRows = 0, labRows = 0;
			for (let i in item) {
				item[i].gui = ui.inv(i, ++invRows);
				$("div.inv").append(item[i].gui)
			};
			for (let i in tech) {
				tech[i].gui = ui.lab(i, ++labRows);
				$("div.lab").append(tech[i].gui);
				tech[i].gui.eq(0)[tech.locked(i) ? 'show' : 'hide']();
			}
			for (let i in ship.generic) {
				let locked = false;
				for (let t in ship.generic[i].requires) {
					if (tech.locked(t)) locked = true;
				}
				ship.generic[i].gui = ui.yrd(i, ++yardRows);
				$("div.yrd").append(ship.generic[i].gui);
				ship.generic[i].gui.eq(0)[locked ? 'show' : 'hide']();
			}
			$('.tooltip').remove(); $('[tooltip-active]').mouseenter();
			for(let [id, body] of game.scene().bodies){
				if (body instanceof CelestialBody) {
					$('select.move').append(body.option = $(`<option value=${id}>${body.name}</option>`))
				}
			};
			game.screenshots.forEach(s => {
				$(`<img src=${s} width=256></img>`)
					.appendTo('#e div.screenshots')
					.cm($('<button><svg><use href=#fa-download /></svg> Download</button>').click(e => {
						$('<a download=screenshot.png></a>').attr('href', s)[0].click()
					})
					)
			});
			$('input[label][display]').each((i, e) => {
				let val = e.value;
				$(`label[for=${$(e).attr('ui-label')}]`).html(`${$(e).attr('label')} (${eval(`\`${$(e).attr('display')}\``)}) `);
			});
			servers.forEach(server => {
				server.gui.name.text(server.name);
			});
			saves.forEach(save => {
				save.gui.name.text(save.name);
				save.gui.version.text(game.versions.get(save.version).text);
				save.gui.date.text(save.date.toLocaleString());
			});
			if(game.mp){
				$('#esc .quit').text('Disconnect');
				$('#esc .options').attr('plot', '12.5px,125px,225px,50px,a');
				$('#esc .quit').attr('plot', '12.5px,187.5px,225px,50px,a');
				$('#esc .save').hide();
			}else{
				$('#esc .quit').text('Exit Game');
				$('#esc .save').attr('plot', '12.5px,125px,225px,50px,a');
				$('#esc .options').attr('plot', '12.5px,187.5px,225px,50px,a');
				$('#esc .quit').attr('plot', '12.5px,250px,225px,50px,a');
				if(query.save) $('#esc .save').show();
				
			}
			
			$('[plot]').each((i, e) => {
				let scale = (settings.gui_scale == 0) ? innerHeight <= 475 ? 0.5 : innerHeight <= 650 ? 0.75 : innerHeight <= 800 ? 1 : 1.25 : Object.assign([1, 0.75, 1, 1.25][settings.gui_scale], { is_from_array: true });

				let plot = $(e).attr('plot').replaceAll(/[\d\.]+(px|em)/g, str => parseFloat(str) * scale + str.slice(-2)).split(',');
				plot[0][0] == 'c' && !plot[0].startsWith('calc') ?
					$(e).css('left', `${plot[0].slice(1) ? 'calc(' : ''}calc(50% - calc(${plot[2]}/2))${plot[0].slice(1) ? ` + ${plot[0].slice(1)})` : ''}`)
					: plot[0][0] == 'r' ? $(e).css('right', plot[0].slice(1))
						: plot[0][0] == 'l' ? $(e).css('left', plot[0].slice(1))
							: $(e).css('left', plot[0]);
				plot[1][0] == 'c' && !plot[1].startsWith('calc') ?
					$(e).css('top', `${plot[1].slice(1) ? 'calc(' : ''}calc(50% - calc(${plot[3]}/2))${plot[1].slice(1) ? ` + ${plot[1].slice(1)})` : ''}`)
					: plot[1][0] == 'b' ? $(e).css('bottom', plot[1].slice(1))
						: plot[1][0] == 't' ? $(e).css('top', plot[1].slice(1))
							: $(e).css('top', plot[1]);
				$(e).css({
					width: plot[2],
					height: plot[3],
					position: ['absolute', 'fixed', 'relative', 'sticky'].includes(plot[4]) ? plot[4] : /^(a|s|f|r)$/.test(plot[4]) ? { a: 'absolute', f: 'fixed', r: 'relative', s: 'sticky' }[plot[4]] : 'fixed'
				});
			});
		},
		lastScene: "#main"
	});

	//*.new functions ~~new
	const Star = class extends CelestialBody {
		constructor({name, position = Vector3.Zero(), radius = 1, color = Color3.Gray(), scene}) {
			super(name ?? 'Unknown Star', scene);
			CreateSphereVertexData({ diameter: radius*2, segments: settings.mesh_quality }).applyToMesh(this);
			Object.assign(this, {
				position: position,
				light: Object.assign(
					new PointLight(this.id + ".light", position, scene),
					{intensity: 1, range: 10000}
				),
				material: Object.assign(new CustomMaterial(this.id + ".mat", scene), {
					//emissiveTexture: new NoiseProceduralTexture(this.id + ".texture", settings.mesh_quality, scene),
					emissiveColor: color,
					disableLighting: true
				}),
				radius: radius,
				color: color,
				isStar: true
			});
			//Object.assign(s.material.emissiveTexture, {animationSpeedFactor: 0.1, octaves: 8, persistence:0.8});
			//s.material.Fragment_Before_FragColor(`color = vec4(vec3(color.xyz),1.0);`);
		}
	}

	game.scene.default.center = new Mesh('GAME_DEFAULT_CENTER', game.scene.default);
	const Planet = class extends CelestialBody {
		static maxNum = 9;
		static biomes = new Map([
			['earthlike', {
				clouds: false, //true,
				upperColor: new Color3(0.2, 2.0, 0.2),
				lowerColor: new Color3(0, 0.2, 1.0),
				haloColor: new Color3(0, 0.2, 1.0),
				maxResolution: [64, 256, 1024][settings.render_quality],
				seed: 0.30,
				cloudSeed: 0.6,
				lowerClamp: new Vector2(0.6, 1),
				groundAlbedo: 1.25,
				cloudAlbedo: 0,
				directNoise: false,
				lowerClip: new Vector2(0, 0),
				range: new Vector2(0.3, 0.35)
			}],
			['volcanic', {
				upperColor: new Color3(0.9, 0.45, 0.45),
                lowerColor: new Color3(1.0, 0, 0),
                haloColor: new Color3(1.0, 0, 0.3),
                seed: 0.30,
                cloudSeed: 0.60,
                clouds: false,
                lowerClamp: new Vector2(0, 1),
                maxResolution: 256,
                cloudAlbedo: 0,
                groundAlbedo: 1.0,
                directNoise: false,
                lowerClip: new Vector2(0, 0),
                range: new Vector2(0.3, 0.4)
			}],
			['jungle', {
				upperColor: new Color3(0.1, 0.3, 0.7),
                lowerColor: new Color3(0, 1.0, 0.1),
                haloColor: new Color3(0.5, 1.0, 0.5),
                seed: 0.40,
                cloudSeed: 0.70,
                clouds: false, //true,
                lowerClamp: new Vector2(0, 1),
                maxResolution: 512,
                cloudAlbedo: 1.0,
                groundAlbedo: 1.1,
                directNoise: false,
                lowerClip: new Vector2(0, 0),
                range: new Vector2(0.2, 0.4)
			}],
			['ice', {
				upperColor: new Color3(1.0, 1.0, 1.0),
                lowerColor: new Color3(0.7, 0.7, 0.9),
                haloColor: new Color3(1.0, 1.0, 1.0),
                seed: 0.80,
                cloudSeed: 0.40,
                clouds: false, //true,
                lowerClamp: new Vector2(0, 1),
                maxResolution: 256,
                cloudAlbedo: 1.0,
                groundAlbedo: 1.1,
                directNoise: false,
                lowerClip: new Vector2(0, 0),
                range: new Vector2(0.3, 0.4),
			}],
			['desert', {
				upperColor: new Color3(0.9, 0.30, 0),
                lowerColor: new Color3(1.0, 0.5, 0.1),
                haloColor: new Color3(1.0, 0.5, 0.1),
                seed: 0.18,
                cloudSeed: 0.60,
                clouds: false,
                lowerClamp: new Vector2(0.3, 1),
                maxResolution: 512,
                cloudAlbedo: 1.0,
                groundAlbedo: 1.0,
                directNoise: false,
                lowerClip: new Vector2(0, 0),
                range: new Vector2(0.3, 0.4)
			}],
			['islands', {
				upperColor: new Color3(0.4, 2.0, 0.4),
                lowerColor: new Color3(0, 0.2, 2.0),
                haloColor: new Color3(0, 0.2, 2.0),
                seed: 0.15,
                cloudSeed: 0.60,
                clouds: false, //true,
                lowerClamp: new Vector2(0.6, 1),
                maxResolution: 512,
                cloudAlbedo: 1.0,
                groundAlbedo: 1.2,
                directNoise: false,
                lowerClip: new Vector2(0, 0),
                range: new Vector2(0.2, 0.3)
			}],
			['moon', {
				upperColor: new Color3(2.0, 1.0, 0),
				lowerColor: new Color3(0, 0.2, 1.0),
				haloColor: new Color3(0, 0.2, 1.0),
				cloudSeed: 0.6,
				lowerClamp: new Vector2(0.6, 1),
				cloudAlbedo: 0.9,
				lowerClip: new Vector2(0, 0),
				range: new Vector2(0.3, 0.35),
				haloColor: new Color3(0, 0, 0),
                seed: 0.5,
                clouds: false,
                groundAlbedo: 0.7,
                directNoise: true,
                lowerClip: new Vector2(0.5, 0.9)
			}]
		]);
		constructor({name, position = Vector3.Zero(), biome = 'earthlike', radius = 1, owner = null, fleet = [], rewards = {}, scene = game.scene()}){
			super(name ?? 'Unknown Planet', scene);
			CreateSphereVertexData({ diameter: radius * 2, segments: settings.mesh_quality }).applyToMesh(this);
			Object.assign(this, {
				owner: owner,
				radius: radius,
				rewards: rewards,
				power: 0,
				fleetLocation: rand.cords(rand.int(radius + 5, radius * 1.2), true),
				biome: biome,
				position: position,
				material: new CelestialBodyMaterial(Planet.biomes.get(biome))
			});
			for (let f of fleet) {
				let s = new Ship(f, this);
				this.power += s.power;
				s.addToScene(scene);
			}
			for (let s of this.fleet) {
				s.position = rand.cords(rand.int(0, this.power));
				s.mesh(scene).position = s.position.add(this.position).add(this.fleetLocation);
			}
		}
	}
	const Level = class extends Scene {
		static names = ["Crash Site", "Abrigato", "Kerali", "Kaltez", "Suzum", "Vespa", "Coruscare", "Vulca", "Jaeger", "Kashyyyk", "Outpost42", "Victoria", "Gesht", "Sanctuary", "Snowmass", "Ja", "Keeg", "Haemeiguli", "Borebalae", "Albataetarius", "Hataerius", "Achernaiphoros", "Antadrophei", "Hoemeirai", "Antabalis", "Hoereo", "Pazadam", "Equidor", "Pax", "Xena", "Titan", "Oturn", "Thuamia", "Heuthea", "Ditharus", "Muxater", "Trukovis", "Bichotune", "Etis", "Leorus", "Aphus", "Harophos", "Athena", "Hades", "Icarus", "Ureus", "Xentos Prime", "Ketlak", "Aerox", "Thryox", "Stratus", "Nox", "Sanctum", "Pastra", "Tinctus", "Morbus", "Neos", "Nomen", "Numerus", "Pax", "Fornax", "Skorda", "Alli", "Resurs", "Home"];
		static size = 5000;
		static total = 0;
		getSave(){
			return this._save
		}
		constructor(name, location = new Vector2(rand.int(-25, 25), rand.int(-25, 25)), hasStar = true, onready = () => null, save = saves.get(saves.sel)) {
			(async () => {
				const id = rand.hex(32);
				super(game.engine);
				Object.assign(this, {
					id: id,
					name: name,
					gl: Object.assign(new GlowLayer('glowLayer#' + id, this), { intensity: 0.9 }),
					hl: new HighlightLayer('highlight#' + id, this),
					skybox: Mesh.CreateBox('skybox', Level.size * 2, this),
					location: location,
					hasStar: hasStar,
					difficulty: Vector2.Distance(location, Vector2.Zero()),
					planetNum: hasStar ? rand.int(1, Planet.maxNum) : 0,
					probe: new ReflectionProbe('probe#' + id, 256, this),
					clearColor: new Color3(0.8, 0.75, 0.85),
					activeCamera: player.cam,
					bodies: new Map(),
					onReady: onready,
					_save: save,
					genericEntities: {}
				});
				this.center = hasStar ? new Star({
					name: name,
					position: Vector3.Zero(),
					radius: rand.int(300, 500),
					color: new Color3(Math.random() ** 3 / 2 + rand.float(0.3, 0.4), Math.random() ** 3 / 2 + rand.float(0.3, 0.4), Math.random() ** 3 / 2 + rand.float(0.3, 0.4)),
					scene: this
				}) : new CelestialBody(name, this);
				this.addCamera(player.cam);

				this.skybox.infiniteDistance = true;
				this.skybox.isPickable = false;
				this.skybox.material = Object.assign(new StandardMaterial('skybox.mat', this), {
					backFaceCulling: false,
					disableLighting: true,
					reflectionTexture: CubeTexture.CreateFromImages(Array(6).fill(skybox_image), this)
				});
				this.skybox.material.reflectionTexture.coordinatesMode = 5;

				for(let i in ship.generic){
					let container = this.genericEntities[i] = await SceneLoader.LoadAssetContainerAsync('', ship.generic[i].model, this);
					Object.assign(container.meshes[0], {
						rotationQuaternion: null,
						material: Object.assign(container.materials[0], {
							realTimeFiltering: true,
							realTimeFilteringQuality: [2, 8, 32][+settings.render_quality],
							reflectionTexture: this.probe.cubeTexture,
							roughness: 0,
							metallic: 1
						}),
						position: Vector3.Zero(),
						isVisible: false,
						isPickable: false
					});
					this.probe.renderList.push(container.meshes[1]);
					// = container;
				}
				let nameMode = rand.bool, names = rand.bool ? greek.slice(0, this.planetNum) : range(1, this.planetNum + 1);
				for (let i in names) {
					let name = nameMode ? names[i] + ' ' + this.name : this.name + ' ' + names[i],
					radius = rand.int(25, 50);
					let planet = new Planet({
						name: rand.int(0, 99999) == 0 ? "Dose Bohnen" : name,
						position: rand.cords(rand.int((this.center.radius + radius) * 1.5, Level.size), true),
						radius: radius,
						biome: ['earthlike', 'volcanic', 'jungle', 'ice', 'desert', 'moon'][rand.int(0, 5)],
						fleet: gen.enemies((this.difficulty + 1) * (i + 1) * worldgen.difficulty),
						rewards: gen.items(1000 * i * (2 - worldgen.difficulty)),
						scene: this,
					});
				}
				this.registerBeforeRender(()=>{
        			let ratio = this.getAnimationRatio();
					for(let [id, body] of this.bodies){
						if(body instanceof Planet){
							body.rotation.y += 0.0001 * ratio * body.material.rotationFactor;
							body.material.setMatrix("rotation", Matrix.RotationY(body.matrixAngle));
							body.matrixAngle -= 0.0004 * ratio;
							body.material.setVector3("options", new Vector3(body.material.generationOptions.clouds, body.material.generationOptions.groundAlbedo, body.material.generationOptions.cloudAlbedo))
						}
					}
				});
				this.onReady(this);
			})();
		}
	}
	const Save = class {
		static load(dataString){
			if(isJSON(dataString)){
				let data = JSON.parse(dataString);
			}
			//load a save from cache but do not make a new save
		}
		static cache = [];
		constructor(nameOrData) {
			try {
				if(isJSON(nameOrData)){
					let saveData = JSON.parse(nameOrData);
					Object.assign(this, {
						id: saveData.id,
						name: saveData.name,
						date: new Date(saveData.date),
						version: saveData.version,
						difficulty: saveData.difficulty,
						levels: {},
						entities: new Map(),
						systems: saveData.systems,
						currentLevel: Vector2.FromArray(saveData.currentLevel),
						playerData: {},
					});
					for(let location in saveData.levels){
						let level = this.levels[location] = new Level(saveData.levels[location].name, Vector2.FromArray(saveData.levels[location].location), saveData.levels[location].hasStar);
						for(let id in saveData.levels[location].bodies){
							let bodyData = saveData.levels[location].bodies[id], body = null;
							switch(bodyData.type){
								case 'star':
									body = new Star({
										name: bodyData.name,
										position: Vector3.FromArray(bodyData.position),
										radius: bodyData.radius,
										color: Color3.FromArray(bodyData.color),
										scene: level
									});
								break;
								case 'planet':
									body = new Planet({
										name: bodyData.name,
										position: Vector3.FromArray(bodyData.position),
										radius: bodyData.radius,
										biome: bodyData.biome,
										owner: bodyData.owner,
										fleet: [], //map entity data to this
										rewards: bodyData.rewards,
										scene: level
									});
								break;
								default:
									body = new CelestialBody(bodyData.name, level);
									//TODO: Change Star/Planet constructors to use standerdized data
							}
							level.bodies.set(body.id, body);
						}
					}
					for(let id in saveData.entities){
						let entityData = saveData.entities[id], entity = null;
						switch(entityData.type){
							case 'ship':
								entity = new Ship(entityData.shipType, level.bodies.find(body => body.id==entityData.owner) ?? player, this);
								break;
							default:
								entity = new Entity();
						}
					}
				}else{
					Object.assign(this, {
						id: rand.hex(16),
						name: name,
						date: new Date(),
						version: game.version,
						difficulty: 1,
						levels: {},
						systems: {},
						entities: new Map(),
						currentLevel: Vector2.Zero(),
						playerData: {}
					});
					this.playerData[player.id] = { items: gen.items(5000), xp: 0, tech: {}, fleet: [], xpPoints: 0 };
					for (let i in tech) {
						this.playerData[player.id].tech[i] = 0;
					}
					this.systems[[0,0]] = Level.names[0];
					Level.names.slice(1).forEach(name => {
						let x = rand.int(-25, 25), y = rand.int(-25, 25);
						if(x != 0 && y != 0){
							this.systems[[x,y]] = name;
						}
					});
					this.levels[[0,0]] = new Level(Level.names[0], Vector2.Zero(), true, lvl => {
						this.play();
						new Ship('frigate', player, this);
					}, this);
				}
				saves.set(this.id, this);
				this.gui = $(`<li ofn bg bw style=align-items:center;font-size:${settings.font_size}px;></li>`);
				this.gui.delete = $(`<p style=position:absolute;left:15%><svg><use href=#fa-trash /></svg></p>`).appendTo(this.gui);
				this.gui.play = $(`<p style=position:absolute;left:20%><svg><use href=#fa-play /></svg></p>`).appendTo(this.gui);
				this.gui.edit = $(`<p style=position:absolute;left:25%><svg><use href=#fa-pencil /></svg></p>`).appendTo(this.gui);
				this.gui.name = $(`<p style=position:absolute;left:30%>${this.name}</p>`).appendTo(this.gui);
				this.gui.version = $(`<p style=position:absolute;left:55%>${game.versions.get(this.version).text}</p>`).appendTo(this.gui);
				this.gui.date = $(`<p style=position:absolute;left:65%>${this.date.toLocaleString()}</p>`).appendTo(this.gui);
				$('<p> </p>').appendTo(this.gui);
				
				this.gui
					.attr('clickable', '')
					.click(e => { $('.selected').removeClass('selected'); saves.sel = this.id; this.gui.addClass('selected') })
					.dblclick(e => this.play())
					.prependTo('#load');
				this.gui.delete.click(e => {
					modal('Are you sure?').then(del => {
						if(del){
							this.gui.remove();
							saves.delete(this.id);
							db.transaction('saves', 'readwrite').objectStore('saves').delete(this.id);
						}
					});
				});
				this.gui.play.click(e=>this.play());
				this.gui.edit.click(e => {
					modal({name: 'New name'}, {Cancel: false, Save: true}).then(result => {
						if(result.result){
							this.name = result.name;
							ui.update();
						}
					});
				});
			} catch (err) { console.error(err.stack.split('\n').join('<br>')) }
		}
		play(){
			if(this.version == game.version){
				$('#load').hide();
				game.canvas.show().focus();
				game.canvas[0].requestPointerLock();
				$('#hud').show();
				game.engine.resize();
				saves.sel = this.id;
				setTimeout(e => game.isPaused = false, 1000);
			}else{
				modal('That save is in compatible with the current game version', {Ok: true});
			}
		}
		serialize(){
			let data = {
				id: this.id,
				name: this.name,
				date: this.date.toJSON(),
				version: this.version,
				difficulty: this.difficulty,
				levels: {},
				entities: {},
				systems: this.systems,
				currentLevel: this.currentLevel instanceof Vector2 ? this.currentLevel.asArray() : this.currentLevel,
				playerData: {}
			};
			for(let entity of this.entities.values()){
				if(!entity instanceof Entity){
					console.warn(`entity #${entity?.id} not saved: invalid type`);
				}else{
					let entityData = data.entities[entity.id] = {
						position: entity.position.asArray(),
						rotation: entity.rotation.asArray(),
						name: entity.name
					};
					switch(entity.constructor.name){
						case 'Ship':
						Object.assign(entityData, {
							type: 'ship',
							shipType: entity.type,
							hp: entity.hp,
							lvl: entity.level,
							owner: player.data().fleet.includes(entity) ? player.id : null, 
						});
						break;
						default:
						Object.assign(entityData, {
							type: null,
							shipType: null,
							hp: null,
							lvl: null,
							owner: null
						});
					}
				}
			};
			for(let i in this.levels){
				if(!/\d,\d/.test(i)){
					console.warn(`level ${i} in save ${this.id} not serialized: invalid key`);
				}else if(!this.levels[i] instanceof Level){
					console.warn(`level ${i} in save ${this.id} not serialized: invalid type (not a level)`);
				}else{
					data.levels[i] = {
						bodies: {},
						name: this.levels[i].name,
						location: this.levels[i].location.asArray(),
						planetNum: this.levels[i].planetNum,
						hasStar: this.levels[i].hasStar
					};
					for(let [id, body] of this.levels[i].bodies){
						if(!body instanceof CelestialBody){
							console.warn(`body #${body?.id} not saved: invalid type`);
						}else{
							let bodyData = data.levels[i].bodies[id] = {
								position: body.position.asArray(),
								name: body.name,
								fleetLocation: body.fleetLocation.asArray(),
								fleet: body.fleet.map(f => f.id),
								owner: body.owner
							};
							switch(body.constructor.name){
								case 'Star':
								Object.assign(bodyData, {
									type: 'star',
									radius: body.radius,
									color: body.material.emissiveColor.asArray(),
								});
								break;
								case 'Planet':
								Object.assign(bodyData, {
									type: 'planet',
									biome: body.biome,
									radius: body.radius
								});
								break;
								default: bodyData.type = null;
							}
						}
					};
				}
			}
			for(let p in this.playerData){
				let playerData = this.playerData[p];
				data.playerData[p] = {
					tech: playerData.tech,
					items: playerData.items,
					xp: playerData.xp,
					xpPoints: playerData.xpPoints,
					fleet: playerData.fleet.map(s => s.id)
				};
			}
			return data;
		}
	}
	const Server = class {
		constructor(url, name){
			Object.assign(this, {
				url: url,
				name: name,
				kickMessage: null,
				socket: null, 
				gui: $(`<li ofn bg style=align-items:center;font-size:${settings.font_size}px;></li>`)
			});
			this.socket = io(this.url, {reconnection: false, autoConnect: false, auth: {token: cookie.token, session: cookie.session}});
			this.socket.on('connect', socket => {
				$('#connect').hide();
				$('canvas.game,#mp_testing').show();
			});
			this.socket.on('connect_error', err => {
				$('#connect p').text('Connection Error: ' + err.message);
				$('#connect button').text('Back');
			});
			this.socket.on('connect_failed', err => {
				$('#connect p').text('Connection failed: ' + err.message);
				$('#connect button').text('Back');
			});
			this.socket.on('packet', packet => {
				$('#connect p').text('[Server] ' + (packet instanceof Array ? `Array (${packet.length})<br>` + packet.join('<br>') : packet));
			});
			this.socket.on('kick', message => {
				this.kickMessage = 'Kicked from server: ' + message;
			});
			this.socket.on('chat', message => {
				game.chat(message);
			});
			this.socket.on('disconnect', reason => {
			    let message = 
				this.kickMessage ??
			    (reason == 'io server disconnect' ? 'Disconnected by server' :
			    reason == 'io client disconnect' ? 'Client disconnected' :
			    reason == 'ping timeout' ? 'Connection timed out' :
			    reason == 'transport close' ? 'Lost Connection' :
			    reason == 'transport error' ? 'Connection failed' :
			    reason);
				$('#connect p').text(message);
				this.kickMessage = null;
				$('#connect button').text('Back');
				$("#debug,#hud,#hud_ship,#esc,#e,#cli,canvas.game").hide();
				$(reason == 'io client disconnect' ? '#load' : '#connect').show();
			});
			this.gui.delete = $(`<p style=position:absolute;left:15%><svg><use href=#fa-trash /></svg></p>`).appendTo(this.gui);
			this.gui.play = $(`<p style=position:absolute;left:20%><svg><use href=#fa-play /></svg></p>`).appendTo(this.gui);
			this.gui.edit = $(`<p style=position:absolute;left:25%><svg><use href=#fa-pencil /></svg></p>`).appendTo(this.gui);
			this.gui.name = $(`<p style=position:absolute;left:30%>${this.name}</p>`).appendTo(this.gui);
			this.gui.info = $(`<p style=position:absolute;left:75%></p>`).appendTo(this.gui);
			$('<p> </p>').appendTo(this.gui);
			this.gui
				.attr('clickable', true)
				.click(e => {
					$('.selected').removeClass('selected');
					this.gui.addClass('selected');
					servers.sel = this.url;
				})
				.dblclick(e => this.connect())
				.prependTo('#load');
			this.gui.delete.click(e => {
				modal('Are you sure?').then(del => {
					if(del){
						this.gui.remove();
						servers.delete(this.url);
						db.transaction('servers', 'readwrite').objectStore('servers').delete(this.url);
					}
				});
			});
			this.gui.play.click(e => this.connect());
			this.gui.edit.click(e => {
				modal({name: 'New name'}, {Cancel: false, Save: true}).then(result => {
					if(result.result){
						this.name = result.name;
						db.transaction('servers','readwrite').objectStore('servers').put(this.name, this.url);
						ui.update();
					}
				});
			});
			servers.set(this.url, this);
		}
		connect(){
			if(this?.socket?.connected){
				throw new ReferenceError(`Can't connect to server: already connected`);
			}
			$('#load').hide();
			$('#connect').show();
			$('#connect p').text('Connecting...');
			$('#connect button').text('Back');
			this.socket.connect();
		}
		disconnect(showMessage){
			if(this.socket.connected){
				this.socket.disconnect(true);
			}
			servers.sel = null;
			servers.forEach(server => server.ping());
		}
		ping(){
			this.gui.info
			.html('<svg><use href=#fa-arrows-rotate /></svg>')
			.css('animation', '2s linear infinite rotate');
			$.get(`https://${this.url}/ping`, data => {
				if(isJSON(data)){
					this.pingData = JSON.parse(data);
					this.gui.info
					.text(`${((Date.now() - this.pingData.time)/2).toFixed()}ms ${this.pingData.currentPlayers}/${this.pingData.maxPlayers}`)
					.tooltip(`${this.url}<br><br>${this.pingData.version}<br><br>${this.pingData.message}`)
					.css('font-size', `${settings.font_size}px`)
					.css('animation', 'unset');
				}else{
					this.gui.info
					.html('<svg><use href=#fa-xmark /></svg>')
					.css('animation', 'unset')
					.tooltip(`Can't connect to server`);
				}
			});
		}
	};

	//Event Detection
	onmousedown = m => { mouse.pressed = true };
	onmouseup = m => { mouse.pressed = false };
	onkeydown = k => { key.pressed = true };
	onkeyup = k => { key.pressed = false };
	oncontextmenu = e => { $('.cm').not(":last").remove() };
	onclick = e => { $('.cm').remove() };

	//default data
	Object.assign(ship.generic, {
		corvette: {
			hp: 10, dmg: 0.1, reload: 0.5, maxLevel: 5, power: 1, enemy: true, camRadius: 10, xp: 5,
			displayName: "Corvette", desc: "A light, fast blockade runner",
			recipe: [
				{ metal: 1000, minerals: 500, fuel: 250 },
				{ ancient_tech: 1, code_snippets: 1 },
				{ ancient_tech: 2, code_snippets: 2 },
				{ ancient_tech: 4, code_snippets: 5 },
				{ ancient_tech: 8, code_snippets: 10 }, 
				{ ancient_tech: 16, code_snippets: 20 }
			], requires: {},
			model: 'model/corvette.gltf'
		},
		frigate: {
			hp: 25, dmg: 0.5, reload: 1, maxLevel: 5, power: 2, enemy: true, camRadius: 15, xp: 7.5,
			displayName: "Frigate", desc: "",
			recipe: [
				{ metal: 2000, minerals: 2000, fuel: 500 },
				{ ancient_tech: 2, code_snippets: 5 },
				{ ancient_tech: 4, code_snippets: 10 },
				{ ancient_tech: 7, code_snippets: 20 },
				{ ancient_tech: 9, code_snippets: 30 },
				{ ancient_tech: 12, code_snippets: 35 }
			], requires: {},
			model: 'model/corvette.gltf'
		},
		crusier: {
			hp: 50, dmg: 1, reload: 2, maxLevel: 5, power: 5, enemy: true, camRadius: 20, xp: 10,
			displayName: "Crusier", desc: "",
			recipe: [
				{ metal: 4000, minerals: 1000, fuel: 1000 },
				{ ancient_tech: 3, code_snippets: 10 },
				{ ancient_tech: 5, code_snippets: 20 },
				{ ancient_tech: 8, code_snippets: 30 },
				{ ancient_tech: 12, code_snippets: 40 },
				{ ancient_tech: 18, code_snippets: 50 }
			], requires: {},
			model: 'model/crusier.gltf'
		},
		destroyer: {
			hp: 100, dmg: 2.5, reload: 1, maxLevel: 5, power: 10, enemy: true, camRadius: 30, xp: 20,
			displayName: "Destroyer", desc: "A versitile ship, it can hold its own in battle.",
			recipe: [
				{ metal: 10000, minerals: 4000, fuel: 2500 },
				{ ancient_tech: 8, code_snippets: 25 },
				{ ancient_tech: 12, code_snippets: 40 },
				{ ancient_tech: 20, code_snippets: 60 },
				{ ancient_tech: 35, code_snippets: 85 },
				{ ancient_tech: 60, code_snippets: 100 }
			], requires: {},
			model: 'model/battleship.gltf'
		},
		battleship: {
			hp: 250, dmg: 10, reload: 2, maxLevel: 5, power: 25, enemy: true, camRadius: 40, xp: 50,
			displayName: "Battleship", desc: "Once in a battle, in can stay there and deal out damage for a long time",
			recipe: [
				{ metal: 25000, minerals: 10000, fuel: 5000 },
				{ ancient_tech: 10, code_snippets: 20 },
				{ ancient_tech: 25, code_snippets: 25 },
				{ ancient_tech: 45, code_snippets: 40 },
				{ ancient_tech: 70, code_snippets: 55 },
				{ ancient_tech: 100, code_snippets: 70 }
			], requires: {},
			model: 'model/battleship.gltf'
		},
		dreadnought: {
			hp: 2000, dmg: 100, reload: 4, maxLevel: 5, power: 100, enemy: true, camRadius: 65, xp: 100,
			displayName: "Dreadnought", desc: "The mother of all ships. Dominates everything it touches",
			recipe: [
				{ metal: 1000000, minerals: 500000, fuel: 250000 },
				{ ancient_tech: 25, code_snippets: 50 },
				{ ancient_tech: 50, code_snippets: 75 },
				{ ancient_tech: 100, code_snippets: 88 },
				{ ancient_tech: 150, code_snippets: 100 },
				{ ancient_tech: 250, code_snippets: 125 }
			], requires: { build: 5 },
			model: 'model/dreadnought.gltf'
		}
	});
	Object.assign(item, {
		metal: { displayName: "Titanium", desc: "", rare: false, value: 1 },
		minerals: { displayName: "Crystal", desc: "", rare: false, value: 2 },
		fuel: { displayName: "Fuel", desc: "", rare: false, value: 4 },
		ancient_tech: { displayName: "Ancient Tech", desc: "", rare: true, drop: 0.1, value: 1000 },
		code_snippets: { displayName: "Code Snippets", desc: "", rare: true, drop: 0.1, value: 1000 }
	});
	Object.assign(tech, {
		armor: { recipe: { metal: 1000 }, xp: 1, scale: 1.5, max: 25, requires: {}, displayName: "Armor", desc: "Increases health <br>+10% / level" },
		laser: { recipe: { minerals: 1000 }, xp: 1, scale: 1.5, max: 25, requires: {}, displayName: "Laser Turrets", desc: "Increases base damage <br>+10% / level" },
		reload: { recipe: { minerals: 4000, minerals: 1500 }, xp: 1, scale: 1.2, max: 10, requires: {}, displayName: "Reloading", desc: "Decreases time between shots" },
		thrust: { recipe: { fuel: 1000 }, xp: 1, scale: 1.5, max: 25, requires: {}, displayName: "Propulsion", desc: "Decreases damage taken by 1% / level" },
		energy: { recipe: { fuel: 5000, minerals: 1000 }, xp: 1, scale: 1.5, max: 25, requires: {}, displayName: "Hyperdrive", desc: "Increases hyperdrive energy capacity and decreases cooldown<br>+5% energy / level<br>-2% / level" },
		shields: { recipe: { metal: 2500, minerals: 5000 }, xp: 1, scale: 1.5, max: 10, requires: { armor: 5 }, displayName: "Shields", desc: "Increases shields<br>+10% / level" },
		missle: { recipe: { metal: 10000, minerals: 1000, fuel: 5000 }, xp: 1, scale: 1.5, max: 25, requires: { laser: 5 }, displayName: "Missles", desc: "Increases crit chance and crit damage<br>+1% crit chance<br>+5% crit damage" },
		regen: { recipe: { metal: 50000, minerals: 10000, fuel: 10000 }, xp: 1, scale: 1.5, max: 25, requires: { reload: 5, armor: 15 }, displayName: "Repair Bots", desc: "Increases regen rate<br>+1% / level" },
		build: { recipe: { metal: 100000 }, xp: 2, scale: 1.5, max: 50, requires: { armor: 10, thrust: 10, reload: 10 }, displayName: "Construction", desc: "Decreases ship material cost" },
		salvage: { recipe: { metal: 250000, minerals: 50000, fuel: 100000 }, xp: 5, scale: 1.25, max: 25, requires: { build: 5 }, displayName: "Salvage", desc: "Increases chance for rare items by 2% / level" }
	});

	//Load saves and servers into the (from the IndexedDB)
	db.transaction('saves', 'readonly').objectStore('saves').getAll().onsuccess = e => {
		e.target.result.forEach(save => {
			Save.cache.push(save);
			//new Save(save);
		});
	};
	db.transaction('servers', 'readonly').objectStore('servers').getAllKeys().onsuccess = e => {
		e.target.result.forEach(key => {
			db.transaction('servers', 'readonly').objectStore('servers').get(key).onsuccess = e => {
				let server = new Server(key, e.target.result);
			}
		});
	};

	//Event Listeners (UI transitions, creating saves, etc.)
	$("#main .sp").click(e => {
		game.mp = false;
		$("#load li").detach();
		saves.forEach(save => save.gui.prependTo('#load'));
		$("#main, #load .refresh").hide();
		$("#load").show()
	});
	$("#main .mp").click(e => {
		game.mp = true;
		$('#main').hide();
		$('#load,#load .refresh').show();
		$("#load li").detach();
		servers.forEach(server => {
			server.gui.prependTo('#load');
			server.ping();
		});
	});
	$("#main .options").click(e => {
		ui.LastScene = '#main';
		$("#settings").show();
		ui.update();
	});
	$("#load .back").click(e => {
		$("#load").hide();
		$("#main").show()
	});
	$("#load .new").click(e => {
		$("#load").hide();
		game.mp ? $("#server").show() : $("#save").show()
	});
	$('#load .refresh').click(e => {
		servers.forEach(server => server.ping());
	});
	$(':where(#save,#server,#connect) button.back').click(e => {
		$('#load').show();
		$('#connect,#save,#server').hide();
	});
	$("#save .new").click(e => {
		$("#save").hide();
		let save = new Save($('#save .name').val());
	});
	
	$('#server .save').click(e => {
		let url = $('#server input.url').val(), name = $('#server input.name').val();
		if(servers.has(url)){
			modal('A server with that url already exists.', {Accept: true})
		}else{
			new Server(url, name);
		}
		db.transaction('servers','readwrite').objectStore('servers').put(name, url);
		$("#server").hide();
		$("#load").show();
	});
	$('#esc .resume').click(e => {
		$('#esc').hide();
		game.canvas.focus()[0].requestPointerLock();
		game.isPaused = false;
	});
	$('#esc .save').click(e => {
		if(saves.get(saves.sel) instanceof Save){
			$('#esc .save').text('Saving...');
			let dbCall = db.transaction('saves','readwrite').objectStore('saves').put(saves.get(saves.sel).serialize(), saves.sel);
			dbCall.onsuccess = e => {
				game.chat('Game Saved.');
				$('#esc .save').text('Save Game');
			};
			dbCall.onerror = err => {
				game.chat('Failed to save game: ' + err);
				$('#esc .save').text('Save Game');
			};
		}else{throw 'Save Error: you must have a valid save selected.'}
	});
	if(!query.save){
		$('#esc .save').remove();
		$('#esc .options').attr('plot', '12.5px,125px,225px,50px,a');
		$('#esc .quit').attr('plot', '12.5px,187.5px,225px,50px,a');
	}
	$("#esc .options").click(e => {
		ui.LastScene = '#esc';
		$("#esc").hide();
		$("#settings").show();
	});
	$("#esc .quit").click(e => {
		game.isPaused = true;
		$("#debug,#hud,#hud_ship,#esc,#e,#cli,canvas.game").hide();
		if(game.mp){
			servers.get(servers.sel).disconnect();
		}else{
			game.currentLevel = Vector2.Zero();
			saves.sel = null;
			$('#main').show();
		}
	});
	$("#nav .inv").click(e => { $("#e div").not('#nav').hide(); $("div.inv").show() });
	$("#nav .map").click(e => { $("#e div").not('#nav').hide(); $("div.map").show() });
	$("#nav .screenshots").click(e => { $("#e div").not('#nav').hide(); $("div.screenshots").show() });
	//$('ul.screenshots img').contextmenu(function(e){})
	$("#nav .yrd").click(e => { $("#e div").not('#nav').hide(); $("div.yrd").show() });
	$("#nav .lab").click(e => { $("#e div").not('#nav').hide(); $("div.lab").show() });
	$("#settings button.gen").click(e => { game.saveSettings(); $("#settings form,#settings ul").hide(); $("#settings form.gen").show() });
	$("#settings button.key").click(e => { game.saveSettings(); $("#settings form,#settings ul").hide(); $("#settings form.key").show() });
	$("#settings button.mod").click(e => {
		game.saveSettings();
		$('#settings form,#settings ul').hide();
		$('#settings ul.mod').show().empty().append(
			$('<h2 style=text-align:center>Mods</h2>'),
			$('<button plot=r15px,b15px,100px,35px,a><svg><use href=#fa-trash /></svg>&nbsp;Reset</button>').click(e => {
				db.transaction('mods', 'readwrite').objectStore('mods').clear().onsuccess = e => {
					location.reload();
				}
			}),
			$('<button plot=r130px,b15px,100px,35px,a><svg><use href=#fa-plus /></svg></i>&nbsp;Upload</button>').click(e => {
				//upload('.js').then(files => [...files].forEach(file => file.text().then(mod => game.loadMod(mod))));
				modal('Mods are not supported.',{Ok: true});
			})
		);
		ui.update()
	});
	$('#settings button.back').click(e => {
		game.saveSettings();
		$('#settings').hide();
		$(ui.LastScene).show();
		ui.update();
	});
	$("#q button.move").click(e => { $("#q").toggle(); player.setTarget(game.getBody('#' + $("select.move").val()).position) });
	$("#q button.warp").click(e => { warp.start(new Vector2(+$("input.warp.x").val(), +$("input.warp.y").val())); $("#q").toggle(); warp.end() });
	$('#hud_ship .upgrade').click(e => {
		let s = player.data().fleet[player.data().fleet.sel], g = ship.generic[player.data().fleet[player.data().fleet.sel].type], upCost = '';
		for (let m in g.recipe[s.level + 1]) { upCost += `<br>${item[m].displayName}: ${minimize(player.data().items[m])}/${minimize(g.recipe[s.level + 1][m])}` }
		if (s.level < g.recipe.length - 1 && player.hasItems(g.recipe[s.level + 1])) { player.removeItems(g.recipe[s.level + 1]); s.level++ }
		ui.update();
	}).tooltip(e => {
		if (player.data().fleet.sel > -1) {
			let s = player.data().fleet[player.data().fleet.sel], g = ship.generic[player.data().fleet[player.data().fleet.sel].type], upCost = '';
			for (let m in g.recipe[s.level + 1]) { upCost += `<br>${item[m].displayName}: ${minimize(player.data().items[m])}/${minimize(g.recipe[s.level + 1][m])}` }
			return s.level == g.recipe.length - 1 ? `<p style=padding:10px>Max Level</p>` : `${s.level} <svg><use href=#fa-arrow-right /></svg> ${s.level + 1}<br><br><strong>Upgrade Cost:</strong>${upCost}`;
		}
	});
	$('[label]').each((i, e) => {
		let val = e.value;
		$(e).attr('ui-label', rand.hex(32))
		$(`<label>${$(e).attr('label')} ${$(e).attr('display') && e.localName == 'input' ? eval(`\`(${$(e).attr('display')})\``) : ''} </label>`).attr('for', $(e).attr('ui-label')).insertBefore($(e));
	});
	$('input[label][display]').mousemove(ui.update);
	$('#settings form.gen input[type=range]').change(e => {
		
	});
	$('body').keydown(e => {
		switch (e.key) {
			case 'F8': e.preventDefault(); open(web("bugs?report"), "target=_blank"); break;
		}
	});
	$('#cli').keydown(e => {
		let c = game.cli;
		if (c.line == 0) c.currentInput = $("#cli").val();
		switch (e.key) {
			case "ArrowUp": if (c.line > -c.prev.length) $("#cli").val(c.prev.at(--c.line)); if (c.line == -c.prev.length) if (++c.counter == 69) $("#cli").val('nice'); break;
			case "ArrowDown": c.counter = 0; if (c.line < 0) ++c.line == 0 ? $("#cli").val(c.currentInput) : $("#cli").val(c.prev.at(c.line)); break;
			case 'Enter':
				c.counter = 0;
				if ((/[^\s]/).test($("#cli").val()) && $("#cli").val() != '') {
					if (c.prev.at(-1) != c.currentInput) c.prev.push($("#cli").val());
					if ($('#cli').val()[0] == '/') game.chat(game.runCommand($("#cli").val().slice(1)))
					else game.mp ? servers.get(servers.sel).socket.emit("chat", $("#cli").val()) : player.chat($("#cli").val())
					$("#cli").val(''); c.line = 0;
				}
				break;
		}
	});
	game.canvas.click(e => { game.isPaused ? null : game.canvas[0].requestPointerLock(); ui.update() });
	game.canvas.keydown(e => {
		switch (e.key) {
			case 'F1': e.preventDefault(); $('#hud').toggle(); break;
			case 'F3': e.preventDefault(); $('#debug,#hud').toggle(); break;
			case 'F4': e.preventDefault(); game.hitboxes = !game.hitboxes; break;
		}
	});
	game.canvas.on('wheel', e => {
		if(!player.camIsActive && player.data().fleet.sel > -1){
			player.data().fleet.sel = clamp(player.data().fleet.sel + clamp(e.originalEvent.wheelDelta, -1, 1), 0, player.data().fleet.length - 1);
			Object.assign(ship.cam, {
				lowerRadiusLimit: ship.generic[player.data().fleet[player.data().fleet.sel].type].camRadius,
				upperRadiusLimit: ship.generic[player.data().fleet[player.data().fleet.sel].type].camRadius
			});
		}
	});
	
	$("#q").keydown(e => {
		if (e.key == keybind.nav || e.key == 'Escape') {
			game.changeUI('#q');
		}
	});
	$("#e").keydown(e => {
		if (e.key == keybind.inv || e.key == 'Escape') {
			game.changeUI('#e');
		}

	}).click(ui.update);
	$('canvas.game,#esc,#hud').keydown(e => {
		if (e.key == 'Escape') {
			game.changeUI('#esc', true);
			game.isPaused = !game.isPaused;
		}
		ui.update();
	});
	$(document).on('pointerlockchange', e => {
		game.scene().activeCamera[document.pointerLockElement == game.canvas[0] ? 'attachControl' : 'detachControl'](game.canvas[0], false);
	});
	$("button").click(e => { playsound(sound.ui, settings.sfx) })
	$('#e div').not('#nav,.inv').hide();

	// the loop ~~loop
	const loop = () => {
		if (saves.get(saves.sel) instanceof Save && game.currentLevel instanceof Vector2){
			if(!game.isPaused){
				try {
					game.frames++;
					warp.cooltime = Math.max(0, warp.cooltime - (1 - player.data().tech.energy / 100));
					warp.energy = Math.min(warp.maxEnergy, warp.energy + (1 + player.data().tech.energy / 20) / game.engine.getFps());
					item.multiplyer = 1 + (1 - game.difficulty);
					ship.crit = { chance: 30 + player.data().tech.missle, dmg: 50 + player.data().tech.missle * 5 };
					ship.multiplyer = {
						dmg: 1 + (1 - game.difficulty) + player.data().tech.laser * 0.1,
						hp: 1 + (1 - game.difficulty) + player.data().tech.armor * 0.15
					};

					if(player.rotation.y > pi) player.rotation.y -= 2 * pi;
					if(player.rotation.y < -pi) player.rotation.y += 2 * pi;
					if(player.cam.alpha > pi) player.cam.alpha -= 2 * pi;
					if(player.cam.alpha < -pi) player.cam.alpha += 2 * pi;
					if(player.position.x > 99999){ warp.start(new Vector2(game.currentLevel.x + 1, game.currentLevel.y)); warp.end(0, 1); player.position.x = -99999 }
					if(player.position.x < -99999){ warp.start(new Vector2(game.currentLevel.x - 1, game.currentLevel.y)); warp.end(0, 1); player.position.x = 99999 }
					if(player.position.z > 99999){ warp.start(new Vector2(game.currentLevel.x, game.currentLevel.y + 1)); warp.end(0, 1); player.position.z = -99999 }
					if(player.position.z < -99999){ warp.start(new Vector2(game.currentLevel.x, game.currentLevel.y - 1)); warp.end(0, 1); player.position.z = 99999 }
					if(game.scene().activeCamera != player.cam) player.cam.detachControl(game.canvas, false);
					if(game.scene().activeCamera != ship.cam) ship.cam.detachControl(game.canvas, false);
					if(game.scene().activeCamera == ship.cam && !isNaN(+player.data().fleet.sel)) ship.cam.target = player.data().fleet[player.data().fleet.sel].mesh().position;
					if(player.rcsIsActive) player.velocity = player.velocity.multiplyByFloats(0.9, 0.9, 0.9);
					player.cam.target = player.position;
					player.cam.angularSensibilityX = player.cam.angularSensibilityY = 2000 / settings.sensitivity;
					player.updateFleet();
					game.scene().meshes.forEach(m => {
						if (m.name != 'skybox' && isHex(m.id)) m.showBoundingBox = game.hitboxes;
					});
					let closestBody = game.scene().closestBody = null;
					for(let [id, body] of game.scene().bodies){
						if (body instanceof CelestialBody){
							closestBody = game.scene().closestBody = closestBody == null || Vector3.Distance(player.position, body.position) < Vector3.Distance(player.position, closestBody.position) ? body : closestBody;
							let distance = Vector3.Distance(player.position, closestBody.position.add(closestBody.fleetLocation));
							if(distance < 200 && !ship.battle && closestBody.owner != player.id && closestBody == body){
								ship.battle = id;
							}else if(distance > 200){
								ship.battle = null;
							}
						}
					};
					if(game.scene().bodies.get(ship.battle) instanceof CelestialBody && game.scene().bodies.get(ship.battle).owner != player.id){
						if(game.scene().bodies.get(ship.battle).fleet.length == 0){
							game.scene().bodies.get(ship.battle).owner = player.id;
							ship.battle = null;
						}else{
							player.data().fleet.forEach(s => {
								if((game.frames / game.engine.getFps() * s.reload).toFixed(1) == Math.floor(game.frames / game.engine.getFps() * s.reload)) {
									let target = game.scene().bodies.get(ship.battle).fleet[rand.int(0, game.scene().bodies.get(ship.battle).fleet.length - 1)];
									let laser = Mesh.CreateLines("laser." + rand.hex(16), [s.mesh().position.add(Vector3.Up()).add(rand.cords(1)), target.mesh().position.add(Vector3.Up())], game.scene());
									laser.color = new Color3(0, 1, 1);
									target.hp -= s.dmg / 5;
									setTimeout(e => { laser.dispose() }, s.reload * 250)
								}
							});
							game.scene().bodies.get(ship.battle).fleet.forEach((s, i) => {
								player.updateFleet();
								if(player.data().fleet.length > 0){
									if (s.hp <= 0) {
										player.giveItems(ship.generic[s.type].recipe[0]);
										if(Math.floor(player.levelOf(player.data().xp  + ship.generic[s.type].xp)) > Math.floor(player.levelOf(player.data().xp))){
											/*level up*/
											player.data().xpPoints++;
										}
										player.data().xp += ship.generic[s.type].xp;
										s.remove();
										game.scene().bodies.get(ship.battle).fleet.splice(i, 1);
									}
									else if ((game.frames / game.engine.getFps() * s.reload).toFixed(1) == Math.floor(game.frames / game.engine.getFps() * s.reload)) {
										let target = player.data().fleet[rand.int(0, player.data().fleet.length - 1)];
										let laser = Mesh.CreateLines("laser." + rand.hex(16), [s.mesh().position.add(Vector3.Up()).add(rand.cords(1)), target.mesh().position.add(Vector3.Up())], game.scene());
										laser.color = new Color3(1, 0, 0);
										target.hp -= s.dmg / 5;
										rand.int(0, 5) == 0 ? playsound(sound.laser_hit, settings.sfx) : 0;
										setTimeout(e => { laser.dispose() }, s.reload * 250)
									}
								}
							});
						}
					}else{
						player.data().fleet.forEach(s => {
							let healAmount = ship.generic[s.type].hp / (1000 - player.data().tech.regen * 10);
							if(s.hp + healAmount <= ship.generic[s.type].hp) s.hp += healAmount;
						});
					}
					player.updateFleet();
					player.data().fleet.forEach((s, i) => {
						s.position.addInPlace(new Vector3(s.velocity.x / game.engine.getFps(), s.velocity.y / game.engine.getFps(), s.velocity.z / game.engine.getFps()));
						if(player.rcsIsActive) s.velocity = s.velocity.multiplyByFloats(0.9, 0.9, 0.9);
						s.mesh().position = player.position.add(player.getDirection(s.position));
						s.mesh().rotation = player.rotation.add(s.rotation);
					});
					player.position.addInPlace(new Vector3(player.velocity.x / game.engine.getFps(), player.velocity.y / game.engine.getFps(), player.velocity.z / game.engine.getFps()));
					$('#hud p.level').text(Math.floor(player.levelOf(player.data().xp)));
					$('#hud .xp rect').attr('width', (player.levelOf(player.data().xp) % 1 * 100) + '%');
					$("#debug .left").html(`
						<span>${game.version} ${game.mods.length ? `[${game.mods.join(", ")}]` : `(vanilla)`}</span><br>
						<span>FPS ${game.engine.getFps().toFixed()}</span><br>
						<span>${saves.sel} (${saves.get(saves.sel).date.toLocaleString()}) L: ${Object.keys(saves.get(saves.sel).levels).length} S: ${Object.keys(saves.get(saves.sel).systems).length}</span><br><br>
						<span>P: ${player.position.toFixed(1).display()} V: ${player.velocity.toFixed(1).display()} R: ${player.rotation.toFixed(2).display('xy')}</span><br>
						<span>C: (${player.cam.alpha.toFixed(2)}, ${player.cam.beta.toFixed(2)}) r: ${player.cam.radius.toFixed(1)} m: ${player.camIsActive ? 'player' : 'ship'}</span><br><br>
						<span>LVL ${game.currentLevel.display()} ${game.scene().name} B: ${game.scene().bodies.size}</span><br>
						<span>${ship.battle} ${ship.battle ? game.scene().bodies.get(ship.battle).fleet.length : 0}/${[...game.scene().bodies.values()].reduce((a, c) => a + c.fleet.length, 0)}</span><br>
					`);
					$("#debug .right").html(`
						<span>Babylon v${Engine.Version} | jQuery v${$().jquery}</span><br>
						<span>${navigator.platform}</span><br>
						<span>${game.engine._glRenderer}</span><br>
						<span>${(performance.memory.usedJSHeapSize / 1000000).toFixed()}MB/${(performance.memory.jsHeapSizeLimit / 1000000).toFixed()}MB (${(performance.memory.totalJSHeapSize / 1000000).toFixed()}MB Allocated)</span><br>
						<span>${navigator.hardwareConcurrency} CPU Threads</span><br><br>
						<span>${closestBody.name} ${closestBody.position.toFixed(1).display('xz')} ${Vector3.Distance(player.position, closestBody.position)?.toFixed(1)} | ${Vector3.Distance(player.position, closestBody.position.add(closestBody.fleetLocation)).toFixed(1)}</span><br>
						<span>${player.targetBody ?? ''}</span><br><br>
						<span>Selected ship: ${player.data().fleet[player.data().fleet.sel] ? `
						<span>${player.data().fleet[player.data().fleet.sel].id} (${player.data().fleet[player.data().fleet.sel].type}) ${player.data().fleet.sel + 1}/${player.data().fleet.length}</span><br>
						<span>P: ${player.data().fleet[player.data().fleet.sel].position.toFixed(1).display()} V: ${player.data().fleet[player.data().fleet.sel].velocity.toFixed(1).display()} R: ${player.data().fleet[player.data().fleet.sel].mesh().rotation.toFixed(2).display('xy')}</span><br>
						<span>Lvl: ${player.data().fleet[player.data().fleet.sel].level}/${ship.generic[player.data().fleet[player.data().fleet.sel].type].recipe.length - 1} Hp: ${player.data().fleet[player.data().fleet.sel].hp.toFixed(1)}/${ship.generic[player.data().fleet[player.data().fleet.sel].type].hp.toFixed(1)}</span><br>
						`: ' none'}
					`);
					let fleetVol = Vector3.Zero();
					player.data().fleet.forEach(s => { if (s.mesh()) fleetVol.addInPlace(Mesh.sizeOf(s.mesh())) });
					ship.fleetSize = new Vector3(Math.min(fleetVol.x, 250), Math.min(fleetVol.y, 15), Math.min(fleetVol.z, 100));
		
					game.scene().render();
				} catch (err) { console.error(`loop() failed: ${err.stack ?? err}`) }
			}
		}
		settings = $('#settings form.gen').formData();
		worldgen = $('#save form').formData();
	};
	ui.update()
	$('#loading_cover').fadeOut(1000);
	console.log('Game loaded successfully');
	game.engine.runRenderLoop(loop);
	</script>
</html>