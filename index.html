<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="/libraries/fa5.css">
		<link rel="icon" href="/icon.png" type="image/png">
		<style>
	        .fa:hover{cursor:pointer}
			form input{position:absolute;left:50%}
			form label{position:absolute;left:10%;width:37.5%;text-align:right}
			#chat li{background:none;list-style:none}
			[cover]{position:fixed;left:0%;top:0%;width:100%;height:100%}
			#loadcover{z-index:11}
			#gamecover{z-index:0}
			#e ul{position:absolute;top:15%;left:2.5%;width:90%;height:80%}
        </style>
		<link rel="stylesheet" href="/libraries/styles.css">
	</head>
	<body id="body" oncontextmenu="return false;">
		<a id="download_link" style="display:none;position:absolute;left:60%;top:480px;"><button>Save Game</button></a>
		<audio><source src="" type="audio/mp3"></audio>
		<div id="loadcover" style="background-color:#252525;color:#ebebeb" cover><center><br><br><br><br><br><p style="font-size:25px;font-family:sans-serif">Loading...</p></center></div>
		<div id="gamecover" cover starbg></div>
		<input id="cli" style="position:fixed;left:5%;top:90%;width:25%;height:5%;z-index:10;display:none">
		<ul lsn id="chat" style="position:fixed;top:5%;width:30;height:75%;background:none;box-shadow:none;z-index:10"></ul>
		<div id="main" starbg cover>
            <h1 class="title" style="font-family:azonix;font-size:60px;position:absolute;top:15%;left:25%;width:50%;"><center>Blankstorm</center></h1>
			<button class="sp" style="position:fixed;left:37.5%;top:45%;width:25%;height:8%;">Singleplayer</button>
			<button class="mp" style="position:fixed;left:37.5%;top:60%;width:25%;height:8%;">Multiplayer</button>
            <button class="options" style="position:fixed;left:37.5%;top:75%;width:12.4%;height:8%;">Options</button>
			<a href="/"><button class="exit" style="position:fixed;left:50%;top:75%;width:12.4%;height:8%;">Exit</button></a>
            <p class="version" style="position: fixed;left:90%;top:90%">[version]</p>
		</div>
        <!-- save/server markup -->
		<ul id="load" hide lsn content style="overflow:scroll"></ul>
		<div id="save" cover nobg hide>
			<div content>
				<i class="fa fa-times" style="position:absolute;left:95%;top:5%;font-sze:30px"></i>
				<input placeholder="save name" class="name" style="position:absolute;left:30%;top:10%;width:40%;height:5%">
				<button class="new" style="position:absolute;left:35%;top:80%;width:30%;height:7.5%">Start</button>
				<form name="worldgen" nobg style="position:absolute;left:10%;top:20%;width:80%;height:50%">
					<input type="range" name="size" label="Max world size" min="100" max="1000" step="100" value="500"><br><br>
					<input type="range" name="planets" label="Max planets per level" min="1" max="9" step="1" value="9"><br><br>
					<input type="range" name="difficulty" label="Difficulty" min="0.5" max="2" step="0.5" value="1"><br><br>
					<input type="range" name="quality" label="Quality" min="32" max="256" step="32" value="128"><br><br>
				</form>
			</div>
		</div>
		<div id="server" hide content>
			<i class="fa fa-times" style="position:absolute;left:95%;top:5%;font-sze:30px"></i>
            <form name="serverOptions">
                <input placeholder="display name" name="displayName"  style="position:absolute;left:30%;top:10%;width:40%;height:5%;">
                <input placeholder="server url" name="id" style="position:absolute;left:30%;top:20%;width:40%;height:5%;">
            </form>
			<button class="new" style="position:absolute;left:35%;top:80%;width:30%;height:7.5%;">Save</button>
		</div>
		<ul id="tips" hide lsn nobg style="position:fixed;left:25%;top:20%;width:50%;height:60%;border:0;text-align:center;">
			<li><br>Access the shipyard, inventory, lab, and map by pressing e</li>
			<li><br>Pause the game with esc</li>
			<li><br>Attack planets after building a fleet</li>
			<li><br>get more info on the <a href="https://annihiation.drvortex.dev/wiki" target="_blank">wiki</a></li>
			<button style="position:fixed;left:40%;top:75%;width:20%;height:7.5%;">Start the Game</button>	
		</ul>
        <!-- Inventory Tabs -->
		<div id="e" content hide style="z-index:5">
			<div id="nav" style="box-shadow:none;position:absolute;left:5%;top:5%;width:90%;height:7.5%">
				<button class="inv" style="position:absolute;width:20%;top:5%;height:90%;left:2.5%"><i class="fa fa-box" aria-hidden="true"></i> Items</button>
				<button class="map" style="position:absolute;width:20%;top:5%;height:90%;left:27.5%"><i class="fa fa-map" aria-hidden="true"></i> Map</button>
				<button class="yrd" style="position:absolute;width:20%;top:5%;height:90%;left:52.5%"><i class="fa fa-wrench" aria-hidden="true"></i> Shipyard</button>
				<button class="lab" style="position:absolute;width:20%;top:5%;height:90%;left:77.5%"><i class="fa fa-flask" aria-hidden="true"></i> Lab</button>
			</div>
			<ul class="inv" lsn></ul>
			<ul class="map" lsn hide><canvas hide class="map"></canvas><center><p>This has not been implemented.<br> It will be added in a future release.<br><a href="javascript:showMap()" style="color:hsla(200,50%,25%,1);text-shadow:none;">Show Map</a></p></center></ul>
        	<ul class="yrd" lsn hide></ul>
			<ul class="lab" lsn hide></ul>
		</div>
        <div id="attack" hide style="position:fixed;left:10%;top:10%;width:80%;height:80%;z-index:3;">
			<center>
			<i class="fa fa-times-circle" style="position:absolute;left:95%;top:1%;font-size:35px;"></i>
			<p style="position:absolute;left:30%;top:60%;font-size:20px;"></p>
			<button style="position:absolute;left:30%;top:80%;width:40%;height:10%">Attack</button>
            </center>
		</div>
		<div id="report" hide content style="z-index:2">
			<center/>
				<i class="fa fa-times-circle" style="position:absolute;left:95%;top:1%;font-size:35px;"></i>
				<p style="position:absolute;left:30%;top:40%;font-size:20px;"></p>
				<button style="position:absolute;left:30%;top:80%;width:40%;height:10%">Accept</button>
		</div>
		<canvas class="game" hide cover style="z-index:0"></canvas>
		<div id="debug" hide nobg>
			<p style="position:fixed;left:1%;top:0;width:48%" class="game"></p>
			<p style="position:fixed;left:1%;top:20%;width:48%" class="player"></p>
			<p style="position:fixed;left:49%;top:0;width:50%;text-align:right;" class="system"></p>
		</div>
		<div id="esc" hide style="position:fixed;left:40%;width:20%;top:25%;height:50%;z-index:10">
			<button class="resume" style="position:absolute;left:10%;top:20%;width:80%;height:15%">Resume&nbspGame</button>
			<button class="options" style="position:absolute;left:10%;top:40%;width:80%;height:15%">Options</button>
			<button class="quit" style="position:absolute;left:10%;top:60%;width:80%;height:15%">Main&nbspMenu</button>
		</div>
		<form id="settings" name="settings" hide content>
			<button style="position: absolute;left: 5%; width: 15%;top:90%;height: 5%;"><i class="fa fa-arrow-left" aria-hidden="true"></i> Back</button>
			<h2 style="text-align:center">Settings</h2>
			<input type="range" name="fontSize" label="Font Size" min="10" max="20" step="1" value="13"><br><br>
			<input type="checkbox" name="devMode" label="Developer Mode"><br><br>
			<input type="range" name="chatTimeout" label="Chat Timeout" min="2.5" max="7.5" step="0.5" value="5"><br><br>
			<input type="range" name="fps" label = "FPS" min="10" max="110" step="5" value="60">
		</form>
	</body>
    <div id="libraries">
        <script class="jquery" src="/libraries/jquery.js"></script>
        <script class="babylon" src="/libraries/babylon.min.js"></script>
        <script class="loaders" src="/libraries/babylon.loaders.js"></script>
    </div>
	<script>
	$("[label]").each(function(i){$(this).before($(`<label class="${this.name}">${$(this).attr("label")}</label>`))});
        
    //Prototype plugins
	const def = (d,p,v) => {Object.defineProperty(d,p,{value:v,enumerable:!1})};
	for(let  i of ["Object","Array","String","Boolean","Number","Date"]){def(window[i],"fn",window[i].prototype)};
	def(Object.fn,"hide",function(...p){for(let i of p){Object.defineProperty(this,i,{enumberable:!1})}});
	def(Object.fn,"ro",function(...p){for(let i of p){Object.defineProperty(this,i,{writable:!1})}});
	def(Object.fn,"assign",function(...objs){for(let i of objs){Object.assign(this,i)}});
	def(Array.fn,"total",function(){return eval(this.join("+"))});
    def(Number.fn,"toStar",function(){var s="";for(let i=0;i<this;i++){s+="*"};return s});
    def(String.fn,"isHex",function(){return /^[0-9a-f]+$/.test(this)});
	def(String.fn,"isJSON",function(){try{JSON.parse(this);return !0}catch(e){return !1}});
	Date.fn.assign({
		today:()=>{let d = new Date();return `${d.getFullYear()}/${parseFloat(d.getMonth())+1}/${d.getDate()}`},
		now:()=>{let d = new Date();return `${d.today()} ${d.getHours()}:${(d.getMinutes() < 10)?`0${d.getMinutes()}`:d.getMinutes()}`},
	});
	Object.fn.toString = Array.fn.toString = function(){return JSON.stringify(this)};
		
	window.assign(BABYLON);
	//JQuery plugins
    $.fn.obj = function(){
		let o = {};
		for(let i = 0;i<this.length;i++){
			for(let j = 0;j<this[i].length;j++){
				let e = this[i][j];
				if(e.localName == "input"){
					switch(e.type){
						case "range":o[e.name] = Number(e.value);break;
						case "checkbox":o[e.name] = e.checked;break;
						default:o[e.name]=e.value
					}}}}
		return o
	};
	$.fn.loadData = function(obj){
		for(let i = 0;i<this.length;i++){
			for(let j = 0;j<this[i].length;j++){
				let e = this[i][j];
				if(e.localName == "input"){
					(e.type == "checkbox") ? e.checked = obj[e.name] : e.value=obj[e.name];
				}}}
	};
    $.fn.tooltip = function(info = "",style = ""){
		let sel = "div,button,li,ul,ol";
        let css = $(style || (this.is(sel) ? this : this.parents().filter(sel).eq(0)));
        let tt = $(`<div class="tooltip" style="${style}"><p>${info}</p></div>`)
		.css(css.css(["position","left","width"]))
		.css({"z-index":9,"font-size":settings.fontSize,"font-family":"sans-serif"});
		tt.css("top",parseFloat(tt.css("top")) - parseFloat(css.css("height")) - settings.fontSize * (info.split("<br>").length-1));
        this.on("mouseenter",()=>{this.append(tt);tt.css("width",css.css("width"))}).on("mouseleave",()=>{tt.remove()});
		return tt
    };
		
	//variables ~~vars
        
    //input/api vars
    const key = {pressed:!1};
	const width = innerWidth;
	const height = innerHeight;
    const mouse = {x:0,y:0,pressed:!1};
    const ls = localStorage;
    const on = addEventListener;
    const trigger = event => {dispatchEvent(event)};
	let gl = $("<canvas></canvas>")[0].getContext("webgl") || $("<canvas></canvas>")[0].getContext("experimental-webgl");
    let time = 0;
    const date = new Date(), $d = new Date();
	const system = {
		gpu: gl.getParameter(gl.getExtension("webgl_debug_renderer_info").UNMASKED_RENDERER_WEBGL),
		ram: {
			used:()=>performance.memory.usedJSHeapSize,
			allocated:()=>performance.memory.totalJSHeapSize,
			max:()=>performance.memory.jsHeapSizeLimit,
			get used(){},get allocated(){},get max(){},
		},
		cpu: navigator.hardwareConcurrency,
		platform: navigator.platform,
		online: navigator.onLine,
		
	};
	navigator.userAgentData.getHighEntropyValues(["model","platform","platformVersion","uaFullVersion"])
	.then(ua => {system.assign({model:ua.model,os:ua.platform,osVersion:ua.platformVersion,browserVersion:ua.uaFullVersion})});
	onmousemove =e=>{mouse.x = e.clientX;mouse.y = e.clientY};
    setInterval(()=>{time+=10},10);
        
    //math vars
    const round = Math.round;
	const clamp = (num, min, max) => Math.min(Math.max(num, min), max);
    const rand = {
		float: (min=0,max=1)=>rand.real * (max - min) + min,
		hex: (length=1) => {let c = ["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];let s = "";for(let i = 0;i<length;i++){s += c[rand.int(15)]}return s;},
		get bool(){let b = Math.round(rand.real);return b?!0:!1},
		bin: (length=1) => {let b = "";for(let i = 0;i<length;i++){b += rand.int(0,1)}return b;},
		int: (min=0,max=1) => Math.round(rand.real * (max - min) + min),
		get real(){return Math.random()},
	};
	const greek = ["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"];
    const numeral = ["","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX","XXI","XXII","XXIII","XXIV","XXV","XXVII","XXVII","XXVIII","XXIX","XXX","XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL","XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L","LI","LII","LIII","LIV","LV","LVI","LVII","LVIII","LIX","LX","LXI","LXII","LXIII","LXIV","LXV","LXVI","LXVII","LXVIII","nice","LXX","LXXI","LXXII","LXXIII","LXXIV","LXXV","LXXVI","LXXVII","LXXVIII","LXXIX","LXXX","LXXXI","LXXXII","LXXXIII","LXXXIV","LXXXV","LXXXVI","LXXXVII","LXXXVIII","LXXXIX","XC","XCI","XCII","XCIII","XCIV","XCV","XCVI","XCVII","XCVIII","XCIX","C"];
    const minimize = min = number => {
        let n = number;let l = ["","K","M","B","T","q","Q","s","S","O","N","D"];
        if(typeof n != "number"){n = Number(n)}
        if(n < 0 || n > Number(`1e${(l.length-1)*3}`)){return n}
		for(let i = 0;i<l.length;i++){
            let d = Number(`1e${i*3}`)/1000;
            if(n < d){return round(n/d)+l[i]}
        }
 	};
	const range = (min,max)=>{let a = [];for(let i = min;i<max;i++){a.push(i)}return a};
        
    //markup funations
	const tab = a => {var o="";for(let i=0;i<a;i++){o += "&nbsp";if(i == a-1){return o}}};
	const br = a => {var o="";for(let i=0;i<a;i++){o += "<br>";if(i == a-1){return o}}};
        
    //game vars
	let [settings,worldgen,item,tech,server,save] = [$("#settings").obj(),$("#save form").obj(),{},{},{},{}];
	const level = {num: 65, names: ["Crash Site", "Abrigato", "A Keralis","B Keralis", "Suzum", "Vespa", "Coruscare", "Vulca", "Jaeger", "Kashyyyk", "Outpost42","Victoria", "Gesht", "Sanctuary", "Snowmass", "Ja", "Keeg", "Haemeiguli", "Borebalae", "Albataetarius", "Hataerius", "Achernaiphoros", "Antadrophei", "Hoemeirai", "Antabalis", "Hoereo", "Pazadam", "Equidor", "Pax", "Xena", "Titan", "Oturn", "Thuamia", "Heuthea", "Ditharus", "Muxater", "Trukovis", "Bichotune", "Etis", "Leorus", "Aphus", "Harophos", "Athena", "Hades", "Icarus", "Ureus", "Xentos Prime", "Ketlak", "Aerox", "Thryox", "Stratus", "Nox", "Sanctum", "PastÅ«ra", "Tinctus", "Morbus", "Neos", "Nomen", "Numerus", "Pax", "Fornax", "Skorda", "Alli", "Resurs","Home!"]}
	const game = new Engine($("canvas.game")[0],!0);
	game.assign({
		canvas: $("canvas.game")[0],
		version:"Indev",snapshot:"2",difficulty:1,
		mods:[],event:{},frames:0,functions:{},lvl:0,
		isPaused:!1,mp:!1,mpDisabled:!0,phpEnabled:!1,
		scene:new Scene(game),getScene:()=>save?.[save.sel]?.level?.[0]||game.scene,
		cli: {isShown: false, prev: [], line:0,i: $("#cli").val(),cv:{}},
		build: (s="",e="")=>{return `${game.version} ${game.snapshot?s+game.snapshot+e:""}`},
		acs:cmd=>{for(let i of game.functions[cmd].split("\n")){acs(i)}},
        log:(msg,col="#ebebeb")=>{console.log("%c"+msg,`color:${col}`)},
		err:msg=>{console.error("%cGame Error: "+msg,"color:#fff")},
		warn:msg=>{console.warn("%c"+msg,"color:#fff")},
		chat:msg=>{
			let m = $(`<li>${msg}</li>`).appendTo($("#chat"));
			setTimeout(()=>{m.fadeOut(2000,()=>{m.remove()})},settings.chatTimeout*1000);
		}
	});
	game.scene.name = "GAME_DEFAULT_SCENE";
	const player = new UniversalCamera("player", new Vector3(0,0,-150), game.scene);
	player.assign({
		name: "",speed: 1,saves: [],servers: [],
		move:(x,y,z)=>{player.position.addInPlace(player.getDirection(new Vector3(x,y,z)))},
		reset: () => {player.position = new Vector3(0,0,-150);player.rotation = Vector3.Zero();},
		wipe:()=>{
			for(let i in item){item[i].amount = 0};
			for(let i in tech){tech[i].level = 0};
			for(let i =0;i<planet.length;i++){planet[i].taken = 0};
			ship.fleet = []
		}
	});
    const ship = {
        generic: {},fleet: [],frozen: 0,battle:{active: !1,won: null},
        num: filter =>{let count = 0;for(let i=0;i < ship.fleet.length;i++){if(ship.fleet[i].type == filter){count++;}}return count}
    };
	const warp = {
		start: lvl => {warp.is = !0;warp.to = lvl;},//warps to level
		end: fell => {warp.is = !1;game.lvl = warp.to;player._scene = save[save.sel].level[warp.to];player.reset()},//ends warp
		show: (speed=2000) => {let i=0;let show = setInterval(()=>{if(i >= save[save.sel].level.length){clearInterval(show);player.attachControl(game.canvas,!1)}else{player.lockedTarget = Vector3.Zero();game.lvl = i;player._scene = save[save.sel].level[i];i++}},speed)},
		is:false
		
	};
	if(ls.settings?.isJSON()){settings = JSON.parse(ls.settings);$("#settings").loadData(settings)}
	def(tech,"price",techtype=>{let t = techtype;let p = tech[t].cost;for(let i = 1;i<tech[t].level;i++){p*=tech[t].inc};return p});
	def(tech,"locked",techtype=>{let t = techtype;let l = !1;for(let i in tech[t].requires){if(tech[i].level < tech[t].requires[i]){l = !0}}return l});
	def(item,"multiplyer",1+(1-settings.difficulty));
	game.ro("version","mpDisabled","phpEnabled","snapshot");
	onresize =e=>{game.resize();game.warn("Do not paste any code someone gave you, as they may be trying to steal your information")};
    player.setTarget(Vector3.Zero());
    
    //default data
	const mod = {
		default: {
			ships:{
				corvette:{
					health:10,damage:1,reload:2,level:0,maxLevel:5,power:1,
					displayName:"Corvette",desc:"A light, fast blockade runner",
                    cost:{metal:1000,minerals:500,fuel:250},
                    upgradeCost:{ancient_tech: [1,2,4,8,16,32],code_snippets: [1,2,5,10,20,35]}
				},
				frigate:{
                    health:25,damage:5,reload:1,level:0,maxLevel:5,power:2,
					displayName:"Frigate",desc:"idk",
					cost: {metal:2000,minerals:2000,fuel:500},
                    upgradeCost:{ancient_tech: [2,4,7,9,12,15],code_snippets: [5,10,20,30,35,40]}
				},
				crusier:{
                    health:50,damage:10,reload:0.5,level:0,maxLevel:5,power:5,
					displayName:"Crusier",desc:"idk",
					cost: {metal:4000,minerals:1000,fuel:1000},
                    upgradeCost:{ancient_tech: [3,5,8,12,18,26],code_snippets: [10,20,30,40,50,60]}
				},
				destroyer:{
                    health:100,damage:25,reload:1,level:0,maxLevel:5,power:10,
					displayName:"Destroyer",desc:"A versitile ship, it can hold its own in battle.",
					cost: {metal:10000,minerals:4000,fuel:2500},
                    upgradeCost:{ancient_tech: [8,12,20,35,60,75],code_snippets: [25,40,60,85,100,125]}
				},
				battleship:{
                    health:250,damage:100,reload:0.5,level:0,maxLevel:5,power:25,
					displayName:"Battleship",desc:"Once in a battle, in can stay there and deal out damage for a long time",
					cost: {metal:25000,minerals:10000,fuel:5000},
                    upgradeCost:{ancient_tech: [10,25,45,70,100,135],code_snippets: [20,25,40,55,70,85]}
				},
				dreadnought:{
                    health:1000,damage:250,reload:0.25,level:0,maxLevel:5,power:100,
					displayName:"Dreadnought",desc:"The mother of all ships. Dominates everything it touches",
					cost: {metal:100000,minerals:50000,fuel:25000},
                    upgradeCost:{ancient_tech: [25,50,100,150,250,400],code_snippets: [50,75,88,100,125,150]}
				}
			},
            items:{
				metal: {displayName:"Titanium",desc:"",rare:!1,value:1},
				minerals: {displayName:"Crystal",desc:"",rare:!1,value:2},
				fuel: {displayName:"Fuel",desc:"",rare:!1,value:4},
				tech_points: {displayName:"Research Points",desc:"",rare:!1,value:100},
				ancient_tech: {displayName:"Ancient Tech",desc:"",rare:!0,drop:0.1,value:1000},
				code_snippets: {displayName:"Code Snippets",desc:"",rare:!0,drop:0.1,value:1000},
			},
			tech:{
				armor:{level:0,cost:5,inc:1.2,max:50,displayName:"Armor",desc:"Increases health <br>+15% per level"},
				laser:{level:0,cost:5,inc:1.2,max:50,displayName:"Weapons",desc:"Increases base damage <br>+10% per level"},
				reload:{level:0,cost:5,inc:1.2,max:50,displayName:"Reload",desc:"Decreases time between shots"},
				shields:{level:0,cost:10,inc:1.25,max:25,requires:{armor:5},displayName:"Shields",desc:"Increases shields<br>+20% per level"},
				missle:{level:0,cost:10,inc:1.25,max:25,requires:{laser:5},displayName:"Missles",desc:"Increases crit chance and crit damage<br>+1% crit chance<br>+5% crit damage"},
				regen:{level:0,cost:10,inc:1.25,max:25,requires:{reload:5,armor:15},displayName:"Regeneration",desc:"Increases regen rate<br>+1% per level"},
				construction:{level:0,cost:10,inc:1.25,max:50,requires:{armor:10},displayName:"Construction",desc:"Decreases ship material cost"},
				salvage:{level:0,cost:20,inc:1.25,max:25,requires:{construction:5},displayName:"Salvage",desc:"Increases chance for rare items<br>+2% per level"}
			}
		}
	};

	//Some stuff done on initalization
	document.title = "Blankstorm "+game.version;
    $("#main .version").html(game.version);
	game.log(`Blankstorm ${game.build("(",")")}`,`#f55;padding:${settings.fontSize}px;text-align:center`);  

	//load mods into the game
	for(let i in mod){
		if(i != "default"){game.mods.push(i)}
		for(let j in mod[i]){
        switch(j){
            case "ships":ship.generic.assign(mod[i][j]);break;
            case "items":item.assign(mod[i][j]);break;
			case "tech":tech.assign(mod[i][j]);break;
			case "styles":for(let k in mod[i][j]){$(":root").css("--"+k,mod[i][j][k])};break;
			case "functions":for(let k in mod[i][j]){game.acsFunct[k] = mod[i][j][k]};break;
            default: console.warn(`mod "${i}" has invalid property "${j}"`)
        }
    }}
	const gen = {
		enemies: power => {//enemy spawning algorithm
			let e=[],p=[];
			for(let i in ship.generic){p.push(ship.generic[i].power)}
			p.sort((c1,c2)=>{if(c1 > c2){return -1}else if(c2 > c1){return 1}else{return 0}});
			for(let i=0;i<p.length;i++){for(let j in ship.generic){(p[i] == ship.generic[j].power)?p[i]=j:0;}}
			for(let i=0;i<p.length;i++){
				for(let j=0;j<Math.floor(power/ship.generic[p[i]].power);j++){
					e.push(p[i]);power -= ship.generic[p[i]].power
				}
			}
			e.power = power;
			return e
		},
		items: (quantity=0,rares) => {
			let q = quantity;
			let r={};
			for(let i in item){
				(item[i].rare)?(rand.real < item[i].drop && rares)?r[i] = quantity/item[i].value:r[i]=0:r[i] = quantity/item[i].value;
			}
			return r;
		}
	};
    
    const ui = {//ui functions ~~ui
        load: {
            get back(){
                let b = $(`<button style="position:absolute;left:5%;top:90%;width:15%;height:5%;"><i class="fa fa-arrow-left" aria-hidden="true"></i> Back</button>`)
				.click(()=>{$("#load").hide();$("#main").show()});return b
            },
            get new(){
                let b = $(`<button style="position:absolute;left:80%;top:90%;width:15%;height:5%;"><i class="fa fa-plus" aria-hidden="true"></i> New</button>`)
                .click(()=>{if(game.mp){$("#load").hide();$("#server").show()}else{$("#load").hide();$("#save").show()}});return b
            },
            li: (id,info,info2,info3)=>$(`<li id="load_li_${id}" class="clickable bg">
                <p style="display:inline-flex;font-size:18px;position:relative;left:10%;">${info}</p>
                <p style="display:inline-flex;font-size:18px;position:relative;left:30%;">${info2}</p>
                <p style="display:inline-flex;font-size:18px;position:relative;left:70%;">${info3}</p>
            </li>`),
            save: s => {
                let container = ui.load.li("#save_"+s.id,s.name,s.data,s.version);
                container.click(()=>{for(let i in save.info){if(i == s.id){save.sel = i;container.addClass("selected")}else{$("#save_"+i).removeClass("selected")}}});
                container.on("dblclick",()=>{
                    if(s.version == game.version){for(let i in s){if(i!="name"&&i!="date"&&i!="type"&&i!="version"){window[i] = s[i]}}$("#load").hide();$(game.canvas).show();game.resize();view = "map"}
                    else{alert(`That save is not supported in the current version (${game.version})`)}
                });
                container.on("contextmenu",()=>{
                    for(let i in save.info){if(save.info[i].name == name){save.sel = i;container.addClass("selected")}else{$("#save_"+i).removeClass("selected")}}
                    let menu = $(`<div class="cm" style="position:fixed;left:${mouse.x}px;top:${mouse.y}px"></div>`);
                    $('<button style="margin:10px 10px 5px 10px;">Download</button>').click(()=>{$("#download_link")[0].click()}).appendTo(menu);
                    $('<button style="margin:10px 5px 10px 10px;">Delete</button>').click(()=>{
                        if(confirm("Are you sure you want to delete this save?")){$(`[id="save_${s.id}"]`).remove();save.info.splice(save.sel,1);ls.saves = save.info;save.sel = null}
                    }).appendTo(menu);
                    container.parent().append(menu);
                });
                $("#load").prepend(container);
            }
        },
        ship:shiptype=>{
			let t = shiptype;let ct = "";let uct = "";
			for(let m in ship.generic[t].cost){ct += `<br>${item[m].displayName}: ${min(item[m].amount)}/${min(ship.generic[t].cost[m])}`}
			for(let m in ship.generic[t].upgradeCost){uct += `<br>${item[m].displayName}: ${round(item[m].amount)}/${round(ship.generic[t].upgradeCost[m])}`}
            let l = $(`<li class="clickable bg ${t}"></li>`);
			let u = $(`<i style="display:inline-flex;position:relative;left:10%;font-size:25px" class="fa fa-arrow-circle-o-up" aria-hidden="true"></i>`).appendTo(l);
			let i = $(`<i style="display:inline-flex;position:relative;left:80%;font-size:25px" class="fa fa-info-circle" aria-hidden="true"></i>`).appendTo(l);
			let d = $(`<p style="display:inline-flex;position:relative;left:35%">[${ship.num(t)}]&nbsp${ship.generic[t].displayName}</p>`).appendTo(l);
			i.tooltip(`${ship.generic[t].desc}<br><strong>Material Cost</strong>${ct}`,i);
			u.tooltip(`<br><strong>Upgrade Cost</strong>${uct}`,u);
            u.click(()=>{
                let hasItems = !0;
                for(let j in ship.generic[t].upgradeCost){if(item[j]){if(item[j].amount < ship.generic[t].upgradeCost[j] || !hasItems){hasItems=!1}}else{alert(`item ${j} does not exist`)}}
                if(ship.generic[t].level < ship.generic[t].maxLevel && hasItems){for(let j in ship.generic[t].upgradeCost){item[j].amount -= ship.generic[t].upgradeCost[j]}ship.generic[t].level++}
            });
			l.click(()=>{
                let hasItems = !0;
                for(let j in ship.generic[t].cost){if(item[j]){if(item[j].amount < ship.generic[t].cost[j]*(1-tech.construction.level/100) || !hasItems){hasItems=!1}}else{alert(`item ${j} does not exist`)}}
                if(hasItems){for(let j in ship.generic[t].cost){item[j].amount -= ship.generic[t].cost[j]*(1-tech.construction.level/100)}ship.new(t)}
				d.html(`[${ship.num(t)}]&nbsp${ship.generic[t].displayName}`);
            });
            return l;
        },
        lab:techtype=>{
            let t = techtype;let i = "";
            if(tech.locked(t)){i = `<i class="fa fa-lock" style="display:inline-flex;position:relative;left:10%" aria-hidden="true"></i>`}
            return $(`<li class="clickable bg">${i}<p style="display:inline-flex;position:relative;left:35%">${tech[t].displayName}</p></li>`).click(()=>{
                if(item.tech_points >= tech.price(t) && tech[t].level < tech[t].max){if(typeof tech[t].requires == "object"){if(!tech.locked(t)){item.tech_points -= tech.price(t);tech[t].level++}}}})
        },
        lastScene: "#main"
    };
        
	//the command processor ~~acs
	const acs = cmd => {
		let c = cmd.split(" ");
		switch(c[0]){
			case "help":
				game.chat(`
					Commands: customVar(cv), item, tech, ship, player, echo. <br>
					see the <a href="https://blankstorm.drvortex.dev/api/commands" target="_blank">API Reference</a> for for details
				`)
				break;
			case "exec":game.functions[c[1]]?game.acs(c[1]):game.chat(`function "${c[1]}" does not exist`);break;
			case "item":switch(c[1]){
					case "amount":c[3]?item[c[2]].amount = parseFloat(c[3]):game.chat(`item "${c[2]}" amount: ${item[c[2]].amount}`);break;
					case "recipe":c[3]?item[c[2]].recipe = JSON.parse(c[3]):game.chat(`item "${c[2]}" recipe: ${item[c[2]].recipe}`);break;
					default:game.chat(item[c[2]]);
				}break;
			case "tech":
				switch(c[1]){
					case "lvl":c[3]?tech[c[2]].level = parseFloat(c[3]):game.chat(`tech "${c[2]}" level: ${tech[c[2]].level}`);break;
					case "rq":c[3]?tech[c[2]].requires = JSON.parse(c[3]):game.chat(`tech "${c[2]}" requirements: ${item[c[2]].requires}`);break;
					default:game.chat(tech[c[2]]);
				}break;
			case "ship":
				switch(c[1]){
					case "new":ship.new(c[2]);break;
					case "count":game.chat(`amount of ship type "${c[2]}": ${ship.num(c[2])}`);break;
					case "stats":game.chat(`ship stats for ship ${c[2]}: ${ship.fleet[c[2]]}`);break;
					case "recipe":c[3]?ship.generic[c[2]].cost = JSON.parse(c[3]):game.chat(`ship "${c[2]}" recipe: ${ship.generic[c[2]].cost}`);break;
					case "upgrade":c[3]?ship.generic[c[2]].upgradeCost = JSON.parse(c[3]):game.chat(`ship "${c[2]}" recipe: ${ship.generic[c[2]].upgradeCost}`);break;
					default:game.chat(ship.generic[c[2]]);
				}break;
			case "player":
				switch(c[1]){
					case "help":game.chat("player  subcommands: speed");break;
					case "speed":c[2]?player.speed = parseFloat(c[2]):game.chat(`player speed: ${player.speed}`);break;
					case "pos":case "tp":(c[2]&&c[3]&&c[4])?player.position = new Vector3(parseFloat(c[2]),parseFloat(c[3]),parseFloat(c[4])):0;break;
					case "wipe":player.wipe();
					case "reset":player.reset();break;
					default:game.chat(`Invalid command: ${cmd}`)
				}break;
			case "warp":
				switch(c[1]){
					case "start":save[save.sel].level[c[2]]?warp.start(c[2]):0;break;
					case "end":warp.is?warp.end():0;break;
					case "to":if(save[save.sel].level[c[2]]){warp.start(c[2]);warp.end()};break;
					case "show":warp.show(c[2]?c[2]:2000);break;
				}break;
			case "reloadengine":game.resize();game.scene().render();break;
			case "":case ".":break;
			default:game.chat(`Invalid command: ${cmd}`);break;
		}
	}
    
    //*.new functions ~~new
	server.new = (name,path,push = !0) => {
        let s = {id:rand.hex(16),name:name,path:path};
		ui.load.server(s);
        push ? save.info[s.id] = s:0;return s
    };
	star = (name="star",pos = [0,0,0], radius=1, col = [1,1,1], scene) => {
		let s = Mesh.CreateSphere(name + "_sphere", worldgen.quality, radius, scene);
		s.assign({
			position: new Vector3(pos[0],pos[1],pos[2]),
			light: new PointLight(name + "_light",this.position,scene),
			material: new StandardMaterial(name + "_mat", scene),
		});
		let gl = new GlowLayer(name + "_glow", scene);
		s.light.assign({intensity: 1, range: 100, position: s.position});
		s.material.disableLighting = !0;
		gl.customEmissiveColorSelector = function(mesh, subMesh, mat, result) {
			(mesh.name == name + "_sphere")?result.set(col[0], col[1],col[2], 1):result.set(0, 0, 0, 0);
		}
		return s;
	};
	ship.new = (type,push = !0,enemy = !1) => {
		let s = {type: type};
		for(let i in ship.generic[type]){
            if(i != "cost" && i != "level" && i != "model"){s[i] = ship.generic[type][i]}
		}
        push?ship.fleet.push(s):!1;
        return s
	};
	planet = (name = "planet",pos = [0,0,0], radius = 1, col = [1,1,1], taken = !1, enemies = [], rewards = {},scene) => {
		let q = Mesh.CreateSphere(name,worldgen.quality,radius,scene);
		q.assign({
			taken:taken,
			radius:radius,
			rewards:rewards,
			enemies:[],
			position: new Vector3(pos[0],pos[1],pos[2])
		});
		for(let i in enemies){q.enemies[i] = ship.new(enemies[i],!1,!0)}
		let m = q.material = new StandardMaterial(name + ".mat", scene);
		//m.Fragment_Before_FragColor(`color = vec4(vec3(1.0,1.0,1.0)*(length(color.xyz)),1.0);`);
		m.assign({
			emissiveTexture: new NoiseProceduralTexture(name + ".texture", worldgen.quality, scene),
			diffuseColor: new Color3(col[0],col[1],col[2]),
			emissiveColor: new Color3(col[0]/2,col[1]/2,col[2]/2),
		});
		m.emissiveTexture.assign({animationSpeedFactor: 0,octaves :5, persistence:0.8});
		return q;
	};
    save.new = (name,date=$d.now(),version=game.version,data,push) => {//also worldgen
        let s = {id:"_"+rand.hex(16),name:name,date:date,version:version,level:[]};
        if(data){s.data = data}else{
            //WorldGen
            for(let i=0;i<level.num;i++){
				let r = rand.int(75,125);
				let l = s.level[i] = new Scene(game);
				l.addCamera(player);
				l.activeCamera = player;
				l.assign({
					name: level.names[i],
					star: star(level.names[i],[0,0,0],r,[rand.real,rand.real,rand.real],l),
					planets: [],
					difficulty: worldgen.difficulty,
					planetNum: rand.int(0,worldgen.planets),
				});
				l.star.radius = r;
				let n = rand.bool?greek:range(1,l.planetNum+1);
				let pre = rand.bool;
				let size = rand.int(0,worldgen.size);				
				for(let j=0;j<l.planetNum;j++){
					let p = l.planets[j] = planet(
						pre?n[j]+" "+l.name:l.name+" "+n[j],[rand.bool?rand.int(r/2,size):rand.int(-size,-r/2),rand.bool?rand.real:-rand.real,rand.bool?rand.int(r/2,size):rand.int(-size,-r/2)],
						rand.int(10,25),[rand.real,rand.real,rand.real],!1,[gen.enemies(4*j*worldgen.difficulty)],
						gen.items(1000*j*(2-worldgen.difficulty)),l
					);
				}
			}
            ui.load.save(s);
			save.sel = s.id;
			game.lvl = 0;
        }
        ! push? save[s.id] = s:0;return s
    };
	
		
    //Event Detection
    onmousedown = m =>{mouse.pressed = !0};
    onmouseup = m =>{mouse.pressed = !1};
    onkeydown = k =>{key.pressed = !0};
    onkeyup = k =>{key.pressed = !1};
	oncontextmenu =e=>{$(".cm").not(":last").remove()};
	onclick=e=>{$(".cm").remove()};
	
	//Event Listeners (UI transitions, creating saves, etc.) ~~els
	$("#main .sp").click(()=>{
        $("#load").empty().append(ui.load.back,ui.load.new);
        for(let i in save.info){$("#load").append(ui.load.save(save.info[i]))}
        $("#main").hide();$("#load").show()
    });
	$("#main .mp").click(()=>{if(game.mpDisabled){alert("Muliplayer is disabled in this version")}else if(!system.online){alert("You can't play multiplayer without internet")}else{$("#main").hide();$("#load").show()}});
    $("#main .options").click(()=>{ui.LastScene="#main";$("#settings").show()});
	$("#save i").on("click",()=>{$("#load").show();$("#save").hide()});
	$("#server i").on("click",()=>{$("#load").show();$("#server").hide()});
	$("#save .new").on("click",()=>{
		let v = $("#save .name").val()
		if(v){
                save.new(v);
				for(let i in save.info){
					if(save.info[i].id == v){save.sel = i}
					else {$(`[id="save_${save.info[i].id}"]`).removeClass("selected")}	
				}
				$("#save").hide();$("#tips").show()
		} else {alert("You must enter a save name.")}
	});
	$("#server .new").on("click",()=>{
		server.new(Object.assign($("#server form").obj(),{version:game.version}));
		$("#server").hide();$("#load").show()
	});
	$("#tips button").click(()=>{view="map";$("#tips").hide();$(game.canvas).show();game.resize()});
	$("#esc .resume").click(()=>{$("#esc").hide();game.isPaused = !1});
	$("#esc .options").click(()=>{ui.LastScene="#esc";$("#esc").hide();$("#settings").show()});
    $("#esc .quit").click(()=>{$("#esc,#e,canvas.game").hide();$("#main").show()});
	$("#nav .inv").click(()=>{$("#e ul").hide();$("#e .inv").show()});
	$("#nav .map").click(()=>{$("#e ul").hide();$("#e .map").show()});
	$("#nav .yrd").click(()=>{$("#e ul").hide();$("#e .yrd").show()});
	$("#nav .lab").click(()=>{$("#e ul").hide();$("#e .lab").show()});
    $("#settings button").click(e=>{e.preventDefault();ls.settings = settings = $("#settings").obj();$("#settings").hide();$(ui.LastScene).show()});
    for(let i in ship.generic){$("ul.yrd").append(ui.ship(i))}
	for(let i in tech){$("ul.lab").append(ui.lab(i))}
	$("#map i").on("click",()=>{game.isPaused=!0;$("#map").hide()});
	$("#map button").on("click",()=>{view = "battle";game.isPaused = !0;$("#map").hide();$("#battle").show()});
	$("#report i").on("click",()=>{ship.battle.won=null;game.isPaused=!0;$("#report").hide()});
	$("#report button").on("click",()=>{ship.battle.won=null;game.isPaused=!0;$("#report").hide()});
	$("#battle button").on("click",()=>{
		ship.battle.active = !1;ship.battle.won=!1;game.isPaused=!1;view = "map";
		$("#battle").hide();$("#report").show()
	});
	const showMap = () => {$("#e ul.map p").hide();$("canvas.map").show()};
	$("#cli").on("keydown",e=>{
		let c = game.cli;
		c.i = $("#cli").val();
		switch(e.key){
			case "ArrowUp":(c.line-1 > -1)?c.line--:0;$("#cli").val(c.prev[c.line]);break;
			case "ArrowDown":(c.line+1 <= c.prev.length)?c.line++:0;$("#cli").val(c.prev[c.line]);break;
			case "Enter":
				(c.i.slice(0,1) == "/")?acs(c.i.slice(1)):game.mp?server.chat(c.i):game.chat(c.i);
				c.line = c.prev.length;c.prev[c.line] = `${c.i}`;$("#cli").val("");
				break;
			}
	});
	$(game.canvas).click(e=>{game.isPaused ? "lol" : game.canvas.requestPointerLock();});
	$(game.canvas).on("keydown",e=>{
		switch(e.key){
			case "Escape":$("#esc").toggle();game.isPaused = !game.isPaused;break;
			case "e":$("#e").toggle();game.isPaused = !game.isPaused;break;
			case "d":player.move(player.speed,0,0);break;
			case "w":player.move(0,0,player.speed);break;
			case " ":player.move(0,player.speed,0);break;
			case "a":player.move(-player.speed,0,0);break;
			case "s":player.move(0,0,-player.speed);break;
			case "F3":case "D":$("#debug").toggle();break;
	   		case "/":$("#cli").toggle();break;
		}
	});
	$("#e").on("keydown",e=>{
		switch(e.key){
			case "e":$("#e").toggle();game.isPaused = !game.isPaused;break;
			case "1":$("#e ul").hide();$("ul.inv").show();break;
			case "2":$("#e ul").hide();$("ul.map").show();break;
			case "3":$("#e ul").hide();$("ul.yrd").show();break;
			case "4":$("#e ul").hide();$("ul.lab").show();break;
		}
	});
	//server side (saving saves, loading saves, verifying and cnnecting to servers) ~ss
	if(game.phpEnabled){
		player.assign({
			_getsaves: () => {
				console.groupCollapsed("Imported Saves");
				$.get(`https://api.blankstorm.drvortex.dev/getsaves.php?uuid=${player.id}`,d=>{
					let s = JSON.parse(d);
					save.new(s.name,s.date,s.version,s.data);
				});
				console.groupEnd();
			},
			_setsaves: (saves) => {
				$.post(`https://api.blankstorm.drvortex.dev/setsaves.php`,saves);
			},
			get saves(){return this._getsaves()},
			set saves(saves){this._setsaves(saves)}
		});
	}
	const loop = () => {// the loop ~~loop
		if(!game.isPaused && save.sel && game.lvl > -1){
			game.scene = save[save.sel].level[game.lvl];
			game.frames += 1;
			item.multiplyer = 1+(1-game.difficulty);
			ship.crit = {chance: 30+tech.missle.level,damage: 50+tech.missle.level*5};
			ship.multiplyer = {
				damage: 1+(1-game.difficulty)+tech.laser.level*0.1,
				health: 1+(1-game.difficulty)+tech.armor.level*0.15
			};
			system.ram = {
				used: performance.memory.usedJSHeapSize,
				allocated: performance.memory.totalJSHeapSize,
				max: performance.memory.jsHeapSizeLimit
			};
			if(!ship.battle.active){
				for(let i = 0;i < ship.fleet.length;i++){
					if(ship.fleet[i].health <= ship.generic[ship.fleet[i].type].health){
						ship.fleet[i].health += ship.generic[ship.fleet[i].type].health/(1000-tech.regen.level*10);
					}
				}
			}
			for(let i in tech){
				(tech[i].level < numeral.length && tech[i].level > -1)? 
				$(`ul.lab li.${i} p`).html(`${i} ${numeral[tech[i].level]}`):
				$(`ul.lab li.${i} p`).html(`${i} ${minimize(tech[i].level)}`);
					let u = !0;
					for(var r in tech[i].requires){if(tech[r].level < tech[i].requires[r]){u = !1}}
					u?$(`ul.lab .${i} i`).hide():$(`ul.lab .${i} i`).show();
			}
			game.isPaused ? player.detachControl(game.canvas, !1) : player.attachControl(game.canvas, !1);
			game.isPaused ? $("#debug").hide():0;
			settings.devMode ? $("#main .version").show() : $("#main .version").hide();
			(player.rotation.y > 3.14) ? player.rotation.y -= 6.28:0;
			(player.rotation.y < -3.14) ? player.rotation.y += 6.28:0;
			$("#debug").is(":visible") ? $("#chat").hide() : $("#chat").show();
			$("#debug .game").html(`
				${game.build("/ ")} ${game.mods.length?`[${game.mods.join(",")}]`:`(vanilla)`}<br>
				${settings.fps} FPS | ${game.frames}f | ${round(time*100)/100000}s
			`);
			$("#debug .player").html(`
				P: ${round(player.position.x*10)/10}, ${round(player.position.y*10)/10}, ${round(player.position.z*10)/10}<br>
				R: ${round(player.rotation.x*100)/100}, ${round(player.rotation.y*100)/100}
			`);
			$("#debug .system").html(`
				${system.platform} ${system.os} ${system.osVersion}<br>
				${system.gpu}<br>
				RAM: ${round(system.ram.used/1000000)}MB/${round(system.ram.max/1000000)}MB | Allocated: ${round(system.ram.allocated/1000000)}MB<br>
				${system.cpu} CPU Cores<br>
			`);
			save[save.sel].level[game.lvl].render();
		} else if (Number(game.lvl) == NaN){
			console.warn("Invalid game.lvl value");
		}
		$("form").each(function(){
			window[this.name] = $(this).obj();
			$(this).find("input").each(function(){
				let v = (this.type == "range")?` (${this.value})`:"";
				$(`label[class="${this.name}"]`).text($(this).attr("label") + v);
			});
		});
		setTimeout(loop,1000/settings.fps);
	}
	setTimeout(loop,1000/settings.fps);
	</script>
</html>